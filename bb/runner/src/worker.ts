export default `IyEvdXNyL2Jpbi9lbnYgbm9kZQp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fY29tbW9uSlMgPSAoY2IsIG1vZCkgPT4gZnVuY3Rpb24gX19yZXF1aXJlKCkgewogIHJldHVybiBtb2QgfHwgKDAsIGNiW19fZ2V0T3duUHJvcE5hbWVzKGNiKVswXV0pKChtb2QgPSB7IGV4cG9ydHM6IHt9IH0pLmV4cG9ydHMsIG1vZCksIG1vZC5leHBvcnRzOwp9OwoKLy8gYnVpbGQvdmVyYWNlVGVtcC5janMKdmFyIHJlcXVpcmVfdmVyYWNlVGVtcCA9IF9fY29tbW9uSlMoewogICJidWlsZC92ZXJhY2VUZW1wLmNqcyIoZXhwb3J0czIsIG1vZHVsZTIpIHsKICAgIHZhciBfX2NyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgICB2YXIgX19kZWZQcm9wID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwogICAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzMiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzOwogICAgdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICAgIHZhciBfX2hhc093blByb3AgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgdmFyIF9fY29tbW9uSlMyID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICAgICAgcmV0dXJuIG1vZCB8fCAoMCwgY2JbX19nZXRPd25Qcm9wTmFtZXMyKGNiKVswXV0pKChtb2QgPSB7IGV4cG9ydHM6IHt9IH0pLmV4cG9ydHMsIG1vZCksIG1vZC5leHBvcnRzOwogICAgfTsKICAgIHZhciBfX2V4cG9ydCA9ICh0YXJnZXQsIGFsbCkgPT4gewogICAgICBmb3IgKHZhciBuYW1lIGluIGFsbCkKICAgICAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwogICAgfTsKICAgIHZhciBfX2NvcHlQcm9wcyA9ICh0bywgZnJvbSwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgICAgIGlmIChmcm9tICYmIHR5cGVvZiBmcm9tID09PSAib2JqZWN0IiB8fCB0eXBlb2YgZnJvbSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGZvciAobGV0IGtleSBvZiBfX2dldE93blByb3BOYW1lczIoZnJvbSkpCiAgICAgICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvLCBrZXkpICYmIGtleSAhPT0gZXhjZXB0KQogICAgICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRvOwogICAgfTsKICAgIHZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgICAgIC8vIElmIHRoZSBpbXBvcnRlciBpcyBpbiBub2RlIGNvbXBhdGliaWxpdHkgbW9kZSBvciB0aGlzIGlzIG5vdCBhbiBFU00KICAgICAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAgICAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogICAgICAvLyAiZGVmYXVsdCIgdG8gdGhlIENvbW1vbkpTICJtb2R1bGUuZXhwb3J0cyIgZm9yIG5vZGUgY29tcGF0aWJpbGl0eS4KICAgICAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogICAgICBtb2QKICAgICkpOwogICAgdmFyIF9fdG9Db21tb25KUyA9IChtb2QpID0+IF9fY29weVByb3BzKF9fZGVmUHJvcCh7fSwgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pLCBtb2QpOwogICAgdmFyIHJlcXVpcmVfdW5pdmVyc2FsaWZ5ID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL3VuaXZlcnNhbGlmeS9pbmRleC5qcyIoZXhwb3J0czMpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgZXhwb3J0czMuZnJvbUNhbGxiYWNrID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHJldHVybiBPYmplY3QuZGVmaW5lUHJvcGVydHkoZnVuY3Rpb24oLi4uYXJncykgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbYXJncy5sZW5ndGggLSAxXSA9PT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICBmbi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICAgIGZuLmNhbGwoCiAgICAgICAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgICAgICAgIC4uLmFyZ3MsCiAgICAgICAgICAgICAgICAgIChlcnIsIHJlcykgPT4gZXJyICE9IG51bGwgPyByZWplY3QoZXJyKSA6IHJlc29sdmUocmVzKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgIm5hbWUiLCB7IHZhbHVlOiBmbi5uYW1lIH0pOwogICAgICAgIH07CiAgICAgICAgZXhwb3J0czMuZnJvbVByb21pc2UgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgcmV0dXJuIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGNiID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICBpZiAodHlwZW9mIGNiICE9PSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3Muc2xpY2UoMCwgLTEpKS50aGVuKChyKSA9PiBjYihudWxsLCByKSwgY2IpOwogICAgICAgICAgfSwgIm5hbWUiLCB7IHZhbHVlOiBmbi5uYW1lIH0pOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfcG9seWZpbGxzID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2dyYWNlZnVsLWZzL3BvbHlmaWxscy5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgdmFyIGNvbnN0YW50cyA9IHJlcXVpcmUoImNvbnN0YW50cyIpOwogICAgICAgIHZhciBvcmlnQ3dkID0gcHJvY2Vzcy5jd2Q7CiAgICAgICAgdmFyIGN3ZCA9IG51bGw7CiAgICAgICAgdmFyIHBsYXRmb3JtID0gcHJvY2Vzcy5lbnYuR1JBQ0VGVUxfRlNfUExBVEZPUk0gfHwgcHJvY2Vzcy5wbGF0Zm9ybTsKICAgICAgICBwcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCFjd2QpCiAgICAgICAgICAgIGN3ZCA9IG9yaWdDd2QuY2FsbChwcm9jZXNzKTsKICAgICAgICAgIHJldHVybiBjd2Q7CiAgICAgICAgfTsKICAgICAgICB0cnkgewogICAgICAgICAgcHJvY2Vzcy5jd2QoKTsKICAgICAgICB9IGNhdGNoIChlcikgewogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHByb2Nlc3MuY2hkaXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGNoZGlyID0gcHJvY2Vzcy5jaGRpcjsKICAgICAgICAgIHByb2Nlc3MuY2hkaXIgPSBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgIGN3ZCA9IG51bGw7CiAgICAgICAgICAgIGNoZGlyLmNhbGwocHJvY2VzcywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKE9iamVjdC5zZXRQcm90b3R5cGVPZikKICAgICAgICAgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHByb2Nlc3MuY2hkaXIsIGNoZGlyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNoZGlyOwogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSBwYXRjaDsKICAgICAgICBmdW5jdGlvbiBwYXRjaChmczIpIHsKICAgICAgICAgIGlmIChjb25zdGFudHMuaGFzT3duUHJvcGVydHkoIk9fU1lNTElOSyIpICYmIHByb2Nlc3MudmVyc2lvbi5tYXRjaCgvXnYwXC42XC5bMC0yXXxedjBcLjVcLi8pKSB7CiAgICAgICAgICAgIHBhdGNoTGNobW9kKGZzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWZzMi5sdXRpbWVzKSB7CiAgICAgICAgICAgIHBhdGNoTHV0aW1lcyhmczIpOwogICAgICAgICAgfQogICAgICAgICAgZnMyLmNob3duID0gY2hvd25GaXgoZnMyLmNob3duKTsKICAgICAgICAgIGZzMi5mY2hvd24gPSBjaG93bkZpeChmczIuZmNob3duKTsKICAgICAgICAgIGZzMi5sY2hvd24gPSBjaG93bkZpeChmczIubGNob3duKTsKICAgICAgICAgIGZzMi5jaG1vZCA9IGNobW9kRml4KGZzMi5jaG1vZCk7CiAgICAgICAgICBmczIuZmNobW9kID0gY2htb2RGaXgoZnMyLmZjaG1vZCk7CiAgICAgICAgICBmczIubGNobW9kID0gY2htb2RGaXgoZnMyLmxjaG1vZCk7CiAgICAgICAgICBmczIuY2hvd25TeW5jID0gY2hvd25GaXhTeW5jKGZzMi5jaG93blN5bmMpOwogICAgICAgICAgZnMyLmZjaG93blN5bmMgPSBjaG93bkZpeFN5bmMoZnMyLmZjaG93blN5bmMpOwogICAgICAgICAgZnMyLmxjaG93blN5bmMgPSBjaG93bkZpeFN5bmMoZnMyLmxjaG93blN5bmMpOwogICAgICAgICAgZnMyLmNobW9kU3luYyA9IGNobW9kRml4U3luYyhmczIuY2htb2RTeW5jKTsKICAgICAgICAgIGZzMi5mY2htb2RTeW5jID0gY2htb2RGaXhTeW5jKGZzMi5mY2htb2RTeW5jKTsKICAgICAgICAgIGZzMi5sY2htb2RTeW5jID0gY2htb2RGaXhTeW5jKGZzMi5sY2htb2RTeW5jKTsKICAgICAgICAgIGZzMi5zdGF0ID0gc3RhdEZpeChmczIuc3RhdCk7CiAgICAgICAgICBmczIuZnN0YXQgPSBzdGF0Rml4KGZzMi5mc3RhdCk7CiAgICAgICAgICBmczIubHN0YXQgPSBzdGF0Rml4KGZzMi5sc3RhdCk7CiAgICAgICAgICBmczIuc3RhdFN5bmMgPSBzdGF0Rml4U3luYyhmczIuc3RhdFN5bmMpOwogICAgICAgICAgZnMyLmZzdGF0U3luYyA9IHN0YXRGaXhTeW5jKGZzMi5mc3RhdFN5bmMpOwogICAgICAgICAgZnMyLmxzdGF0U3luYyA9IHN0YXRGaXhTeW5jKGZzMi5sc3RhdFN5bmMpOwogICAgICAgICAgaWYgKGZzMi5jaG1vZCAmJiAhZnMyLmxjaG1vZCkgewogICAgICAgICAgICBmczIubGNobW9kID0gZnVuY3Rpb24ocGF0aDIsIG1vZGUsIGNiKSB7CiAgICAgICAgICAgICAgaWYgKGNiKQogICAgICAgICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZzMi5sY2htb2RTeW5jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnMyLmNob3duICYmICFmczIubGNob3duKSB7CiAgICAgICAgICAgIGZzMi5sY2hvd24gPSBmdW5jdGlvbihwYXRoMiwgdWlkLCBnaWQsIGNiKSB7CiAgICAgICAgICAgICAgaWYgKGNiKQogICAgICAgICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZzMi5sY2hvd25TeW5jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGxhdGZvcm0gPT09ICJ3aW4zMiIpIHsKICAgICAgICAgICAgZnMyLnJlbmFtZSA9IHR5cGVvZiBmczIucmVuYW1lICE9PSAiZnVuY3Rpb24iID8gZnMyLnJlbmFtZSA6IGZ1bmN0aW9uKGZzJHJlbmFtZSkgewogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlbmFtZShmcm9tLCB0bywgY2IpIHsKICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICB2YXIgYmFja29mZiA9IDA7CiAgICAgICAgICAgICAgICBmcyRyZW5hbWUoZnJvbSwgdG8sIGZ1bmN0aW9uIENCKGVyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlciAmJiAoZXIuY29kZSA9PT0gIkVBQ0NFUyIgfHwgZXIuY29kZSA9PT0gIkVQRVJNIiB8fCBlci5jb2RlID09PSAiRUJVU1kiKSAmJiBEYXRlLm5vdygpIC0gc3RhcnQgPCA2ZTQpIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgZnMyLnN0YXQodG8sIGZ1bmN0aW9uKHN0YXRlciwgc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlciAmJiBzdGF0ZXIuY29kZSA9PT0gIkVOT0VOVCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgZnMkcmVuYW1lKGZyb20sIHRvLCBDQik7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICBjYihlcik7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LCBiYWNrb2ZmKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFja29mZiA8IDEwMCkKICAgICAgICAgICAgICAgICAgICAgIGJhY2tvZmYgKz0gMTA7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgICBjYihlcik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKE9iamVjdC5zZXRQcm90b3R5cGVPZikKICAgICAgICAgICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihyZW5hbWUsIGZzJHJlbmFtZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbmFtZTsKICAgICAgICAgICAgfShmczIucmVuYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGZzMi5yZWFkID0gdHlwZW9mIGZzMi5yZWFkICE9PSAiZnVuY3Rpb24iID8gZnMyLnJlYWQgOiBmdW5jdGlvbihmcyRyZWFkKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlYWQoZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uLCBjYWxsYmFja18pIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrXyAmJiB0eXBlb2YgY2FsbGJhY2tfID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgZWFnQ291bnRlciA9IDA7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKGVyLCBfLCBfXykgewogICAgICAgICAgICAgICAgICBpZiAoZXIgJiYgZXIuY29kZSA9PT0gIkVBR0FJTiIgJiYgZWFnQ291bnRlciA8IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgZWFnQ291bnRlcisrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmcyRyZWFkLmNhbGwoZnMyLCBmZCwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24sIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYWxsYmFja18uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmcyRyZWFkLmNhbGwoZnMyLCBmZCwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24sIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoT2JqZWN0LnNldFByb3RvdHlwZU9mKQogICAgICAgICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihyZWFkLCBmcyRyZWFkKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWQ7CiAgICAgICAgICB9KGZzMi5yZWFkKTsKICAgICAgICAgIGZzMi5yZWFkU3luYyA9IHR5cGVvZiBmczIucmVhZFN5bmMgIT09ICJmdW5jdGlvbiIgPyBmczIucmVhZFN5bmMgOiBmdW5jdGlvbihmcyRyZWFkU3luYykgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZmQsIGJ1ZmZlciwgb2Zmc2V0LCBsZW5ndGgsIHBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgdmFyIGVhZ0NvdW50ZXIgPSAwOwogICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZnMkcmVhZFN5bmMuY2FsbChmczIsIGZkLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcikgewogICAgICAgICAgICAgICAgICBpZiAoZXIuY29kZSA9PT0gIkVBR0FJTiIgJiYgZWFnQ291bnRlciA8IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgZWFnQ291bnRlcisrOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHRocm93IGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0oZnMyLnJlYWRTeW5jKTsKICAgICAgICAgIGZ1bmN0aW9uIHBhdGNoTGNobW9kKGZzMykgewogICAgICAgICAgICBmczMubGNobW9kID0gZnVuY3Rpb24ocGF0aDIsIG1vZGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgZnMzLm9wZW4oCiAgICAgICAgICAgICAgICBwYXRoMiwKICAgICAgICAgICAgICAgIGNvbnN0YW50cy5PX1dST05MWSB8IGNvbnN0YW50cy5PX1NZTUxJTkssCiAgICAgICAgICAgICAgICBtb2RlLAogICAgICAgICAgICAgICAgZnVuY3Rpb24oZXJyLCBmZCkgewogICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZnMzLmZjaG1vZChmZCwgbW9kZSwgZnVuY3Rpb24oZXJyMikgewogICAgICAgICAgICAgICAgICAgIGZzMy5jbG9zZShmZCwgZnVuY3Rpb24oZXJyMjIpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyMiB8fCBlcnIyMik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZzMy5sY2htb2RTeW5jID0gZnVuY3Rpb24ocGF0aDIsIG1vZGUpIHsKICAgICAgICAgICAgICB2YXIgZmQgPSBmczMub3BlblN5bmMocGF0aDIsIGNvbnN0YW50cy5PX1dST05MWSB8IGNvbnN0YW50cy5PX1NZTUxJTkssIG1vZGUpOwogICAgICAgICAgICAgIHZhciB0aHJldyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHJldDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0ID0gZnMzLmZjaG1vZFN5bmMoZmQsIG1vZGUpOwogICAgICAgICAgICAgICAgdGhyZXcgPSBmYWxzZTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaWYgKHRocmV3KSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMzLmNsb3NlU3luYyhmZCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVyKSB7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZzMy5jbG9zZVN5bmMoZmQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcGF0Y2hMdXRpbWVzKGZzMykgewogICAgICAgICAgICBpZiAoY29uc3RhbnRzLmhhc093blByb3BlcnR5KCJPX1NZTUxJTksiKSAmJiBmczMuZnV0aW1lcykgewogICAgICAgICAgICAgIGZzMy5sdXRpbWVzID0gZnVuY3Rpb24ocGF0aDIsIGF0LCBtdCwgY2IpIHsKICAgICAgICAgICAgICAgIGZzMy5vcGVuKHBhdGgyLCBjb25zdGFudHMuT19TWU1MSU5LLCBmdW5jdGlvbihlciwgZmQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNiKQogICAgICAgICAgICAgICAgICAgICAgY2IoZXIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmczMuZnV0aW1lcyhmZCwgYXQsIG10LCBmdW5jdGlvbihlcjIpIHsKICAgICAgICAgICAgICAgICAgICBmczMuY2xvc2UoZmQsIGZ1bmN0aW9uKGVyMjIpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXIyIHx8IGVyMjIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZnMzLmx1dGltZXNTeW5jID0gZnVuY3Rpb24ocGF0aDIsIGF0LCBtdCkgewogICAgICAgICAgICAgICAgdmFyIGZkID0gZnMzLm9wZW5TeW5jKHBhdGgyLCBjb25zdGFudHMuT19TWU1MSU5LKTsKICAgICAgICAgICAgICAgIHZhciByZXQ7CiAgICAgICAgICAgICAgICB2YXIgdGhyZXcgPSB0cnVlOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0ID0gZnMzLmZ1dGltZXNTeW5jKGZkLCBhdCwgbXQpOwogICAgICAgICAgICAgICAgICB0aHJldyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHRocmV3KSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGZzMy5jbG9zZVN5bmMoZmQpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVyKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZzMy5jbG9zZVN5bmMoZmQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZnMzLmZ1dGltZXMpIHsKICAgICAgICAgICAgICBmczMubHV0aW1lcyA9IGZ1bmN0aW9uKF9hLCBfYiwgX2MsIGNiKSB7CiAgICAgICAgICAgICAgICBpZiAoY2IpCiAgICAgICAgICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2IpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZnMzLmx1dGltZXNTeW5jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2htb2RGaXgob3JpZykgewogICAgICAgICAgICBpZiAoIW9yaWcpCiAgICAgICAgICAgICAgcmV0dXJuIG9yaWc7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0YXJnZXQsIG1vZGUsIGNiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9yaWcuY2FsbChmczIsIHRhcmdldCwgbW9kZSwgZnVuY3Rpb24oZXIpIHsKICAgICAgICAgICAgICAgIGlmIChjaG93bkVyT2soZXIpKQogICAgICAgICAgICAgICAgICBlciA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoY2IpCiAgICAgICAgICAgICAgICAgIGNiLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjaG1vZEZpeFN5bmMob3JpZykgewogICAgICAgICAgICBpZiAoIW9yaWcpCiAgICAgICAgICAgICAgcmV0dXJuIG9yaWc7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0YXJnZXQsIG1vZGUpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9yaWcuY2FsbChmczIsIHRhcmdldCwgbW9kZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXIpIHsKICAgICAgICAgICAgICAgIGlmICghY2hvd25Fck9rKGVyKSkKICAgICAgICAgICAgICAgICAgdGhyb3cgZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hvd25GaXgob3JpZykgewogICAgICAgICAgICBpZiAoIW9yaWcpCiAgICAgICAgICAgICAgcmV0dXJuIG9yaWc7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0YXJnZXQsIHVpZCwgZ2lkLCBjYikgewogICAgICAgICAgICAgIHJldHVybiBvcmlnLmNhbGwoZnMyLCB0YXJnZXQsIHVpZCwgZ2lkLCBmdW5jdGlvbihlcikgewogICAgICAgICAgICAgICAgaWYgKGNob3duRXJPayhlcikpCiAgICAgICAgICAgICAgICAgIGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChjYikKICAgICAgICAgICAgICAgICAgY2IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNob3duRml4U3luYyhvcmlnKSB7CiAgICAgICAgICAgIGlmICghb3JpZykKICAgICAgICAgICAgICByZXR1cm4gb3JpZzsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRhcmdldCwgdWlkLCBnaWQpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9yaWcuY2FsbChmczIsIHRhcmdldCwgdWlkLCBnaWQpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWNob3duRXJPayhlcikpCiAgICAgICAgICAgICAgICAgIHRocm93IGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0YXRGaXgob3JpZykgewogICAgICAgICAgICBpZiAoIW9yaWcpCiAgICAgICAgICAgICAgcmV0dXJuIG9yaWc7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMsIGNiKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBjYiA9IG9wdGlvbnM7CiAgICAgICAgICAgICAgICBvcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbGJhY2soZXIsIHN0YXRzKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRzLnVpZCA8IDApCiAgICAgICAgICAgICAgICAgICAgc3RhdHMudWlkICs9IDQyOTQ5NjcyOTY7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0cy5naWQgPCAwKQogICAgICAgICAgICAgICAgICAgIHN0YXRzLmdpZCArPSA0Mjk0OTY3Mjk2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNiKQogICAgICAgICAgICAgICAgICBjYi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucyA/IG9yaWcuY2FsbChmczIsIHRhcmdldCwgb3B0aW9ucywgY2FsbGJhY2spIDogb3JpZy5jYWxsKGZzMiwgdGFyZ2V0LCBjYWxsYmFjayk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdGF0Rml4U3luYyhvcmlnKSB7CiAgICAgICAgICAgIGlmICghb3JpZykKICAgICAgICAgICAgICByZXR1cm4gb3JpZzsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRhcmdldCwgb3B0aW9ucykgewogICAgICAgICAgICAgIHZhciBzdGF0cyA9IG9wdGlvbnMgPyBvcmlnLmNhbGwoZnMyLCB0YXJnZXQsIG9wdGlvbnMpIDogb3JpZy5jYWxsKGZzMiwgdGFyZ2V0KTsKICAgICAgICAgICAgICBpZiAoc3RhdHMpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0cy51aWQgPCAwKQogICAgICAgICAgICAgICAgICBzdGF0cy51aWQgKz0gNDI5NDk2NzI5NjsKICAgICAgICAgICAgICAgIGlmIChzdGF0cy5naWQgPCAwKQogICAgICAgICAgICAgICAgICBzdGF0cy5naWQgKz0gNDI5NDk2NzI5NjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHN0YXRzOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY2hvd25Fck9rKGVyKSB7CiAgICAgICAgICAgIGlmICghZXIpCiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGlmIChlci5jb2RlID09PSAiRU5PU1lTIikKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgdmFyIG5vbnJvb3QgPSAhcHJvY2Vzcy5nZXR1aWQgfHwgcHJvY2Vzcy5nZXR1aWQoKSAhPT0gMDsKICAgICAgICAgICAgaWYgKG5vbnJvb3QpIHsKICAgICAgICAgICAgICBpZiAoZXIuY29kZSA9PT0gIkVJTlZBTCIgfHwgZXIuY29kZSA9PT0gIkVQRVJNIikKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfbGVnYWN5X3N0cmVhbXMgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZ3JhY2VmdWwtZnMvbGVnYWN5LXN0cmVhbXMuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgIHZhciBTdHJlYW0gPSByZXF1aXJlKCJzdHJlYW0iKS5TdHJlYW07CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IGxlZ2FjeTsKICAgICAgICBmdW5jdGlvbiBsZWdhY3koZnMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBSZWFkU3RyZWFtLAogICAgICAgICAgICBXcml0ZVN0cmVhbQogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmN0aW9uIFJlYWRTdHJlYW0ocGF0aDIsIG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFJlYWRTdHJlYW0pKQogICAgICAgICAgICAgIHJldHVybiBuZXcgUmVhZFN0cmVhbShwYXRoMiwgb3B0aW9ucyk7CiAgICAgICAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICAgICAgICB2YXIgc2VsZjIgPSB0aGlzOwogICAgICAgICAgICB0aGlzLnBhdGggPSBwYXRoMjsKICAgICAgICAgICAgdGhpcy5mZCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucmVhZGFibGUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmZsYWdzID0gInIiOwogICAgICAgICAgICB0aGlzLm1vZGUgPSA0Mzg7CiAgICAgICAgICAgIHRoaXMuYnVmZmVyU2l6ZSA9IDY0ICogMTAyNDsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob3B0aW9ucyk7CiAgICAgICAgICAgIGZvciAodmFyIGluZGV4ID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaW5kZXhdOwogICAgICAgICAgICAgIHRoaXNba2V5XSA9IG9wdGlvbnNba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5lbmNvZGluZykKICAgICAgICAgICAgICB0aGlzLnNldEVuY29kaW5nKHRoaXMuZW5jb2RpbmcpOwogICAgICAgICAgICBpZiAodGhpcy5zdGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKCJudW1iZXIiICE9PSB0eXBlb2YgdGhpcy5zdGFydCkgewogICAgICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCJzdGFydCBtdXN0IGJlIGEgTnVtYmVyIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0aGlzLmVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuZCA9IEluZmluaXR5OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIm51bWJlciIgIT09IHR5cGVvZiB0aGlzLmVuZCkgewogICAgICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCJlbmQgbXVzdCBiZSBhIE51bWJlciIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5zdGFydCA+IHRoaXMuZW5kKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXJ0IG11c3QgYmUgPD0gZW5kIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMucG9zID0gdGhpcy5zdGFydDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5mZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzZWxmMi5fcmVhZCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmczIub3Blbih0aGlzLnBhdGgsIHRoaXMuZmxhZ3MsIHRoaXMubW9kZSwgZnVuY3Rpb24oZXJyLCBmZCkgewogICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgIHNlbGYyLmVtaXQoImVycm9yIiwgZXJyKTsKICAgICAgICAgICAgICAgIHNlbGYyLnJlYWRhYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNlbGYyLmZkID0gZmQ7CiAgICAgICAgICAgICAgc2VsZjIuZW1pdCgib3BlbiIsIGZkKTsKICAgICAgICAgICAgICBzZWxmMi5fcmVhZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFdyaXRlU3RyZWFtKHBhdGgyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBXcml0ZVN0cmVhbSkpCiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBXcml0ZVN0cmVhbShwYXRoMiwgb3B0aW9ucyk7CiAgICAgICAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICAgICAgICB0aGlzLnBhdGggPSBwYXRoMjsKICAgICAgICAgICAgdGhpcy5mZCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMud3JpdGFibGUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmZsYWdzID0gInciOwogICAgICAgICAgICB0aGlzLmVuY29kaW5nID0gImJpbmFyeSI7CiAgICAgICAgICAgIHRoaXMubW9kZSA9IDQzODsKICAgICAgICAgICAgdGhpcy5ieXRlc1dyaXR0ZW4gPSAwOwogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvcHRpb25zKTsKICAgICAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpbmRleF07CiAgICAgICAgICAgICAgdGhpc1trZXldID0gb3B0aW9uc1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnN0YXJ0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAoIm51bWJlciIgIT09IHR5cGVvZiB0aGlzLnN0YXJ0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoInN0YXJ0IG11c3QgYmUgYSBOdW1iZXIiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMuc3RhcnQgPCAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInN0YXJ0IG11c3QgYmUgPj0gemVybyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLnBvcyA9IHRoaXMuc3RhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idXN5ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3F1ZXVlID0gW107CiAgICAgICAgICAgIGlmICh0aGlzLmZkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhpcy5fb3BlbiA9IGZzMi5vcGVuOwogICAgICAgICAgICAgIHRoaXMuX3F1ZXVlLnB1c2goW3RoaXMuX29wZW4sIHRoaXMucGF0aCwgdGhpcy5mbGFncywgdGhpcy5tb2RlLCB2b2lkIDBdKTsKICAgICAgICAgICAgICB0aGlzLmZsdXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfY2xvbmUgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZ3JhY2VmdWwtZnMvY2xvbmUuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gY2xvbmU7CiAgICAgICAgdmFyIGdldFByb3RvdHlwZU9mID0gT2JqZWN0LmdldFByb3RvdHlwZU9mIHx8IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgcmV0dXJuIG9iai5fX3Byb3RvX187CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICAgIGlmIChvYmogPT09IG51bGwgfHwgdHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpCiAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgICBpZiAob2JqIGluc3RhbmNlb2YgT2JqZWN0KQogICAgICAgICAgICB2YXIgY29weSA9IHsgX19wcm90b19fOiBnZXRQcm90b3R5cGVPZihvYmopIH07CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHZhciBjb3B5ID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmopLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb3B5LCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGNvcHk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX2dyYWNlZnVsX2ZzID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2dyYWNlZnVsLWZzL2dyYWNlZnVsLWZzLmpzIihleHBvcnRzMywgbW9kdWxlMjIpIHsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZSgiZnMiKTsKICAgICAgICB2YXIgcG9seWZpbGxzID0gcmVxdWlyZV9wb2x5ZmlsbHMoKTsKICAgICAgICB2YXIgbGVnYWN5ID0gcmVxdWlyZV9sZWdhY3lfc3RyZWFtcygpOwogICAgICAgIHZhciBjbG9uZSA9IHJlcXVpcmVfY2xvbmUoKTsKICAgICAgICB2YXIgdXRpbDIgPSByZXF1aXJlKCJ1dGlsIik7CiAgICAgICAgdmFyIGdyYWNlZnVsUXVldWU7CiAgICAgICAgdmFyIHByZXZpb3VzU3ltYm9sOwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuZm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBncmFjZWZ1bFF1ZXVlID0gU3ltYm9sLmZvcigiZ3JhY2VmdWwtZnMucXVldWUiKTsKICAgICAgICAgIHByZXZpb3VzU3ltYm9sID0gU3ltYm9sLmZvcigiZ3JhY2VmdWwtZnMucHJldmlvdXMiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ3JhY2VmdWxRdWV1ZSA9ICJfX19ncmFjZWZ1bC1mcy5xdWV1ZSI7CiAgICAgICAgICBwcmV2aW91c1N5bWJvbCA9ICJfX19ncmFjZWZ1bC1mcy5wcmV2aW91cyI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1Ymxpc2hRdWV1ZShjb250ZXh0LCBxdWV1ZTIpIHsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb250ZXh0LCBncmFjZWZ1bFF1ZXVlLCB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHF1ZXVlMjsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciBkZWJ1ZyA9IG5vb3A7CiAgICAgICAgaWYgKHV0aWwyLmRlYnVnbG9nKQogICAgICAgICAgZGVidWcgPSB1dGlsMi5kZWJ1Z2xvZygiZ2ZzNCIpOwogICAgICAgIGVsc2UgaWYgKC9cYmdmczRcYi9pLnRlc3QocHJvY2Vzcy5lbnYuTk9ERV9ERUJVRyB8fCAiIikpCiAgICAgICAgICBkZWJ1ZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbSA9IHV0aWwyLmZvcm1hdC5hcHBseSh1dGlsMiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgbSA9ICJHRlM0OiAiICsgbS5zcGxpdCgvXG4vKS5qb2luKCJcbkdGUzQ6ICIpOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKG0pOwogICAgICAgICAgfTsKICAgICAgICBpZiAoIWZzMltncmFjZWZ1bFF1ZXVlXSkgewogICAgICAgICAgcXVldWUgPSBnbG9iYWxbZ3JhY2VmdWxRdWV1ZV0gfHwgW107CiAgICAgICAgICBwdWJsaXNoUXVldWUoZnMyLCBxdWV1ZSk7CiAgICAgICAgICBmczIuY2xvc2UgPSBmdW5jdGlvbihmcyRjbG9zZSkgewogICAgICAgICAgICBmdW5jdGlvbiBjbG9zZShmZCwgY2IpIHsKICAgICAgICAgICAgICByZXR1cm4gZnMkY2xvc2UuY2FsbChmczIsIGZkLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICAgICAgICAgIHJlc2V0UXVldWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2IgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICAgIGNiLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNsb3NlLCBwcmV2aW91c1N5bWJvbCwgewogICAgICAgICAgICAgIHZhbHVlOiBmcyRjbG9zZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNsb3NlOwogICAgICAgICAgfShmczIuY2xvc2UpOwogICAgICAgICAgZnMyLmNsb3NlU3luYyA9IGZ1bmN0aW9uKGZzJGNsb3NlU3luYykgewogICAgICAgICAgICBmdW5jdGlvbiBjbG9zZVN5bmMoZmQpIHsKICAgICAgICAgICAgICBmcyRjbG9zZVN5bmMuYXBwbHkoZnMyLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIHJlc2V0UXVldWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY2xvc2VTeW5jLCBwcmV2aW91c1N5bWJvbCwgewogICAgICAgICAgICAgIHZhbHVlOiBmcyRjbG9zZVN5bmMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjbG9zZVN5bmM7CiAgICAgICAgICB9KGZzMi5jbG9zZVN5bmMpOwogICAgICAgICAgaWYgKC9cYmdmczRcYi9pLnRlc3QocHJvY2Vzcy5lbnYuTk9ERV9ERUJVRyB8fCAiIikpIHsKICAgICAgICAgICAgcHJvY2Vzcy5vbigiZXhpdCIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRlYnVnKGZzMltncmFjZWZ1bFF1ZXVlXSk7CiAgICAgICAgICAgICAgcmVxdWlyZSgiYXNzZXJ0IikuZXF1YWwoZnMyW2dyYWNlZnVsUXVldWVdLmxlbmd0aCwgMCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcXVldWU7CiAgICAgICAgaWYgKCFnbG9iYWxbZ3JhY2VmdWxRdWV1ZV0pIHsKICAgICAgICAgIHB1Ymxpc2hRdWV1ZShnbG9iYWwsIGZzMltncmFjZWZ1bFF1ZXVlXSk7CiAgICAgICAgfQogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSBwYXRjaChjbG9uZShmczIpKTsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuVEVTVF9HUkFDRUZVTF9GU19HTE9CQUxfUEFUQ0ggJiYgIWZzMi5fX3BhdGNoZWQpIHsKICAgICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSBwYXRjaChmczIpOwogICAgICAgICAgZnMyLl9fcGF0Y2hlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBhdGNoKGZzMykgewogICAgICAgICAgcG9seWZpbGxzKGZzMyk7CiAgICAgICAgICBmczMuZ3JhY2VmdWxpZnkgPSBwYXRjaDsKICAgICAgICAgIGZzMy5jcmVhdGVSZWFkU3RyZWFtID0gY3JlYXRlUmVhZFN0cmVhbTsKICAgICAgICAgIGZzMy5jcmVhdGVXcml0ZVN0cmVhbSA9IGNyZWF0ZVdyaXRlU3RyZWFtOwogICAgICAgICAgdmFyIGZzJHJlYWRGaWxlID0gZnMzLnJlYWRGaWxlOwogICAgICAgICAgZnMzLnJlYWRGaWxlID0gcmVhZEZpbGU7CiAgICAgICAgICBmdW5jdGlvbiByZWFkRmlsZShwYXRoMiwgb3B0aW9ucywgY2IpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgIGNiID0gb3B0aW9ucywgb3B0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBnbyRyZWFkRmlsZShwYXRoMiwgb3B0aW9ucywgY2IpOwogICAgICAgICAgICBmdW5jdGlvbiBnbyRyZWFkRmlsZShwYXRoMywgb3B0aW9uczIsIGNiMiwgc3RhcnRUaW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZzJHJlYWRGaWxlKHBhdGgzLCBvcHRpb25zMiwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyICYmIChlcnIuY29kZSA9PT0gIkVNRklMRSIgfHwgZXJyLmNvZGUgPT09ICJFTkZJTEUiKSkKICAgICAgICAgICAgICAgICAgZW5xdWV1ZShbZ28kcmVhZEZpbGUsIFtwYXRoMywgb3B0aW9uczIsIGNiMl0sIGVyciwgc3RhcnRUaW1lIHx8IERhdGUubm93KCksIERhdGUubm93KCldKTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNiMiA9PT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgICAgICBjYjIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZzJHdyaXRlRmlsZSA9IGZzMy53cml0ZUZpbGU7CiAgICAgICAgICBmczMud3JpdGVGaWxlID0gd3JpdGVGaWxlOwogICAgICAgICAgZnVuY3Rpb24gd3JpdGVGaWxlKHBhdGgyLCBkYXRhLCBvcHRpb25zLCBjYikgewogICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgY2IgPSBvcHRpb25zLCBvcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGdvJHdyaXRlRmlsZShwYXRoMiwgZGF0YSwgb3B0aW9ucywgY2IpOwogICAgICAgICAgICBmdW5jdGlvbiBnbyR3cml0ZUZpbGUocGF0aDMsIGRhdGEyLCBvcHRpb25zMiwgY2IyLCBzdGFydFRpbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZnMkd3JpdGVGaWxlKHBhdGgzLCBkYXRhMiwgb3B0aW9uczIsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgaWYgKGVyciAmJiAoZXJyLmNvZGUgPT09ICJFTUZJTEUiIHx8IGVyci5jb2RlID09PSAiRU5GSUxFIikpCiAgICAgICAgICAgICAgICAgIGVucXVldWUoW2dvJHdyaXRlRmlsZSwgW3BhdGgzLCBkYXRhMiwgb3B0aW9uczIsIGNiMl0sIGVyciwgc3RhcnRUaW1lIHx8IERhdGUubm93KCksIERhdGUubm93KCldKTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNiMiA9PT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICAgICAgICBjYjIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZzJGFwcGVuZEZpbGUgPSBmczMuYXBwZW5kRmlsZTsKICAgICAgICAgIGlmIChmcyRhcHBlbmRGaWxlKQogICAgICAgICAgICBmczMuYXBwZW5kRmlsZSA9IGFwcGVuZEZpbGU7CiAgICAgICAgICBmdW5jdGlvbiBhcHBlbmRGaWxlKHBhdGgyLCBkYXRhLCBvcHRpb25zLCBjYikgewogICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgY2IgPSBvcHRpb25zLCBvcHRpb25zID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGdvJGFwcGVuZEZpbGUocGF0aDIsIGRhdGEsIG9wdGlvbnMsIGNiKTsKICAgICAgICAgICAgZnVuY3Rpb24gZ28kYXBwZW5kRmlsZShwYXRoMywgZGF0YTIsIG9wdGlvbnMyLCBjYjIsIHN0YXJ0VGltZSkgewogICAgICAgICAgICAgIHJldHVybiBmcyRhcHBlbmRGaWxlKHBhdGgzLCBkYXRhMiwgb3B0aW9uczIsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgaWYgKGVyciAmJiAoZXJyLmNvZGUgPT09ICJFTUZJTEUiIHx8IGVyci5jb2RlID09PSAiRU5GSUxFIikpCiAgICAgICAgICAgICAgICAgIGVucXVldWUoW2dvJGFwcGVuZEZpbGUsIFtwYXRoMywgZGF0YTIsIG9wdGlvbnMyLCBjYjJdLCBlcnIsIHN0YXJ0VGltZSB8fCBEYXRlLm5vdygpLCBEYXRlLm5vdygpXSk7CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYjIgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgY2IyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcyRjb3B5RmlsZSA9IGZzMy5jb3B5RmlsZTsKICAgICAgICAgIGlmIChmcyRjb3B5RmlsZSkKICAgICAgICAgICAgZnMzLmNvcHlGaWxlID0gY29weUZpbGU7CiAgICAgICAgICBmdW5jdGlvbiBjb3B5RmlsZShzcmMsIGRlc3QsIGZsYWdzLCBjYikgewogICAgICAgICAgICBpZiAodHlwZW9mIGZsYWdzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY2IgPSBmbGFnczsKICAgICAgICAgICAgICBmbGFncyA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdvJGNvcHlGaWxlKHNyYywgZGVzdCwgZmxhZ3MsIGNiKTsKICAgICAgICAgICAgZnVuY3Rpb24gZ28kY29weUZpbGUoc3JjMiwgZGVzdDIsIGZsYWdzMiwgY2IyLCBzdGFydFRpbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZnMkY29weUZpbGUoc3JjMiwgZGVzdDIsIGZsYWdzMiwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyICYmIChlcnIuY29kZSA9PT0gIkVNRklMRSIgfHwgZXJyLmNvZGUgPT09ICJFTkZJTEUiKSkKICAgICAgICAgICAgICAgICAgZW5xdWV1ZShbZ28kY29weUZpbGUsIFtzcmMyLCBkZXN0MiwgZmxhZ3MyLCBjYjJdLCBlcnIsIHN0YXJ0VGltZSB8fCBEYXRlLm5vdygpLCBEYXRlLm5vdygpXSk7CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYjIgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgY2IyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcyRyZWFkZGlyID0gZnMzLnJlYWRkaXI7CiAgICAgICAgICBmczMucmVhZGRpciA9IHJlYWRkaXI7CiAgICAgICAgICB2YXIgbm9SZWFkZGlyT3B0aW9uVmVyc2lvbnMgPSAvXnZbMC01XVwuLzsKICAgICAgICAgIGZ1bmN0aW9uIHJlYWRkaXIocGF0aDIsIG9wdGlvbnMsIGNiKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gImZ1bmN0aW9uIikKICAgICAgICAgICAgICBjYiA9IG9wdGlvbnMsIG9wdGlvbnMgPSBudWxsOwogICAgICAgICAgICB2YXIgZ28kcmVhZGRpciA9IG5vUmVhZGRpck9wdGlvblZlcnNpb25zLnRlc3QocHJvY2Vzcy52ZXJzaW9uKSA/IGZ1bmN0aW9uIGdvJHJlYWRkaXIyKHBhdGgzLCBvcHRpb25zMiwgY2IyLCBzdGFydFRpbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZnMkcmVhZGRpcihwYXRoMywgZnMkcmVhZGRpckNhbGxiYWNrKAogICAgICAgICAgICAgICAgcGF0aDMsCiAgICAgICAgICAgICAgICBvcHRpb25zMiwKICAgICAgICAgICAgICAgIGNiMiwKICAgICAgICAgICAgICAgIHN0YXJ0VGltZQogICAgICAgICAgICAgICkpOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gZ28kcmVhZGRpcjIocGF0aDMsIG9wdGlvbnMyLCBjYjIsIHN0YXJ0VGltZSkgewogICAgICAgICAgICAgIHJldHVybiBmcyRyZWFkZGlyKHBhdGgzLCBvcHRpb25zMiwgZnMkcmVhZGRpckNhbGxiYWNrKAogICAgICAgICAgICAgICAgcGF0aDMsCiAgICAgICAgICAgICAgICBvcHRpb25zMiwKICAgICAgICAgICAgICAgIGNiMiwKICAgICAgICAgICAgICAgIHN0YXJ0VGltZQogICAgICAgICAgICAgICkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gZ28kcmVhZGRpcihwYXRoMiwgb3B0aW9ucywgY2IpOwogICAgICAgICAgICBmdW5jdGlvbiBmcyRyZWFkZGlyQ2FsbGJhY2socGF0aDMsIG9wdGlvbnMyLCBjYjIsIHN0YXJ0VGltZSkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihlcnIsIGZpbGVzKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyICYmIChlcnIuY29kZSA9PT0gIkVNRklMRSIgfHwgZXJyLmNvZGUgPT09ICJFTkZJTEUiKSkKICAgICAgICAgICAgICAgICAgZW5xdWV1ZShbCiAgICAgICAgICAgICAgICAgICAgZ28kcmVhZGRpciwKICAgICAgICAgICAgICAgICAgICBbcGF0aDMsIG9wdGlvbnMyLCBjYjJdLAogICAgICAgICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICAgICAgICBzdGFydFRpbWUgfHwgRGF0ZS5ub3coKSwKICAgICAgICAgICAgICAgICAgICBEYXRlLm5vdygpCiAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChmaWxlcyAmJiBmaWxlcy5zb3J0KQogICAgICAgICAgICAgICAgICAgIGZpbGVzLnNvcnQoKTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYjIgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgY2IyLmNhbGwodGhpcywgZXJyLCBmaWxlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb2Nlc3MudmVyc2lvbi5zdWJzdHIoMCwgNCkgPT09ICJ2MC44IikgewogICAgICAgICAgICB2YXIgbGVnU3RyZWFtcyA9IGxlZ2FjeShmczMpOwogICAgICAgICAgICBSZWFkU3RyZWFtID0gbGVnU3RyZWFtcy5SZWFkU3RyZWFtOwogICAgICAgICAgICBXcml0ZVN0cmVhbSA9IGxlZ1N0cmVhbXMuV3JpdGVTdHJlYW07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnMkUmVhZFN0cmVhbSA9IGZzMy5SZWFkU3RyZWFtOwogICAgICAgICAgaWYgKGZzJFJlYWRTdHJlYW0pIHsKICAgICAgICAgICAgUmVhZFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGZzJFJlYWRTdHJlYW0ucHJvdG90eXBlKTsKICAgICAgICAgICAgUmVhZFN0cmVhbS5wcm90b3R5cGUub3BlbiA9IFJlYWRTdHJlYW0kb3BlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcyRXcml0ZVN0cmVhbSA9IGZzMy5Xcml0ZVN0cmVhbTsKICAgICAgICAgIGlmIChmcyRXcml0ZVN0cmVhbSkgewogICAgICAgICAgICBXcml0ZVN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGZzJFdyaXRlU3RyZWFtLnByb3RvdHlwZSk7CiAgICAgICAgICAgIFdyaXRlU3RyZWFtLnByb3RvdHlwZS5vcGVuID0gV3JpdGVTdHJlYW0kb3BlbjsKICAgICAgICAgIH0KICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmczMsICJSZWFkU3RyZWFtIiwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBSZWFkU3RyZWFtOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgIFJlYWRTdHJlYW0gPSB2YWw7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZnMzLCAiV3JpdGVTdHJlYW0iLCB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFdyaXRlU3RyZWFtOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgIFdyaXRlU3RyZWFtID0gdmFsOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIEZpbGVSZWFkU3RyZWFtID0gUmVhZFN0cmVhbTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmczMsICJGaWxlUmVhZFN0cmVhbSIsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gRmlsZVJlYWRTdHJlYW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgRmlsZVJlYWRTdHJlYW0gPSB2YWw7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgRmlsZVdyaXRlU3RyZWFtID0gV3JpdGVTdHJlYW07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZnMzLCAiRmlsZVdyaXRlU3RyZWFtIiwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBGaWxlV3JpdGVTdHJlYW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgRmlsZVdyaXRlU3RyZWFtID0gdmFsOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgZnVuY3Rpb24gUmVhZFN0cmVhbShwYXRoMiwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIFJlYWRTdHJlYW0pCiAgICAgICAgICAgICAgcmV0dXJuIGZzJFJlYWRTdHJlYW0uYXBwbHkodGhpcywgYXJndW1lbnRzKSwgdGhpczsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIHJldHVybiBSZWFkU3RyZWFtLmFwcGx5KE9iamVjdC5jcmVhdGUoUmVhZFN0cmVhbS5wcm90b3R5cGUpLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVhZFN0cmVhbSRvcGVuKCkgewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgIG9wZW4odGhhdC5wYXRoLCB0aGF0LmZsYWdzLCB0aGF0Lm1vZGUsIGZ1bmN0aW9uKGVyciwgZmQpIHsKICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhhdC5hdXRvQ2xvc2UpCiAgICAgICAgICAgICAgICAgIHRoYXQuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgdGhhdC5lbWl0KCJlcnJvciIsIGVycik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoYXQuZmQgPSBmZDsKICAgICAgICAgICAgICAgIHRoYXQuZW1pdCgib3BlbiIsIGZkKTsKICAgICAgICAgICAgICAgIHRoYXQucmVhZCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBXcml0ZVN0cmVhbShwYXRoMiwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIFdyaXRlU3RyZWFtKQogICAgICAgICAgICAgIHJldHVybiBmcyRXcml0ZVN0cmVhbS5hcHBseSh0aGlzLCBhcmd1bWVudHMpLCB0aGlzOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgcmV0dXJuIFdyaXRlU3RyZWFtLmFwcGx5KE9iamVjdC5jcmVhdGUoV3JpdGVTdHJlYW0ucHJvdG90eXBlKSwgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFdyaXRlU3RyZWFtJG9wZW4oKSB7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAgICAgb3Blbih0aGF0LnBhdGgsIHRoYXQuZmxhZ3MsIHRoYXQubW9kZSwgZnVuY3Rpb24oZXJyLCBmZCkgewogICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgIHRoYXQuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgdGhhdC5lbWl0KCJlcnJvciIsIGVycik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoYXQuZmQgPSBmZDsKICAgICAgICAgICAgICAgIHRoYXQuZW1pdCgib3BlbiIsIGZkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVhZFN0cmVhbShwYXRoMiwgb3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4gbmV3IGZzMy5SZWFkU3RyZWFtKHBhdGgyLCBvcHRpb25zKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdyaXRlU3RyZWFtKHBhdGgyLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgZnMzLldyaXRlU3RyZWFtKHBhdGgyLCBvcHRpb25zKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcyRvcGVuID0gZnMzLm9wZW47CiAgICAgICAgICBmczMub3BlbiA9IG9wZW47CiAgICAgICAgICBmdW5jdGlvbiBvcGVuKHBhdGgyLCBmbGFncywgbW9kZSwgY2IpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RlID09PSAiZnVuY3Rpb24iKQogICAgICAgICAgICAgIGNiID0gbW9kZSwgbW9kZSA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBnbyRvcGVuKHBhdGgyLCBmbGFncywgbW9kZSwgY2IpOwogICAgICAgICAgICBmdW5jdGlvbiBnbyRvcGVuKHBhdGgzLCBmbGFnczIsIG1vZGUyLCBjYjIsIHN0YXJ0VGltZSkgewogICAgICAgICAgICAgIHJldHVybiBmcyRvcGVuKHBhdGgzLCBmbGFnczIsIG1vZGUyLCBmdW5jdGlvbihlcnIsIGZkKSB7CiAgICAgICAgICAgICAgICBpZiAoZXJyICYmIChlcnIuY29kZSA9PT0gIkVNRklMRSIgfHwgZXJyLmNvZGUgPT09ICJFTkZJTEUiKSkKICAgICAgICAgICAgICAgICAgZW5xdWV1ZShbZ28kb3BlbiwgW3BhdGgzLCBmbGFnczIsIG1vZGUyLCBjYjJdLCBlcnIsIHN0YXJ0VGltZSB8fCBEYXRlLm5vdygpLCBEYXRlLm5vdygpXSk7CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYjIgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgY2IyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmczM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWUoZWxlbSkgewogICAgICAgICAgZGVidWcoIkVOUVVFVUUiLCBlbGVtWzBdLm5hbWUsIGVsZW1bMV0pOwogICAgICAgICAgZnMyW2dyYWNlZnVsUXVldWVdLnB1c2goZWxlbSk7CiAgICAgICAgICByZXRyeSgpOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0cnlUaW1lcjsKICAgICAgICBmdW5jdGlvbiByZXNldFF1ZXVlKCkgewogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZzMltncmFjZWZ1bFF1ZXVlXS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoZnMyW2dyYWNlZnVsUXVldWVdW2ldLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgICBmczJbZ3JhY2VmdWxRdWV1ZV1baV1bM10gPSBub3c7CiAgICAgICAgICAgICAgZnMyW2dyYWNlZnVsUXVldWVdW2ldWzRdID0gbm93OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeSgpIHsKICAgICAgICAgIGNsZWFyVGltZW91dChyZXRyeVRpbWVyKTsKICAgICAgICAgIHJldHJ5VGltZXIgPSB2b2lkIDA7CiAgICAgICAgICBpZiAoZnMyW2dyYWNlZnVsUXVldWVdLmxlbmd0aCA9PT0gMCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgdmFyIGVsZW0gPSBmczJbZ3JhY2VmdWxRdWV1ZV0uc2hpZnQoKTsKICAgICAgICAgIHZhciBmbiA9IGVsZW1bMF07CiAgICAgICAgICB2YXIgYXJncyA9IGVsZW1bMV07CiAgICAgICAgICB2YXIgZXJyID0gZWxlbVsyXTsKICAgICAgICAgIHZhciBzdGFydFRpbWUgPSBlbGVtWzNdOwogICAgICAgICAgdmFyIGxhc3RUaW1lID0gZWxlbVs0XTsKICAgICAgICAgIGlmIChzdGFydFRpbWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICBkZWJ1ZygiUkVUUlkiLCBmbi5uYW1lLCBhcmdzKTsKICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICB9IGVsc2UgaWYgKERhdGUubm93KCkgLSBzdGFydFRpbWUgPj0gNmU0KSB7CiAgICAgICAgICAgIGRlYnVnKCJUSU1FT1VUIiwgZm4ubmFtZSwgYXJncyk7CiAgICAgICAgICAgIHZhciBjYiA9IGFyZ3MucG9wKCk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2IgPT09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgICAgY2IuY2FsbChudWxsLCBlcnIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHNpbmNlQXR0ZW1wdCA9IERhdGUubm93KCkgLSBsYXN0VGltZTsKICAgICAgICAgICAgdmFyIHNpbmNlU3RhcnQgPSBNYXRoLm1heChsYXN0VGltZSAtIHN0YXJ0VGltZSwgMSk7CiAgICAgICAgICAgIHZhciBkZXNpcmVkRGVsYXkgPSBNYXRoLm1pbihzaW5jZVN0YXJ0ICogMS4yLCAxMDApOwogICAgICAgICAgICBpZiAoc2luY2VBdHRlbXB0ID49IGRlc2lyZWREZWxheSkgewogICAgICAgICAgICAgIGRlYnVnKCJSRVRSWSIsIGZuLm5hbWUsIGFyZ3MpOwogICAgICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MuY29uY2F0KFtzdGFydFRpbWVdKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZnMyW2dyYWNlZnVsUXVldWVdLnB1c2goZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXRyeVRpbWVyID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0cnlUaW1lciA9IHNldFRpbWVvdXQocmV0cnksIDApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9mcyA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvZnMvaW5kZXguanMiKGV4cG9ydHMzKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciB1ID0gcmVxdWlyZV91bml2ZXJzYWxpZnkoKS5mcm9tQ2FsbGJhY2s7CiAgICAgICAgdmFyIGZzMiA9IHJlcXVpcmVfZ3JhY2VmdWxfZnMoKTsKICAgICAgICB2YXIgYXBpID0gWwogICAgICAgICAgImFjY2VzcyIsCiAgICAgICAgICAiYXBwZW5kRmlsZSIsCiAgICAgICAgICAiY2htb2QiLAogICAgICAgICAgImNob3duIiwKICAgICAgICAgICJjbG9zZSIsCiAgICAgICAgICAiY29weUZpbGUiLAogICAgICAgICAgImZjaG1vZCIsCiAgICAgICAgICAiZmNob3duIiwKICAgICAgICAgICJmZGF0YXN5bmMiLAogICAgICAgICAgImZzdGF0IiwKICAgICAgICAgICJmc3luYyIsCiAgICAgICAgICAiZnRydW5jYXRlIiwKICAgICAgICAgICJmdXRpbWVzIiwKICAgICAgICAgICJsY2htb2QiLAogICAgICAgICAgImxjaG93biIsCiAgICAgICAgICAibGluayIsCiAgICAgICAgICAibHN0YXQiLAogICAgICAgICAgIm1rZGlyIiwKICAgICAgICAgICJta2R0ZW1wIiwKICAgICAgICAgICJvcGVuIiwKICAgICAgICAgICJvcGVuZGlyIiwKICAgICAgICAgICJyZWFkZGlyIiwKICAgICAgICAgICJyZWFkRmlsZSIsCiAgICAgICAgICAicmVhZGxpbmsiLAogICAgICAgICAgInJlYWxwYXRoIiwKICAgICAgICAgICJyZW5hbWUiLAogICAgICAgICAgInJtIiwKICAgICAgICAgICJybWRpciIsCiAgICAgICAgICAic3RhdCIsCiAgICAgICAgICAic3ltbGluayIsCiAgICAgICAgICAidHJ1bmNhdGUiLAogICAgICAgICAgInVubGluayIsCiAgICAgICAgICAidXRpbWVzIiwKICAgICAgICAgICJ3cml0ZUZpbGUiCiAgICAgICAgXS5maWx0ZXIoKGtleSkgPT4gewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBmczJba2V5XSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICB9KTsKICAgICAgICBPYmplY3QuYXNzaWduKGV4cG9ydHMzLCBmczIpOwogICAgICAgIGFwaS5mb3JFYWNoKChtZXRob2QpID0+IHsKICAgICAgICAgIGV4cG9ydHMzW21ldGhvZF0gPSB1KGZzMlttZXRob2RdKTsKICAgICAgICB9KTsKICAgICAgICBleHBvcnRzMy5leGlzdHMgPSBmdW5jdGlvbihmaWxlbmFtZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIGZzMi5leGlzdHMoZmlsZW5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICByZXR1cm4gZnMyLmV4aXN0cyhmaWxlbmFtZSwgcmVzb2x2ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGV4cG9ydHMzLnJlYWQgPSBmdW5jdGlvbihmZCwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24sIGNhbGxiYWNrKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBmczIucmVhZChmZCwgYnVmZmVyLCBvZmZzZXQsIGxlbmd0aCwgcG9zaXRpb24sIGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgIGZzMi5yZWFkKGZkLCBidWZmZXIsIG9mZnNldCwgbGVuZ3RoLCBwb3NpdGlvbiwgKGVyciwgYnl0ZXNSZWFkLCBidWZmZXIyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycikKICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgICAgICAgICByZXNvbHZlKHsgYnl0ZXNSZWFkLCBidWZmZXI6IGJ1ZmZlcjIgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBleHBvcnRzMy53cml0ZSA9IGZ1bmN0aW9uKGZkLCBidWZmZXIsIC4uLmFyZ3MpIHsKICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1thcmdzLmxlbmd0aCAtIDFdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBmczIud3JpdGUoZmQsIGJ1ZmZlciwgLi4uYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICBmczIud3JpdGUoZmQsIGJ1ZmZlciwgLi4uYXJncywgKGVyciwgYnl0ZXNXcml0dGVuLCBidWZmZXIyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycikKICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgICAgICAgICByZXNvbHZlKHsgYnl0ZXNXcml0dGVuLCBidWZmZXI6IGJ1ZmZlcjIgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBleHBvcnRzMy5yZWFkdiA9IGZ1bmN0aW9uKGZkLCBidWZmZXJzLCAuLi5hcmdzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbYXJncy5sZW5ndGggLSAxXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gZnMyLnJlYWR2KGZkLCBidWZmZXJzLCAuLi5hcmdzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgIGZzMi5yZWFkdihmZCwgYnVmZmVycywgLi4uYXJncywgKGVyciwgYnl0ZXNSZWFkLCBidWZmZXJzMikgPT4gewogICAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgcmVzb2x2ZSh7IGJ5dGVzUmVhZCwgYnVmZmVyczogYnVmZmVyczIgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBleHBvcnRzMy53cml0ZXYgPSBmdW5jdGlvbihmZCwgYnVmZmVycywgLi4uYXJncykgewogICAgICAgICAgaWYgKHR5cGVvZiBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIGZzMi53cml0ZXYoZmQsIGJ1ZmZlcnMsIC4uLmFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgZnMyLndyaXRldihmZCwgYnVmZmVycywgLi4uYXJncywgKGVyciwgYnl0ZXNXcml0dGVuLCBidWZmZXJzMikgPT4gewogICAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgcmVzb2x2ZSh7IGJ5dGVzV3JpdHRlbiwgYnVmZmVyczogYnVmZmVyczIgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICBpZiAodHlwZW9mIGZzMi5yZWFscGF0aC5uYXRpdmUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGV4cG9ydHMzLnJlYWxwYXRoLm5hdGl2ZSA9IHUoZnMyLnJlYWxwYXRoLm5hdGl2ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByb2Nlc3MuZW1pdFdhcm5pbmcoCiAgICAgICAgICAgICJmcy5yZWFscGF0aC5uYXRpdmUgaXMgbm90IGEgZnVuY3Rpb24uIElzIGZzIGJlaW5nIG1vbmtleS1wYXRjaGVkPyIsCiAgICAgICAgICAgICJXYXJuaW5nIiwKICAgICAgICAgICAgImZzLWV4dHJhLVdBUk4wMDAzIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfdXRpbHMgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL21rZGlycy91dGlscy5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICBtb2R1bGUyMi5leHBvcnRzLmNoZWNrUGF0aCA9IGZ1bmN0aW9uIGNoZWNrUGF0aChwdGgpIHsKICAgICAgICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAid2luMzIiKSB7CiAgICAgICAgICAgIGNvbnN0IHBhdGhIYXNJbnZhbGlkV2luQ2hhcmFjdGVycyA9IC9bPD46Inw/Kl0vLnRlc3QocHRoLnJlcGxhY2UocGF0aDIucGFyc2UocHRoKS5yb290LCAiIikpOwogICAgICAgICAgICBpZiAocGF0aEhhc0ludmFsaWRXaW5DaGFyYWN0ZXJzKSB7CiAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoYFBhdGggY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzOiAke3B0aH1gKTsKICAgICAgICAgICAgICBlcnJvci5jb2RlID0gIkVJTlZBTCI7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX21ha2VfZGlyID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2ZzLWV4dHJhL2xpYi9ta2RpcnMvbWFrZS1kaXIuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9mcygpOwogICAgICAgIHZhciB7IGNoZWNrUGF0aCB9ID0gcmVxdWlyZV91dGlscygpOwogICAgICAgIHZhciBnZXRNb2RlID0gKG9wdGlvbnMpID0+IHsKICAgICAgICAgIGNvbnN0IGRlZmF1bHRzID0geyBtb2RlOiA1MTEgfTsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIpCiAgICAgICAgICAgIHJldHVybiBvcHRpb25zOwogICAgICAgICAgcmV0dXJuIHsgLi4uZGVmYXVsdHMsIC4uLm9wdGlvbnMgfS5tb2RlOwogICAgICAgIH07CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cy5tYWtlRGlyID0gYXN5bmMgKGRpciwgb3B0aW9ucykgPT4gewogICAgICAgICAgY2hlY2tQYXRoKGRpcik7CiAgICAgICAgICByZXR1cm4gZnMyLm1rZGlyKGRpciwgewogICAgICAgICAgICBtb2RlOiBnZXRNb2RlKG9wdGlvbnMpLAogICAgICAgICAgICByZWN1cnNpdmU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cy5tYWtlRGlyU3luYyA9IChkaXIsIG9wdGlvbnMpID0+IHsKICAgICAgICAgIGNoZWNrUGF0aChkaXIpOwogICAgICAgICAgcmV0dXJuIGZzMi5ta2RpclN5bmMoZGlyLCB7CiAgICAgICAgICAgIG1vZGU6IGdldE1vZGUob3B0aW9ucyksCiAgICAgICAgICAgIHJlY3Vyc2l2ZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9ta2RpcnMgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL21rZGlycy9pbmRleC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciB1ID0gcmVxdWlyZV91bml2ZXJzYWxpZnkoKS5mcm9tUHJvbWlzZTsKICAgICAgICB2YXIgeyBtYWtlRGlyOiBfbWFrZURpciwgbWFrZURpclN5bmMgfSA9IHJlcXVpcmVfbWFrZV9kaXIoKTsKICAgICAgICB2YXIgbWFrZURpciA9IHUoX21ha2VEaXIpOwogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7CiAgICAgICAgICBta2RpcnM6IG1ha2VEaXIsCiAgICAgICAgICBta2RpcnNTeW5jOiBtYWtlRGlyU3luYywKICAgICAgICAgIC8vIGFsaWFzCiAgICAgICAgICBta2RpcnA6IG1ha2VEaXIsCiAgICAgICAgICBta2RpcnBTeW5jOiBtYWtlRGlyU3luYywKICAgICAgICAgIGVuc3VyZURpcjogbWFrZURpciwKICAgICAgICAgIGVuc3VyZURpclN5bmM6IG1ha2VEaXJTeW5jCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9wYXRoX2V4aXN0cyA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvcGF0aC1leGlzdHMvaW5kZXguanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgdSA9IHJlcXVpcmVfdW5pdmVyc2FsaWZ5KCkuZnJvbVByb21pc2U7CiAgICAgICAgdmFyIGZzMiA9IHJlcXVpcmVfZnMoKTsKICAgICAgICBmdW5jdGlvbiBwYXRoRXhpc3RzKHBhdGgyKSB7CiAgICAgICAgICByZXR1cm4gZnMyLmFjY2VzcyhwYXRoMikudGhlbigoKSA9PiB0cnVlKS5jYXRjaCgoKSA9PiBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7CiAgICAgICAgICBwYXRoRXhpc3RzOiB1KHBhdGhFeGlzdHMpLAogICAgICAgICAgcGF0aEV4aXN0c1N5bmM6IGZzMi5leGlzdHNTeW5jCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV91dGltZXMgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL3V0aWwvdXRpbWVzLmpzIihleHBvcnRzMywgbW9kdWxlMjIpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIGZzMiA9IHJlcXVpcmVfZ3JhY2VmdWxfZnMoKTsKICAgICAgICBmdW5jdGlvbiB1dGltZXNNaWxsaXMocGF0aDIsIGF0aW1lLCBtdGltZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGZzMi5vcGVuKHBhdGgyLCAicisiLCAoZXJyLCBmZCkgPT4gewogICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICBmczIuZnV0aW1lcyhmZCwgYXRpbWUsIG10aW1lLCAoZnV0aW1lc0VycikgPT4gewogICAgICAgICAgICAgIGZzMi5jbG9zZShmZCwgKGNsb3NlRXJyKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZ1dGltZXNFcnIgfHwgY2xvc2VFcnIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1dGltZXNNaWxsaXNTeW5jKHBhdGgyLCBhdGltZSwgbXRpbWUpIHsKICAgICAgICAgIGNvbnN0IGZkID0gZnMyLm9wZW5TeW5jKHBhdGgyLCAicisiKTsKICAgICAgICAgIGZzMi5mdXRpbWVzU3luYyhmZCwgYXRpbWUsIG10aW1lKTsKICAgICAgICAgIHJldHVybiBmczIuY2xvc2VTeW5jKGZkKTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIHV0aW1lc01pbGxpcywKICAgICAgICAgIHV0aW1lc01pbGxpc1N5bmMKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX3N0YXQgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL3V0aWwvc3RhdC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBmczIgPSByZXF1aXJlX2ZzKCk7CiAgICAgICAgdmFyIHBhdGgyID0gcmVxdWlyZSgicGF0aCIpOwogICAgICAgIHZhciB1dGlsMiA9IHJlcXVpcmUoInV0aWwiKTsKICAgICAgICBmdW5jdGlvbiBnZXRTdGF0cyhzcmMsIGRlc3QsIG9wdHMpIHsKICAgICAgICAgIGNvbnN0IHN0YXRGdW5jID0gb3B0cy5kZXJlZmVyZW5jZSA/IChmaWxlKSA9PiBmczIuc3RhdChmaWxlLCB7IGJpZ2ludDogdHJ1ZSB9KSA6IChmaWxlKSA9PiBmczIubHN0YXQoZmlsZSwgeyBiaWdpbnQ6IHRydWUgfSk7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICAgICAgICBzdGF0RnVuYyhzcmMpLAogICAgICAgICAgICBzdGF0RnVuYyhkZXN0KS5jYXRjaCgoZXJyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSAiRU5PRU5UIikKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfSkKICAgICAgICAgIF0pLnRoZW4oKFtzcmNTdGF0LCBkZXN0U3RhdF0pID0+ICh7IHNyY1N0YXQsIGRlc3RTdGF0IH0pKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdHNTeW5jKHNyYywgZGVzdCwgb3B0cykgewogICAgICAgICAgbGV0IGRlc3RTdGF0OwogICAgICAgICAgY29uc3Qgc3RhdEZ1bmMgPSBvcHRzLmRlcmVmZXJlbmNlID8gKGZpbGUpID0+IGZzMi5zdGF0U3luYyhmaWxlLCB7IGJpZ2ludDogdHJ1ZSB9KSA6IChmaWxlKSA9PiBmczIubHN0YXRTeW5jKGZpbGUsIHsgYmlnaW50OiB0cnVlIH0pOwogICAgICAgICAgY29uc3Qgc3JjU3RhdCA9IHN0YXRGdW5jKHNyYyk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0U3RhdCA9IHN0YXRGdW5jKGRlc3QpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gIkVOT0VOVCIpCiAgICAgICAgICAgICAgcmV0dXJuIHsgc3JjU3RhdCwgZGVzdFN0YXQ6IG51bGwgfTsKICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsgc3JjU3RhdCwgZGVzdFN0YXQgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQYXRocyhzcmMsIGRlc3QsIGZ1bmNOYW1lLCBvcHRzLCBjYikgewogICAgICAgICAgdXRpbDIuY2FsbGJhY2tpZnkoZ2V0U3RhdHMpKHNyYywgZGVzdCwgb3B0cywgKGVyciwgc3RhdHMpID0+IHsKICAgICAgICAgICAgaWYgKGVycikKICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTsKICAgICAgICAgICAgY29uc3QgeyBzcmNTdGF0LCBkZXN0U3RhdCB9ID0gc3RhdHM7CiAgICAgICAgICAgIGlmIChkZXN0U3RhdCkgewogICAgICAgICAgICAgIGlmIChhcmVJZGVudGljYWwoc3JjU3RhdCwgZGVzdFN0YXQpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcmNCYXNlTmFtZSA9IHBhdGgyLmJhc2VuYW1lKHNyYyk7CiAgICAgICAgICAgICAgICBjb25zdCBkZXN0QmFzZU5hbWUgPSBwYXRoMi5iYXNlbmFtZShkZXN0KTsKICAgICAgICAgICAgICAgIGlmIChmdW5jTmFtZSA9PT0gIm1vdmUiICYmIHNyY0Jhc2VOYW1lICE9PSBkZXN0QmFzZU5hbWUgJiYgc3JjQmFzZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gZGVzdEJhc2VOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIHsgc3JjU3RhdCwgZGVzdFN0YXQsIGlzQ2hhbmdpbmdDYXNlOiB0cnVlIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcigiU291cmNlIGFuZCBkZXN0aW5hdGlvbiBtdXN0IG5vdCBiZSB0aGUgc2FtZS4iKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzcmNTdGF0LmlzRGlyZWN0b3J5KCkgJiYgIWRlc3RTdGF0LmlzRGlyZWN0b3J5KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoYENhbm5vdCBvdmVyd3JpdGUgbm9uLWRpcmVjdG9yeSAnJHtkZXN0fScgd2l0aCBkaXJlY3RvcnkgJyR7c3JjfScuYCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXNyY1N0YXQuaXNEaXJlY3RvcnkoKSAmJiBkZXN0U3RhdC5pc0RpcmVjdG9yeSgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKGBDYW5ub3Qgb3ZlcndyaXRlIGRpcmVjdG9yeSAnJHtkZXN0fScgd2l0aCBub24tZGlyZWN0b3J5ICcke3NyY30nLmApKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNyY1N0YXQuaXNEaXJlY3RvcnkoKSAmJiBpc1NyY1N1YmRpcihzcmMsIGRlc3QpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcihlcnJNc2coc3JjLCBkZXN0LCBmdW5jTmFtZSkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgeyBzcmNTdGF0LCBkZXN0U3RhdCB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1BhdGhzU3luYyhzcmMsIGRlc3QsIGZ1bmNOYW1lLCBvcHRzKSB7CiAgICAgICAgICBjb25zdCB7IHNyY1N0YXQsIGRlc3RTdGF0IH0gPSBnZXRTdGF0c1N5bmMoc3JjLCBkZXN0LCBvcHRzKTsKICAgICAgICAgIGlmIChkZXN0U3RhdCkgewogICAgICAgICAgICBpZiAoYXJlSWRlbnRpY2FsKHNyY1N0YXQsIGRlc3RTdGF0KSkgewogICAgICAgICAgICAgIGNvbnN0IHNyY0Jhc2VOYW1lID0gcGF0aDIuYmFzZW5hbWUoc3JjKTsKICAgICAgICAgICAgICBjb25zdCBkZXN0QmFzZU5hbWUgPSBwYXRoMi5iYXNlbmFtZShkZXN0KTsKICAgICAgICAgICAgICBpZiAoZnVuY05hbWUgPT09ICJtb3ZlIiAmJiBzcmNCYXNlTmFtZSAhPT0gZGVzdEJhc2VOYW1lICYmIHNyY0Jhc2VOYW1lLnRvTG93ZXJDYXNlKCkgPT09IGRlc3RCYXNlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzcmNTdGF0LCBkZXN0U3RhdCwgaXNDaGFuZ2luZ0Nhc2U6IHRydWUgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTb3VyY2UgYW5kIGRlc3RpbmF0aW9uIG11c3Qgbm90IGJlIHRoZSBzYW1lLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcmNTdGF0LmlzRGlyZWN0b3J5KCkgJiYgIWRlc3RTdGF0LmlzRGlyZWN0b3J5KCkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBvdmVyd3JpdGUgbm9uLWRpcmVjdG9yeSAnJHtkZXN0fScgd2l0aCBkaXJlY3RvcnkgJyR7c3JjfScuYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFzcmNTdGF0LmlzRGlyZWN0b3J5KCkgJiYgZGVzdFN0YXQuaXNEaXJlY3RvcnkoKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IG92ZXJ3cml0ZSBkaXJlY3RvcnkgJyR7ZGVzdH0nIHdpdGggbm9uLWRpcmVjdG9yeSAnJHtzcmN9Jy5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHNyY1N0YXQuaXNEaXJlY3RvcnkoKSAmJiBpc1NyY1N1YmRpcihzcmMsIGRlc3QpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2coc3JjLCBkZXN0LCBmdW5jTmFtZSkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsgc3JjU3RhdCwgZGVzdFN0YXQgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQYXJlbnRQYXRocyhzcmMsIHNyY1N0YXQsIGRlc3QsIGZ1bmNOYW1lLCBjYikgewogICAgICAgICAgY29uc3Qgc3JjUGFyZW50ID0gcGF0aDIucmVzb2x2ZShwYXRoMi5kaXJuYW1lKHNyYykpOwogICAgICAgICAgY29uc3QgZGVzdFBhcmVudCA9IHBhdGgyLnJlc29sdmUocGF0aDIuZGlybmFtZShkZXN0KSk7CiAgICAgICAgICBpZiAoZGVzdFBhcmVudCA9PT0gc3JjUGFyZW50IHx8IGRlc3RQYXJlbnQgPT09IHBhdGgyLnBhcnNlKGRlc3RQYXJlbnQpLnJvb3QpCiAgICAgICAgICAgIHJldHVybiBjYigpOwogICAgICAgICAgZnMyLnN0YXQoZGVzdFBhcmVudCwgeyBiaWdpbnQ6IHRydWUgfSwgKGVyciwgZGVzdFN0YXQpID0+IHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gIkVOT0VOVCIpCiAgICAgICAgICAgICAgICByZXR1cm4gY2IoKTsKICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXJlSWRlbnRpY2FsKHNyY1N0YXQsIGRlc3RTdGF0KSkgewogICAgICAgICAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoZXJyTXNnKHNyYywgZGVzdCwgZnVuY05hbWUpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNoZWNrUGFyZW50UGF0aHMoc3JjLCBzcmNTdGF0LCBkZXN0UGFyZW50LCBmdW5jTmFtZSwgY2IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUGFyZW50UGF0aHNTeW5jKHNyYywgc3JjU3RhdCwgZGVzdCwgZnVuY05hbWUpIHsKICAgICAgICAgIGNvbnN0IHNyY1BhcmVudCA9IHBhdGgyLnJlc29sdmUocGF0aDIuZGlybmFtZShzcmMpKTsKICAgICAgICAgIGNvbnN0IGRlc3RQYXJlbnQgPSBwYXRoMi5yZXNvbHZlKHBhdGgyLmRpcm5hbWUoZGVzdCkpOwogICAgICAgICAgaWYgKGRlc3RQYXJlbnQgPT09IHNyY1BhcmVudCB8fCBkZXN0UGFyZW50ID09PSBwYXRoMi5wYXJzZShkZXN0UGFyZW50KS5yb290KQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICBsZXQgZGVzdFN0YXQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0U3RhdCA9IGZzMi5zdGF0U3luYyhkZXN0UGFyZW50LCB7IGJpZ2ludDogdHJ1ZSB9KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09ICJFTk9FTlQiKQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFyZUlkZW50aWNhbChzcmNTdGF0LCBkZXN0U3RhdCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyck1zZyhzcmMsIGRlc3QsIGZ1bmNOYW1lKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hlY2tQYXJlbnRQYXRoc1N5bmMoc3JjLCBzcmNTdGF0LCBkZXN0UGFyZW50LCBmdW5jTmFtZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZUlkZW50aWNhbChzcmNTdGF0LCBkZXN0U3RhdCkgewogICAgICAgICAgcmV0dXJuIGRlc3RTdGF0LmlubyAmJiBkZXN0U3RhdC5kZXYgJiYgZGVzdFN0YXQuaW5vID09PSBzcmNTdGF0LmlubyAmJiBkZXN0U3RhdC5kZXYgPT09IHNyY1N0YXQuZGV2OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NyY1N1YmRpcihzcmMsIGRlc3QpIHsKICAgICAgICAgIGNvbnN0IHNyY0FyciA9IHBhdGgyLnJlc29sdmUoc3JjKS5zcGxpdChwYXRoMi5zZXApLmZpbHRlcigoaSkgPT4gaSk7CiAgICAgICAgICBjb25zdCBkZXN0QXJyID0gcGF0aDIucmVzb2x2ZShkZXN0KS5zcGxpdChwYXRoMi5zZXApLmZpbHRlcigoaSkgPT4gaSk7CiAgICAgICAgICByZXR1cm4gc3JjQXJyLnJlZHVjZSgoYWNjLCBjdXIsIGkpID0+IGFjYyAmJiBkZXN0QXJyW2ldID09PSBjdXIsIHRydWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlcnJNc2coc3JjLCBkZXN0LCBmdW5jTmFtZSkgewogICAgICAgICAgcmV0dXJuIGBDYW5ub3QgJHtmdW5jTmFtZX0gJyR7c3JjfScgdG8gYSBzdWJkaXJlY3Rvcnkgb2YgaXRzZWxmLCAnJHtkZXN0fScuYDsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIGNoZWNrUGF0aHMsCiAgICAgICAgICBjaGVja1BhdGhzU3luYywKICAgICAgICAgIGNoZWNrUGFyZW50UGF0aHMsCiAgICAgICAgICBjaGVja1BhcmVudFBhdGhzU3luYywKICAgICAgICAgIGlzU3JjU3ViZGlyLAogICAgICAgICAgYXJlSWRlbnRpY2FsCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9jb3B5ID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2ZzLWV4dHJhL2xpYi9jb3B5L2NvcHkuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9ncmFjZWZ1bF9mcygpOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICB2YXIgbWtkaXJzID0gcmVxdWlyZV9ta2RpcnMoKS5ta2RpcnM7CiAgICAgICAgdmFyIHBhdGhFeGlzdHMgPSByZXF1aXJlX3BhdGhfZXhpc3RzKCkucGF0aEV4aXN0czsKICAgICAgICB2YXIgdXRpbWVzTWlsbGlzID0gcmVxdWlyZV91dGltZXMoKS51dGltZXNNaWxsaXM7CiAgICAgICAgdmFyIHN0YXQgPSByZXF1aXJlX3N0YXQoKTsKICAgICAgICBmdW5jdGlvbiBjb3B5KHNyYywgZGVzdCwgb3B0cywgY2IpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gImZ1bmN0aW9uIiAmJiAhY2IpIHsKICAgICAgICAgICAgY2IgPSBvcHRzOwogICAgICAgICAgICBvcHRzID0ge307CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG9wdHMgPSB7IGZpbHRlcjogb3B0cyB9OwogICAgICAgICAgfQogICAgICAgICAgY2IgPSBjYiB8fCBmdW5jdGlvbigpIHsKICAgICAgICAgIH07CiAgICAgICAgICBvcHRzID0gb3B0cyB8fCB7fTsKICAgICAgICAgIG9wdHMuY2xvYmJlciA9ICJjbG9iYmVyIiBpbiBvcHRzID8gISFvcHRzLmNsb2JiZXIgOiB0cnVlOwogICAgICAgICAgb3B0cy5vdmVyd3JpdGUgPSAib3ZlcndyaXRlIiBpbiBvcHRzID8gISFvcHRzLm92ZXJ3cml0ZSA6IG9wdHMuY2xvYmJlcjsKICAgICAgICAgIGlmIChvcHRzLnByZXNlcnZlVGltZXN0YW1wcyAmJiBwcm9jZXNzLmFyY2ggPT09ICJpYTMyIikgewogICAgICAgICAgICBwcm9jZXNzLmVtaXRXYXJuaW5nKAogICAgICAgICAgICAgICJVc2luZyB0aGUgcHJlc2VydmVUaW1lc3RhbXBzIG9wdGlvbiBpbiAzMi1iaXQgbm9kZSBpcyBub3QgcmVjb21tZW5kZWQ7XG5cbglzZWUgaHR0cHM6Ly9naXRodWIuY29tL2pwcmljaGFyZHNvbi9ub2RlLWZzLWV4dHJhL2lzc3Vlcy8yNjkiLAogICAgICAgICAgICAgICJXYXJuaW5nIiwKICAgICAgICAgICAgICAiZnMtZXh0cmEtV0FSTjAwMDEiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0LmNoZWNrUGF0aHMoc3JjLCBkZXN0LCAiY29weSIsIG9wdHMsIChlcnIsIHN0YXRzKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIGNvbnN0IHsgc3JjU3RhdCwgZGVzdFN0YXQgfSA9IHN0YXRzOwogICAgICAgICAgICBzdGF0LmNoZWNrUGFyZW50UGF0aHMoc3JjLCBzcmNTdGF0LCBkZXN0LCAiY29weSIsIChlcnIyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycjIpCiAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyMik7CiAgICAgICAgICAgICAgcnVuRmlsdGVyKHNyYywgZGVzdCwgb3B0cywgKGVycjMsIGluY2x1ZGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnIzKQogICAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyMyk7CiAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGUpCiAgICAgICAgICAgICAgICAgIHJldHVybiBjYigpOwogICAgICAgICAgICAgICAgY2hlY2tQYXJlbnREaXIoZGVzdFN0YXQsIHNyYywgZGVzdCwgb3B0cywgY2IpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1BhcmVudERpcihkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzLCBjYikgewogICAgICAgICAgY29uc3QgZGVzdFBhcmVudCA9IHBhdGgyLmRpcm5hbWUoZGVzdCk7CiAgICAgICAgICBwYXRoRXhpc3RzKGRlc3RQYXJlbnQsIChlcnIsIGRpckV4aXN0cykgPT4gewogICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYihlcnIpOwogICAgICAgICAgICBpZiAoZGlyRXhpc3RzKQogICAgICAgICAgICAgIHJldHVybiBnZXRTdGF0cyhkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzLCBjYik7CiAgICAgICAgICAgIG1rZGlycyhkZXN0UGFyZW50LCAoZXJyMikgPT4gewogICAgICAgICAgICAgIGlmIChlcnIyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycjIpOwogICAgICAgICAgICAgIHJldHVybiBnZXRTdGF0cyhkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzLCBjYik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bkZpbHRlcihzcmMsIGRlc3QsIG9wdHMsIGNiKSB7CiAgICAgICAgICBpZiAoIW9wdHMuZmlsdGVyKQogICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgdHJ1ZSk7CiAgICAgICAgICBQcm9taXNlLnJlc29sdmUob3B0cy5maWx0ZXIoc3JjLCBkZXN0KSkudGhlbigoaW5jbHVkZSkgPT4gY2IobnVsbCwgaW5jbHVkZSksIChlcnJvcikgPT4gY2IoZXJyb3IpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdHMoZGVzdFN0YXQsIHNyYywgZGVzdCwgb3B0cywgY2IpIHsKICAgICAgICAgIGNvbnN0IHN0YXQyID0gb3B0cy5kZXJlZmVyZW5jZSA/IGZzMi5zdGF0IDogZnMyLmxzdGF0OwogICAgICAgICAgc3RhdDIoc3JjLCAoZXJyLCBzcmNTdGF0KSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIGlmIChzcmNTdGF0LmlzRGlyZWN0b3J5KCkpCiAgICAgICAgICAgICAgcmV0dXJuIG9uRGlyKHNyY1N0YXQsIGRlc3RTdGF0LCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICAgICAgZWxzZSBpZiAoc3JjU3RhdC5pc0ZpbGUoKSB8fCBzcmNTdGF0LmlzQ2hhcmFjdGVyRGV2aWNlKCkgfHwgc3JjU3RhdC5pc0Jsb2NrRGV2aWNlKCkpCiAgICAgICAgICAgICAgcmV0dXJuIG9uRmlsZShzcmNTdGF0LCBkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzLCBjYik7CiAgICAgICAgICAgIGVsc2UgaWYgKHNyY1N0YXQuaXNTeW1ib2xpY0xpbmsoKSkKICAgICAgICAgICAgICByZXR1cm4gb25MaW5rKGRlc3RTdGF0LCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICAgICAgZWxzZSBpZiAoc3JjU3RhdC5pc1NvY2tldCgpKQogICAgICAgICAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoYENhbm5vdCBjb3B5IGEgc29ja2V0IGZpbGU6ICR7c3JjfWApKTsKICAgICAgICAgICAgZWxzZSBpZiAoc3JjU3RhdC5pc0ZJRk8oKSkKICAgICAgICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKGBDYW5ub3QgY29weSBhIEZJRk8gcGlwZTogJHtzcmN9YCkpOwogICAgICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKGBVbmtub3duIGZpbGU6ICR7c3JjfWApKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkZpbGUoc3JjU3RhdCwgZGVzdFN0YXQsIHNyYywgZGVzdCwgb3B0cywgY2IpIHsKICAgICAgICAgIGlmICghZGVzdFN0YXQpCiAgICAgICAgICAgIHJldHVybiBjb3B5RmlsZShzcmNTdGF0LCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICAgIHJldHVybiBtYXlDb3B5RmlsZShzcmNTdGF0LCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWF5Q29weUZpbGUoc3JjU3RhdCwgc3JjLCBkZXN0LCBvcHRzLCBjYikgewogICAgICAgICAgaWYgKG9wdHMub3ZlcndyaXRlKSB7CiAgICAgICAgICAgIGZzMi51bmxpbmsoZGVzdCwgKGVycikgPT4gewogICAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTsKICAgICAgICAgICAgICByZXR1cm4gY29weUZpbGUoc3JjU3RhdCwgc3JjLCBkZXN0LCBvcHRzLCBjYik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmVycm9yT25FeGlzdCkgewogICAgICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKGAnJHtkZXN0fScgYWxyZWFkeSBleGlzdHNgKSk7CiAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgcmV0dXJuIGNiKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvcHlGaWxlKHNyY1N0YXQsIHNyYywgZGVzdCwgb3B0cywgY2IpIHsKICAgICAgICAgIGZzMi5jb3B5RmlsZShzcmMsIGRlc3QsIChlcnIpID0+IHsKICAgICAgICAgICAgaWYgKGVycikKICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTsKICAgICAgICAgICAgaWYgKG9wdHMucHJlc2VydmVUaW1lc3RhbXBzKQogICAgICAgICAgICAgIHJldHVybiBoYW5kbGVUaW1lc3RhbXBzQW5kTW9kZShzcmNTdGF0Lm1vZGUsIHNyYywgZGVzdCwgY2IpOwogICAgICAgICAgICByZXR1cm4gc2V0RGVzdE1vZGUoZGVzdCwgc3JjU3RhdC5tb2RlLCBjYik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlVGltZXN0YW1wc0FuZE1vZGUoc3JjTW9kZSwgc3JjLCBkZXN0LCBjYikgewogICAgICAgICAgaWYgKGZpbGVJc05vdFdyaXRhYmxlKHNyY01vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBtYWtlRmlsZVdyaXRhYmxlKGRlc3QsIHNyY01vZGUsIChlcnIpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgICAgcmV0dXJuIHNldERlc3RUaW1lc3RhbXBzQW5kTW9kZShzcmNNb2RlLCBzcmMsIGRlc3QsIGNiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2V0RGVzdFRpbWVzdGFtcHNBbmRNb2RlKHNyY01vZGUsIHNyYywgZGVzdCwgY2IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaWxlSXNOb3RXcml0YWJsZShzcmNNb2RlKSB7CiAgICAgICAgICByZXR1cm4gKHNyY01vZGUgJiAxMjgpID09PSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYWtlRmlsZVdyaXRhYmxlKGRlc3QsIHNyY01vZGUsIGNiKSB7CiAgICAgICAgICByZXR1cm4gc2V0RGVzdE1vZGUoZGVzdCwgc3JjTW9kZSB8IDEyOCwgY2IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZXN0VGltZXN0YW1wc0FuZE1vZGUoc3JjTW9kZSwgc3JjLCBkZXN0LCBjYikgewogICAgICAgICAgc2V0RGVzdFRpbWVzdGFtcHMoc3JjLCBkZXN0LCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIHJldHVybiBzZXREZXN0TW9kZShkZXN0LCBzcmNNb2RlLCBjYik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVzdE1vZGUoZGVzdCwgc3JjTW9kZSwgY2IpIHsKICAgICAgICAgIHJldHVybiBmczIuY2htb2QoZGVzdCwgc3JjTW9kZSwgY2IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZXN0VGltZXN0YW1wcyhzcmMsIGRlc3QsIGNiKSB7CiAgICAgICAgICBmczIuc3RhdChzcmMsIChlcnIsIHVwZGF0ZWRTcmNTdGF0KSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIHJldHVybiB1dGltZXNNaWxsaXMoZGVzdCwgdXBkYXRlZFNyY1N0YXQuYXRpbWUsIHVwZGF0ZWRTcmNTdGF0Lm10aW1lLCBjYik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25EaXIoc3JjU3RhdCwgZGVzdFN0YXQsIHNyYywgZGVzdCwgb3B0cywgY2IpIHsKICAgICAgICAgIGlmICghZGVzdFN0YXQpCiAgICAgICAgICAgIHJldHVybiBta0RpckFuZENvcHkoc3JjU3RhdC5tb2RlLCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICAgIHJldHVybiBjb3B5RGlyKHNyYywgZGVzdCwgb3B0cywgY2IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBta0RpckFuZENvcHkoc3JjTW9kZSwgc3JjLCBkZXN0LCBvcHRzLCBjYikgewogICAgICAgICAgZnMyLm1rZGlyKGRlc3QsIChlcnIpID0+IHsKICAgICAgICAgICAgaWYgKGVycikKICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTsKICAgICAgICAgICAgY29weURpcihzcmMsIGRlc3QsIG9wdHMsIChlcnIyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycjIpCiAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyMik7CiAgICAgICAgICAgICAgcmV0dXJuIHNldERlc3RNb2RlKGRlc3QsIHNyY01vZGUsIGNiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29weURpcihzcmMsIGRlc3QsIG9wdHMsIGNiKSB7CiAgICAgICAgICBmczIucmVhZGRpcihzcmMsIChlcnIsIGl0ZW1zKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIHJldHVybiBjb3B5RGlySXRlbXMoaXRlbXMsIHNyYywgZGVzdCwgb3B0cywgY2IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvcHlEaXJJdGVtcyhpdGVtcywgc3JjLCBkZXN0LCBvcHRzLCBjYikgewogICAgICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zLnBvcCgpOwogICAgICAgICAgaWYgKCFpdGVtKQogICAgICAgICAgICByZXR1cm4gY2IoKTsKICAgICAgICAgIHJldHVybiBjb3B5RGlySXRlbShpdGVtcywgaXRlbSwgc3JjLCBkZXN0LCBvcHRzLCBjYik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvcHlEaXJJdGVtKGl0ZW1zLCBpdGVtLCBzcmMsIGRlc3QsIG9wdHMsIGNiKSB7CiAgICAgICAgICBjb25zdCBzcmNJdGVtID0gcGF0aDIuam9pbihzcmMsIGl0ZW0pOwogICAgICAgICAgY29uc3QgZGVzdEl0ZW0gPSBwYXRoMi5qb2luKGRlc3QsIGl0ZW0pOwogICAgICAgICAgcnVuRmlsdGVyKHNyY0l0ZW0sIGRlc3RJdGVtLCBvcHRzLCAoZXJyLCBpbmNsdWRlKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIGlmICghaW5jbHVkZSkKICAgICAgICAgICAgICByZXR1cm4gY29weURpckl0ZW1zKGl0ZW1zLCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICAgICAgc3RhdC5jaGVja1BhdGhzKHNyY0l0ZW0sIGRlc3RJdGVtLCAiY29weSIsIG9wdHMsIChlcnIyLCBzdGF0cykgPT4gewogICAgICAgICAgICAgIGlmIChlcnIyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycjIpOwogICAgICAgICAgICAgIGNvbnN0IHsgZGVzdFN0YXQgfSA9IHN0YXRzOwogICAgICAgICAgICAgIGdldFN0YXRzKGRlc3RTdGF0LCBzcmNJdGVtLCBkZXN0SXRlbSwgb3B0cywgKGVycjMpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnIzKQogICAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyMyk7CiAgICAgICAgICAgICAgICByZXR1cm4gY29weURpckl0ZW1zKGl0ZW1zLCBzcmMsIGRlc3QsIG9wdHMsIGNiKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25MaW5rKGRlc3RTdGF0LCBzcmMsIGRlc3QsIG9wdHMsIGNiKSB7CiAgICAgICAgICBmczIucmVhZGxpbmsoc3JjLCAoZXJyLCByZXNvbHZlZFNyYykgPT4gewogICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYihlcnIpOwogICAgICAgICAgICBpZiAob3B0cy5kZXJlZmVyZW5jZSkgewogICAgICAgICAgICAgIHJlc29sdmVkU3JjID0gcGF0aDIucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCByZXNvbHZlZFNyYyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFkZXN0U3RhdCkgewogICAgICAgICAgICAgIHJldHVybiBmczIuc3ltbGluayhyZXNvbHZlZFNyYywgZGVzdCwgY2IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZzMi5yZWFkbGluayhkZXN0LCAoZXJyMiwgcmVzb2x2ZWREZXN0KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZXJyMikgewogICAgICAgICAgICAgICAgICBpZiAoZXJyMi5jb2RlID09PSAiRUlOVkFMIiB8fCBlcnIyLmNvZGUgPT09ICJVTktOT1dOIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnMyLnN5bWxpbmsocmVzb2x2ZWRTcmMsIGRlc3QsIGNiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdHMuZGVyZWZlcmVuY2UpIHsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZWREZXN0ID0gcGF0aDIucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCByZXNvbHZlZERlc3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXQuaXNTcmNTdWJkaXIocmVzb2x2ZWRTcmMsIHJlc29sdmVkRGVzdCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKG5ldyBFcnJvcihgQ2Fubm90IGNvcHkgJyR7cmVzb2x2ZWRTcmN9JyB0byBhIHN1YmRpcmVjdG9yeSBvZiBpdHNlbGYsICcke3Jlc29sdmVkRGVzdH0nLmApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0LmlzU3JjU3ViZGlyKHJlc29sdmVkRGVzdCwgcmVzb2x2ZWRTcmMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjYihuZXcgRXJyb3IoYENhbm5vdCBvdmVyd3JpdGUgJyR7cmVzb2x2ZWREZXN0fScgd2l0aCAnJHtyZXNvbHZlZFNyY30nLmApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb3B5TGluayhyZXNvbHZlZFNyYywgZGVzdCwgY2IpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29weUxpbmsocmVzb2x2ZWRTcmMsIGRlc3QsIGNiKSB7CiAgICAgICAgICBmczIudW5saW5rKGRlc3QsIChlcnIpID0+IHsKICAgICAgICAgICAgaWYgKGVycikKICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTsKICAgICAgICAgICAgcmV0dXJuIGZzMi5zeW1saW5rKHJlc29sdmVkU3JjLCBkZXN0LCBjYik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IGNvcHk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfY29weV9zeW5jID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2ZzLWV4dHJhL2xpYi9jb3B5L2NvcHktc3luYy5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBmczIgPSByZXF1aXJlX2dyYWNlZnVsX2ZzKCk7CiAgICAgICAgdmFyIHBhdGgyID0gcmVxdWlyZSgicGF0aCIpOwogICAgICAgIHZhciBta2RpcnNTeW5jID0gcmVxdWlyZV9ta2RpcnMoKS5ta2RpcnNTeW5jOwogICAgICAgIHZhciB1dGltZXNNaWxsaXNTeW5jID0gcmVxdWlyZV91dGltZXMoKS51dGltZXNNaWxsaXNTeW5jOwogICAgICAgIHZhciBzdGF0ID0gcmVxdWlyZV9zdGF0KCk7CiAgICAgICAgZnVuY3Rpb24gY29weVN5bmMoc3JjLCBkZXN0LCBvcHRzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG9wdHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgb3B0cyA9IHsgZmlsdGVyOiBvcHRzIH07CiAgICAgICAgICB9CiAgICAgICAgICBvcHRzID0gb3B0cyB8fCB7fTsKICAgICAgICAgIG9wdHMuY2xvYmJlciA9ICJjbG9iYmVyIiBpbiBvcHRzID8gISFvcHRzLmNsb2JiZXIgOiB0cnVlOwogICAgICAgICAgb3B0cy5vdmVyd3JpdGUgPSAib3ZlcndyaXRlIiBpbiBvcHRzID8gISFvcHRzLm92ZXJ3cml0ZSA6IG9wdHMuY2xvYmJlcjsKICAgICAgICAgIGlmIChvcHRzLnByZXNlcnZlVGltZXN0YW1wcyAmJiBwcm9jZXNzLmFyY2ggPT09ICJpYTMyIikgewogICAgICAgICAgICBwcm9jZXNzLmVtaXRXYXJuaW5nKAogICAgICAgICAgICAgICJVc2luZyB0aGUgcHJlc2VydmVUaW1lc3RhbXBzIG9wdGlvbiBpbiAzMi1iaXQgbm9kZSBpcyBub3QgcmVjb21tZW5kZWQ7XG5cbglzZWUgaHR0cHM6Ly9naXRodWIuY29tL2pwcmljaGFyZHNvbi9ub2RlLWZzLWV4dHJhL2lzc3Vlcy8yNjkiLAogICAgICAgICAgICAgICJXYXJuaW5nIiwKICAgICAgICAgICAgICAiZnMtZXh0cmEtV0FSTjAwMDIiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB7IHNyY1N0YXQsIGRlc3RTdGF0IH0gPSBzdGF0LmNoZWNrUGF0aHNTeW5jKHNyYywgZGVzdCwgImNvcHkiLCBvcHRzKTsKICAgICAgICAgIHN0YXQuY2hlY2tQYXJlbnRQYXRoc1N5bmMoc3JjLCBzcmNTdGF0LCBkZXN0LCAiY29weSIpOwogICAgICAgICAgaWYgKG9wdHMuZmlsdGVyICYmICFvcHRzLmZpbHRlcihzcmMsIGRlc3QpKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICBjb25zdCBkZXN0UGFyZW50ID0gcGF0aDIuZGlybmFtZShkZXN0KTsKICAgICAgICAgIGlmICghZnMyLmV4aXN0c1N5bmMoZGVzdFBhcmVudCkpCiAgICAgICAgICAgIG1rZGlyc1N5bmMoZGVzdFBhcmVudCk7CiAgICAgICAgICByZXR1cm4gZ2V0U3RhdHMoZGVzdFN0YXQsIHNyYywgZGVzdCwgb3B0cyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN0YXRzKGRlc3RTdGF0LCBzcmMsIGRlc3QsIG9wdHMpIHsKICAgICAgICAgIGNvbnN0IHN0YXRTeW5jID0gb3B0cy5kZXJlZmVyZW5jZSA/IGZzMi5zdGF0U3luYyA6IGZzMi5sc3RhdFN5bmM7CiAgICAgICAgICBjb25zdCBzcmNTdGF0ID0gc3RhdFN5bmMoc3JjKTsKICAgICAgICAgIGlmIChzcmNTdGF0LmlzRGlyZWN0b3J5KCkpCiAgICAgICAgICAgIHJldHVybiBvbkRpcihzcmNTdGF0LCBkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzKTsKICAgICAgICAgIGVsc2UgaWYgKHNyY1N0YXQuaXNGaWxlKCkgfHwgc3JjU3RhdC5pc0NoYXJhY3RlckRldmljZSgpIHx8IHNyY1N0YXQuaXNCbG9ja0RldmljZSgpKQogICAgICAgICAgICByZXR1cm4gb25GaWxlKHNyY1N0YXQsIGRlc3RTdGF0LCBzcmMsIGRlc3QsIG9wdHMpOwogICAgICAgICAgZWxzZSBpZiAoc3JjU3RhdC5pc1N5bWJvbGljTGluaygpKQogICAgICAgICAgICByZXR1cm4gb25MaW5rKGRlc3RTdGF0LCBzcmMsIGRlc3QsIG9wdHMpOwogICAgICAgICAgZWxzZSBpZiAoc3JjU3RhdC5pc1NvY2tldCgpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjb3B5IGEgc29ja2V0IGZpbGU6ICR7c3JjfWApOwogICAgICAgICAgZWxzZSBpZiAoc3JjU3RhdC5pc0ZJRk8oKSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29weSBhIEZJRk8gcGlwZTogJHtzcmN9YCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gZmlsZTogJHtzcmN9YCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uRmlsZShzcmNTdGF0LCBkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzKSB7CiAgICAgICAgICBpZiAoIWRlc3RTdGF0KQogICAgICAgICAgICByZXR1cm4gY29weUZpbGUoc3JjU3RhdCwgc3JjLCBkZXN0LCBvcHRzKTsKICAgICAgICAgIHJldHVybiBtYXlDb3B5RmlsZShzcmNTdGF0LCBzcmMsIGRlc3QsIG9wdHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXlDb3B5RmlsZShzcmNTdGF0LCBzcmMsIGRlc3QsIG9wdHMpIHsKICAgICAgICAgIGlmIChvcHRzLm92ZXJ3cml0ZSkgewogICAgICAgICAgICBmczIudW5saW5rU3luYyhkZXN0KTsKICAgICAgICAgICAgcmV0dXJuIGNvcHlGaWxlKHNyY1N0YXQsIHNyYywgZGVzdCwgb3B0cyk7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuZXJyb3JPbkV4aXN0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7ZGVzdH0nIGFscmVhZHkgZXhpc3RzYCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvcHlGaWxlKHNyY1N0YXQsIHNyYywgZGVzdCwgb3B0cykgewogICAgICAgICAgZnMyLmNvcHlGaWxlU3luYyhzcmMsIGRlc3QpOwogICAgICAgICAgaWYgKG9wdHMucHJlc2VydmVUaW1lc3RhbXBzKQogICAgICAgICAgICBoYW5kbGVUaW1lc3RhbXBzKHNyY1N0YXQubW9kZSwgc3JjLCBkZXN0KTsKICAgICAgICAgIHJldHVybiBzZXREZXN0TW9kZShkZXN0LCBzcmNTdGF0Lm1vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lc3RhbXBzKHNyY01vZGUsIHNyYywgZGVzdCkgewogICAgICAgICAgaWYgKGZpbGVJc05vdFdyaXRhYmxlKHNyY01vZGUpKQogICAgICAgICAgICBtYWtlRmlsZVdyaXRhYmxlKGRlc3QsIHNyY01vZGUpOwogICAgICAgICAgcmV0dXJuIHNldERlc3RUaW1lc3RhbXBzKHNyYywgZGVzdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbGVJc05vdFdyaXRhYmxlKHNyY01vZGUpIHsKICAgICAgICAgIHJldHVybiAoc3JjTW9kZSAmIDEyOCkgPT09IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1ha2VGaWxlV3JpdGFibGUoZGVzdCwgc3JjTW9kZSkgewogICAgICAgICAgcmV0dXJuIHNldERlc3RNb2RlKGRlc3QsIHNyY01vZGUgfCAxMjgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZXN0TW9kZShkZXN0LCBzcmNNb2RlKSB7CiAgICAgICAgICByZXR1cm4gZnMyLmNobW9kU3luYyhkZXN0LCBzcmNNb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVzdFRpbWVzdGFtcHMoc3JjLCBkZXN0KSB7CiAgICAgICAgICBjb25zdCB1cGRhdGVkU3JjU3RhdCA9IGZzMi5zdGF0U3luYyhzcmMpOwogICAgICAgICAgcmV0dXJuIHV0aW1lc01pbGxpc1N5bmMoZGVzdCwgdXBkYXRlZFNyY1N0YXQuYXRpbWUsIHVwZGF0ZWRTcmNTdGF0Lm10aW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25EaXIoc3JjU3RhdCwgZGVzdFN0YXQsIHNyYywgZGVzdCwgb3B0cykgewogICAgICAgICAgaWYgKCFkZXN0U3RhdCkKICAgICAgICAgICAgcmV0dXJuIG1rRGlyQW5kQ29weShzcmNTdGF0Lm1vZGUsIHNyYywgZGVzdCwgb3B0cyk7CiAgICAgICAgICByZXR1cm4gY29weURpcihzcmMsIGRlc3QsIG9wdHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBta0RpckFuZENvcHkoc3JjTW9kZSwgc3JjLCBkZXN0LCBvcHRzKSB7CiAgICAgICAgICBmczIubWtkaXJTeW5jKGRlc3QpOwogICAgICAgICAgY29weURpcihzcmMsIGRlc3QsIG9wdHMpOwogICAgICAgICAgcmV0dXJuIHNldERlc3RNb2RlKGRlc3QsIHNyY01vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb3B5RGlyKHNyYywgZGVzdCwgb3B0cykgewogICAgICAgICAgZnMyLnJlYWRkaXJTeW5jKHNyYykuZm9yRWFjaCgoaXRlbSkgPT4gY29weURpckl0ZW0oaXRlbSwgc3JjLCBkZXN0LCBvcHRzKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvcHlEaXJJdGVtKGl0ZW0sIHNyYywgZGVzdCwgb3B0cykgewogICAgICAgICAgY29uc3Qgc3JjSXRlbSA9IHBhdGgyLmpvaW4oc3JjLCBpdGVtKTsKICAgICAgICAgIGNvbnN0IGRlc3RJdGVtID0gcGF0aDIuam9pbihkZXN0LCBpdGVtKTsKICAgICAgICAgIGlmIChvcHRzLmZpbHRlciAmJiAhb3B0cy5maWx0ZXIoc3JjSXRlbSwgZGVzdEl0ZW0pKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICBjb25zdCB7IGRlc3RTdGF0IH0gPSBzdGF0LmNoZWNrUGF0aHNTeW5jKHNyY0l0ZW0sIGRlc3RJdGVtLCAiY29weSIsIG9wdHMpOwogICAgICAgICAgcmV0dXJuIGdldFN0YXRzKGRlc3RTdGF0LCBzcmNJdGVtLCBkZXN0SXRlbSwgb3B0cyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uTGluayhkZXN0U3RhdCwgc3JjLCBkZXN0LCBvcHRzKSB7CiAgICAgICAgICBsZXQgcmVzb2x2ZWRTcmMgPSBmczIucmVhZGxpbmtTeW5jKHNyYyk7CiAgICAgICAgICBpZiAob3B0cy5kZXJlZmVyZW5jZSkgewogICAgICAgICAgICByZXNvbHZlZFNyYyA9IHBhdGgyLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgcmVzb2x2ZWRTcmMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFkZXN0U3RhdCkgewogICAgICAgICAgICByZXR1cm4gZnMyLnN5bWxpbmtTeW5jKHJlc29sdmVkU3JjLCBkZXN0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCByZXNvbHZlZERlc3Q7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWREZXN0ID0gZnMyLnJlYWRsaW5rU3luYyhkZXN0KTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSAiRUlOVkFMIiB8fCBlcnIuY29kZSA9PT0gIlVOS05PV04iKQogICAgICAgICAgICAgICAgcmV0dXJuIGZzMi5zeW1saW5rU3luYyhyZXNvbHZlZFNyYywgZGVzdCk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRzLmRlcmVmZXJlbmNlKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWREZXN0ID0gcGF0aDIucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCByZXNvbHZlZERlc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdGF0LmlzU3JjU3ViZGlyKHJlc29sdmVkU3JjLCByZXNvbHZlZERlc3QpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgY29weSAnJHtyZXNvbHZlZFNyY30nIHRvIGEgc3ViZGlyZWN0b3J5IG9mIGl0c2VsZiwgJyR7cmVzb2x2ZWREZXN0fScuYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0YXQuaXNTcmNTdWJkaXIocmVzb2x2ZWREZXN0LCByZXNvbHZlZFNyYykpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBvdmVyd3JpdGUgJyR7cmVzb2x2ZWREZXN0fScgd2l0aCAnJHtyZXNvbHZlZFNyY30nLmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3B5TGluayhyZXNvbHZlZFNyYywgZGVzdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvcHlMaW5rKHJlc29sdmVkU3JjLCBkZXN0KSB7CiAgICAgICAgICBmczIudW5saW5rU3luYyhkZXN0KTsKICAgICAgICAgIHJldHVybiBmczIuc3ltbGlua1N5bmMocmVzb2x2ZWRTcmMsIGRlc3QpOwogICAgICAgIH0KICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gY29weVN5bmM7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfY29weTIgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL2NvcHkvaW5kZXguanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgdSA9IHJlcXVpcmVfdW5pdmVyc2FsaWZ5KCkuZnJvbUNhbGxiYWNrOwogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7CiAgICAgICAgICBjb3B5OiB1KHJlcXVpcmVfY29weSgpKSwKICAgICAgICAgIGNvcHlTeW5jOiByZXF1aXJlX2NvcHlfc3luYygpCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9yZW1vdmUgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL3JlbW92ZS9pbmRleC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBmczIgPSByZXF1aXJlX2dyYWNlZnVsX2ZzKCk7CiAgICAgICAgdmFyIHUgPSByZXF1aXJlX3VuaXZlcnNhbGlmeSgpLmZyb21DYWxsYmFjazsKICAgICAgICBmdW5jdGlvbiByZW1vdmUocGF0aDIsIGNhbGxiYWNrKSB7CiAgICAgICAgICBmczIucm0ocGF0aDIsIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9LCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZVN5bmMocGF0aDIpIHsKICAgICAgICAgIGZzMi5ybVN5bmMocGF0aDIsIHsgcmVjdXJzaXZlOiB0cnVlLCBmb3JjZTogdHJ1ZSB9KTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIHJlbW92ZTogdShyZW1vdmUpLAogICAgICAgICAgcmVtb3ZlU3luYwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfZW1wdHkgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL2VtcHR5L2luZGV4LmpzIihleHBvcnRzMywgbW9kdWxlMjIpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIHUgPSByZXF1aXJlX3VuaXZlcnNhbGlmeSgpLmZyb21Qcm9taXNlOwogICAgICAgIHZhciBmczIgPSByZXF1aXJlX2ZzKCk7CiAgICAgICAgdmFyIHBhdGgyID0gcmVxdWlyZSgicGF0aCIpOwogICAgICAgIHZhciBta2RpciA9IHJlcXVpcmVfbWtkaXJzKCk7CiAgICAgICAgdmFyIHJlbW92ZSA9IHJlcXVpcmVfcmVtb3ZlKCk7CiAgICAgICAgdmFyIGVtcHR5RGlyID0gdShhc3luYyBmdW5jdGlvbiBlbXB0eURpcjIoZGlyKSB7CiAgICAgICAgICBsZXQgaXRlbXM7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpdGVtcyA9IGF3YWl0IGZzMi5yZWFkZGlyKGRpcik7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgcmV0dXJuIG1rZGlyLm1rZGlycyhkaXIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGl0ZW1zLm1hcCgoaXRlbSkgPT4gcmVtb3ZlLnJlbW92ZShwYXRoMi5qb2luKGRpciwgaXRlbSkpKSk7CiAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gZW1wdHlEaXJTeW5jKGRpcikgewogICAgICAgICAgbGV0IGl0ZW1zOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaXRlbXMgPSBmczIucmVhZGRpclN5bmMoZGlyKTsKICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICByZXR1cm4gbWtkaXIubWtkaXJzU3luYyhkaXIpOwogICAgICAgICAgfQogICAgICAgICAgaXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgICAgICBpdGVtID0gcGF0aDIuam9pbihkaXIsIGl0ZW0pOwogICAgICAgICAgICByZW1vdmUucmVtb3ZlU3luYyhpdGVtKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gewogICAgICAgICAgZW1wdHlEaXJTeW5jLAogICAgICAgICAgZW1wdHlkaXJTeW5jOiBlbXB0eURpclN5bmMsCiAgICAgICAgICBlbXB0eURpciwKICAgICAgICAgIGVtcHR5ZGlyOiBlbXB0eURpcgogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfZmlsZSA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvZW5zdXJlL2ZpbGUuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgdSA9IHJlcXVpcmVfdW5pdmVyc2FsaWZ5KCkuZnJvbUNhbGxiYWNrOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9ncmFjZWZ1bF9mcygpOwogICAgICAgIHZhciBta2RpciA9IHJlcXVpcmVfbWtkaXJzKCk7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmlsZShmaWxlLCBjYWxsYmFjaykgewogICAgICAgICAgZnVuY3Rpb24gbWFrZUZpbGUoKSB7CiAgICAgICAgICAgIGZzMi53cml0ZUZpbGUoZmlsZSwgIiIsIChlcnIpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmczIuc3RhdChmaWxlLCAoZXJyLCBzdGF0cykgPT4gewogICAgICAgICAgICBpZiAoIWVyciAmJiBzdGF0cy5pc0ZpbGUoKSkKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTsKICAgICAgICAgICAgY29uc3QgZGlyID0gcGF0aDIuZGlybmFtZShmaWxlKTsKICAgICAgICAgICAgZnMyLnN0YXQoZGlyLCAoZXJyMiwgc3RhdHMyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycjIpIHsKICAgICAgICAgICAgICAgIGlmIChlcnIyLmNvZGUgPT09ICJFTk9FTlQiKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBta2Rpci5ta2RpcnMoZGlyLCAoZXJyMykgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChlcnIzKQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycjMpOwogICAgICAgICAgICAgICAgICAgIG1ha2VGaWxlKCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc3RhdHMyLmlzRGlyZWN0b3J5KCkpCiAgICAgICAgICAgICAgICBtYWtlRmlsZSgpOwogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZnMyLnJlYWRkaXIoZGlyLCAoZXJyMykgPT4gewogICAgICAgICAgICAgICAgICBpZiAoZXJyMykKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyMyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpbGVTeW5jKGZpbGUpIHsKICAgICAgICAgIGxldCBzdGF0czsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0YXRzID0gZnMyLnN0YXRTeW5jKGZpbGUpOwogICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhdHMgJiYgc3RhdHMuaXNGaWxlKCkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIGNvbnN0IGRpciA9IHBhdGgyLmRpcm5hbWUoZmlsZSk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoIWZzMi5zdGF0U3luYyhkaXIpLmlzRGlyZWN0b3J5KCkpIHsKICAgICAgICAgICAgICBmczIucmVhZGRpclN5bmMoZGlyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUgPT09ICJFTk9FTlQiKQogICAgICAgICAgICAgIG1rZGlyLm1rZGlyc1N5bmMoZGlyKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgIH0KICAgICAgICAgIGZzMi53cml0ZUZpbGVTeW5jKGZpbGUsICIiKTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIGNyZWF0ZUZpbGU6IHUoY3JlYXRlRmlsZSksCiAgICAgICAgICBjcmVhdGVGaWxlU3luYwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfbGluayA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvZW5zdXJlL2xpbmsuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgdSA9IHJlcXVpcmVfdW5pdmVyc2FsaWZ5KCkuZnJvbUNhbGxiYWNrOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9ncmFjZWZ1bF9mcygpOwogICAgICAgIHZhciBta2RpciA9IHJlcXVpcmVfbWtkaXJzKCk7CiAgICAgICAgdmFyIHBhdGhFeGlzdHMgPSByZXF1aXJlX3BhdGhfZXhpc3RzKCkucGF0aEV4aXN0czsKICAgICAgICB2YXIgeyBhcmVJZGVudGljYWwgfSA9IHJlcXVpcmVfc3RhdCgpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUxpbmsoc3JjcGF0aCwgZHN0cGF0aCwgY2FsbGJhY2spIHsKICAgICAgICAgIGZ1bmN0aW9uIG1ha2VMaW5rKHNyY3BhdGgyLCBkc3RwYXRoMikgewogICAgICAgICAgICBmczIubGluayhzcmNwYXRoMiwgZHN0cGF0aDIsIChlcnIpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnMyLmxzdGF0KGRzdHBhdGgsIChfLCBkc3RTdGF0KSA9PiB7CiAgICAgICAgICAgIGZzMi5sc3RhdChzcmNwYXRoLCAoZXJyLCBzcmNTdGF0KSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgZXJyLm1lc3NhZ2UgPSBlcnIubWVzc2FnZS5yZXBsYWNlKCJsc3RhdCIsICJlbnN1cmVMaW5rIik7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRzdFN0YXQgJiYgYXJlSWRlbnRpY2FsKHNyY1N0YXQsIGRzdFN0YXQpKQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICAgIGNvbnN0IGRpciA9IHBhdGgyLmRpcm5hbWUoZHN0cGF0aCk7CiAgICAgICAgICAgICAgcGF0aEV4aXN0cyhkaXIsIChlcnIyLCBkaXJFeGlzdHMpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnIyKQogICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyMik7CiAgICAgICAgICAgICAgICBpZiAoZGlyRXhpc3RzKQogICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUxpbmsoc3JjcGF0aCwgZHN0cGF0aCk7CiAgICAgICAgICAgICAgICBta2Rpci5ta2RpcnMoZGlyLCAoZXJyMykgPT4gewogICAgICAgICAgICAgICAgICBpZiAoZXJyMykKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyMyk7CiAgICAgICAgICAgICAgICAgIG1ha2VMaW5rKHNyY3BhdGgsIGRzdHBhdGgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUxpbmtTeW5jKHNyY3BhdGgsIGRzdHBhdGgpIHsKICAgICAgICAgIGxldCBkc3RTdGF0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZHN0U3RhdCA9IGZzMi5sc3RhdFN5bmMoZHN0cGF0aCk7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHNyY1N0YXQgPSBmczIubHN0YXRTeW5jKHNyY3BhdGgpOwogICAgICAgICAgICBpZiAoZHN0U3RhdCAmJiBhcmVJZGVudGljYWwoc3JjU3RhdCwgZHN0U3RhdCkpCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2UucmVwbGFjZSgibHN0YXQiLCAiZW5zdXJlTGluayIpOwogICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBkaXIgPSBwYXRoMi5kaXJuYW1lKGRzdHBhdGgpOwogICAgICAgICAgY29uc3QgZGlyRXhpc3RzID0gZnMyLmV4aXN0c1N5bmMoZGlyKTsKICAgICAgICAgIGlmIChkaXJFeGlzdHMpCiAgICAgICAgICAgIHJldHVybiBmczIubGlua1N5bmMoc3JjcGF0aCwgZHN0cGF0aCk7CiAgICAgICAgICBta2Rpci5ta2RpcnNTeW5jKGRpcik7CiAgICAgICAgICByZXR1cm4gZnMyLmxpbmtTeW5jKHNyY3BhdGgsIGRzdHBhdGgpOwogICAgICAgIH0KICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gewogICAgICAgICAgY3JlYXRlTGluazogdShjcmVhdGVMaW5rKSwKICAgICAgICAgIGNyZWF0ZUxpbmtTeW5jCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9zeW1saW5rX3BhdGhzID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2ZzLWV4dHJhL2xpYi9lbnN1cmUvc3ltbGluay1wYXRocy5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9ncmFjZWZ1bF9mcygpOwogICAgICAgIHZhciBwYXRoRXhpc3RzID0gcmVxdWlyZV9wYXRoX2V4aXN0cygpLnBhdGhFeGlzdHM7CiAgICAgICAgZnVuY3Rpb24gc3ltbGlua1BhdGhzKHNyY3BhdGgsIGRzdHBhdGgsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpZiAocGF0aDIuaXNBYnNvbHV0ZShzcmNwYXRoKSkgewogICAgICAgICAgICByZXR1cm4gZnMyLmxzdGF0KHNyY3BhdGgsIChlcnIpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICBlcnIubWVzc2FnZSA9IGVyci5tZXNzYWdlLnJlcGxhY2UoImxzdGF0IiwgImVuc3VyZVN5bWxpbmsiKTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgewogICAgICAgICAgICAgICAgdG9Dd2Q6IHNyY3BhdGgsCiAgICAgICAgICAgICAgICB0b0RzdDogc3JjcGF0aAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGRzdGRpciA9IHBhdGgyLmRpcm5hbWUoZHN0cGF0aCk7CiAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlVG9Ec3QgPSBwYXRoMi5qb2luKGRzdGRpciwgc3JjcGF0aCk7CiAgICAgICAgICAgIHJldHVybiBwYXRoRXhpc3RzKHJlbGF0aXZlVG9Ec3QsIChlcnIsIGV4aXN0cykgPT4gewogICAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICBpZiAoZXhpc3RzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgewogICAgICAgICAgICAgICAgICB0b0N3ZDogcmVsYXRpdmVUb0RzdCwKICAgICAgICAgICAgICAgICAgdG9Ec3Q6IHNyY3BhdGgKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnMyLmxzdGF0KHNyY3BhdGgsIChlcnIyKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyMi5tZXNzYWdlID0gZXJyMi5tZXNzYWdlLnJlcGxhY2UoImxzdGF0IiwgImVuc3VyZVN5bWxpbmsiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHsKICAgICAgICAgICAgICAgICAgICB0b0N3ZDogc3JjcGF0aCwKICAgICAgICAgICAgICAgICAgICB0b0RzdDogcGF0aDIucmVsYXRpdmUoZHN0ZGlyLCBzcmNwYXRoKQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN5bWxpbmtQYXRoc1N5bmMoc3JjcGF0aCwgZHN0cGF0aCkgewogICAgICAgICAgbGV0IGV4aXN0czsKICAgICAgICAgIGlmIChwYXRoMi5pc0Fic29sdXRlKHNyY3BhdGgpKSB7CiAgICAgICAgICAgIGV4aXN0cyA9IGZzMi5leGlzdHNTeW5jKHNyY3BhdGgpOwogICAgICAgICAgICBpZiAoIWV4aXN0cykKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFic29sdXRlIHNyY3BhdGggZG9lcyBub3QgZXhpc3QiKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0b0N3ZDogc3JjcGF0aCwKICAgICAgICAgICAgICB0b0RzdDogc3JjcGF0aAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgZHN0ZGlyID0gcGF0aDIuZGlybmFtZShkc3RwYXRoKTsKICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVUb0RzdCA9IHBhdGgyLmpvaW4oZHN0ZGlyLCBzcmNwYXRoKTsKICAgICAgICAgICAgZXhpc3RzID0gZnMyLmV4aXN0c1N5bmMocmVsYXRpdmVUb0RzdCk7CiAgICAgICAgICAgIGlmIChleGlzdHMpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdG9Dd2Q6IHJlbGF0aXZlVG9Ec3QsCiAgICAgICAgICAgICAgICB0b0RzdDogc3JjcGF0aAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZXhpc3RzID0gZnMyLmV4aXN0c1N5bmMoc3JjcGF0aCk7CiAgICAgICAgICAgICAgaWYgKCFleGlzdHMpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInJlbGF0aXZlIHNyY3BhdGggZG9lcyBub3QgZXhpc3QiKTsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdG9Dd2Q6IHNyY3BhdGgsCiAgICAgICAgICAgICAgICB0b0RzdDogcGF0aDIucmVsYXRpdmUoZHN0ZGlyLCBzcmNwYXRoKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIHN5bWxpbmtQYXRocywKICAgICAgICAgIHN5bWxpbmtQYXRoc1N5bmMKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX3N5bWxpbmtfdHlwZSA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvZW5zdXJlL3N5bWxpbmstdHlwZS5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBmczIgPSByZXF1aXJlX2dyYWNlZnVsX2ZzKCk7CiAgICAgICAgZnVuY3Rpb24gc3ltbGlua1R5cGUoc3JjcGF0aCwgdHlwZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGNhbGxiYWNrID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlIDogY2FsbGJhY2s7CiAgICAgICAgICB0eXBlID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyBmYWxzZSA6IHR5cGU7CiAgICAgICAgICBpZiAodHlwZSkKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHR5cGUpOwogICAgICAgICAgZnMyLmxzdGF0KHNyY3BhdGgsIChlcnIsIHN0YXRzKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsICJmaWxlIik7CiAgICAgICAgICAgIHR5cGUgPSBzdGF0cyAmJiBzdGF0cy5pc0RpcmVjdG9yeSgpID8gImRpciIgOiAiZmlsZSI7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHR5cGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN5bWxpbmtUeXBlU3luYyhzcmNwYXRoLCB0eXBlKSB7CiAgICAgICAgICBsZXQgc3RhdHM7CiAgICAgICAgICBpZiAodHlwZSkKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzdGF0cyA9IGZzMi5sc3RhdFN5bmMoc3JjcGF0aCk7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgcmV0dXJuICJmaWxlIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdGF0cyAmJiBzdGF0cy5pc0RpcmVjdG9yeSgpID8gImRpciIgOiAiZmlsZSI7CiAgICAgICAgfQogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7CiAgICAgICAgICBzeW1saW5rVHlwZSwKICAgICAgICAgIHN5bWxpbmtUeXBlU3luYwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfc3ltbGluayA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvZW5zdXJlL3N5bWxpbmsuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgdSA9IHJlcXVpcmVfdW5pdmVyc2FsaWZ5KCkuZnJvbUNhbGxiYWNrOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9mcygpOwogICAgICAgIHZhciBfbWtkaXJzID0gcmVxdWlyZV9ta2RpcnMoKTsKICAgICAgICB2YXIgbWtkaXJzID0gX21rZGlycy5ta2RpcnM7CiAgICAgICAgdmFyIG1rZGlyc1N5bmMgPSBfbWtkaXJzLm1rZGlyc1N5bmM7CiAgICAgICAgdmFyIF9zeW1saW5rUGF0aHMgPSByZXF1aXJlX3N5bWxpbmtfcGF0aHMoKTsKICAgICAgICB2YXIgc3ltbGlua1BhdGhzID0gX3N5bWxpbmtQYXRocy5zeW1saW5rUGF0aHM7CiAgICAgICAgdmFyIHN5bWxpbmtQYXRoc1N5bmMgPSBfc3ltbGlua1BhdGhzLnN5bWxpbmtQYXRoc1N5bmM7CiAgICAgICAgdmFyIF9zeW1saW5rVHlwZSA9IHJlcXVpcmVfc3ltbGlua190eXBlKCk7CiAgICAgICAgdmFyIHN5bWxpbmtUeXBlID0gX3N5bWxpbmtUeXBlLnN5bWxpbmtUeXBlOwogICAgICAgIHZhciBzeW1saW5rVHlwZVN5bmMgPSBfc3ltbGlua1R5cGUuc3ltbGlua1R5cGVTeW5jOwogICAgICAgIHZhciBwYXRoRXhpc3RzID0gcmVxdWlyZV9wYXRoX2V4aXN0cygpLnBhdGhFeGlzdHM7CiAgICAgICAgdmFyIHsgYXJlSWRlbnRpY2FsIH0gPSByZXF1aXJlX3N0YXQoKTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVTeW1saW5rKHNyY3BhdGgsIGRzdHBhdGgsIHR5cGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICBjYWxsYmFjayA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZSA6IGNhbGxiYWNrOwogICAgICAgICAgdHlwZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gZmFsc2UgOiB0eXBlOwogICAgICAgICAgZnMyLmxzdGF0KGRzdHBhdGgsIChlcnIsIHN0YXRzKSA9PiB7CiAgICAgICAgICAgIGlmICghZXJyICYmIHN0YXRzLmlzU3ltYm9saWNMaW5rKCkpIHsKICAgICAgICAgICAgICBQcm9taXNlLmFsbChbCiAgICAgICAgICAgICAgICBmczIuc3RhdChzcmNwYXRoKSwKICAgICAgICAgICAgICAgIGZzMi5zdGF0KGRzdHBhdGgpCiAgICAgICAgICAgICAgXSkudGhlbigoW3NyY1N0YXQsIGRzdFN0YXRdKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYXJlSWRlbnRpY2FsKHNyY1N0YXQsIGRzdFN0YXQpKQogICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCk7CiAgICAgICAgICAgICAgICBfY3JlYXRlU3ltbGluayhzcmNwYXRoLCBkc3RwYXRoLCB0eXBlLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgIF9jcmVhdGVTeW1saW5rKHNyY3BhdGgsIGRzdHBhdGgsIHR5cGUsIGNhbGxiYWNrKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBfY3JlYXRlU3ltbGluayhzcmNwYXRoLCBkc3RwYXRoLCB0eXBlLCBjYWxsYmFjaykgewogICAgICAgICAgc3ltbGlua1BhdGhzKHNyY3BhdGgsIGRzdHBhdGgsIChlcnIsIHJlbGF0aXZlKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIHNyY3BhdGggPSByZWxhdGl2ZS50b0RzdDsKICAgICAgICAgICAgc3ltbGlua1R5cGUocmVsYXRpdmUudG9Dd2QsIHR5cGUsIChlcnIyLCB0eXBlMikgPT4gewogICAgICAgICAgICAgIGlmIChlcnIyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycjIpOwogICAgICAgICAgICAgIGNvbnN0IGRpciA9IHBhdGgyLmRpcm5hbWUoZHN0cGF0aCk7CiAgICAgICAgICAgICAgcGF0aEV4aXN0cyhkaXIsIChlcnIzLCBkaXJFeGlzdHMpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnIzKQogICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyMyk7CiAgICAgICAgICAgICAgICBpZiAoZGlyRXhpc3RzKQogICAgICAgICAgICAgICAgICByZXR1cm4gZnMyLnN5bWxpbmsoc3JjcGF0aCwgZHN0cGF0aCwgdHlwZTIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIG1rZGlycyhkaXIsIChlcnI0KSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnI0KQogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnI0KTsKICAgICAgICAgICAgICAgICAgZnMyLnN5bWxpbmsoc3JjcGF0aCwgZHN0cGF0aCwgdHlwZTIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVTeW1saW5rU3luYyhzcmNwYXRoLCBkc3RwYXRoLCB0eXBlKSB7CiAgICAgICAgICBsZXQgc3RhdHM7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzdGF0cyA9IGZzMi5sc3RhdFN5bmMoZHN0cGF0aCk7CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGF0cyAmJiBzdGF0cy5pc1N5bWJvbGljTGluaygpKSB7CiAgICAgICAgICAgIGNvbnN0IHNyY1N0YXQgPSBmczIuc3RhdFN5bmMoc3JjcGF0aCk7CiAgICAgICAgICAgIGNvbnN0IGRzdFN0YXQgPSBmczIuc3RhdFN5bmMoZHN0cGF0aCk7CiAgICAgICAgICAgIGlmIChhcmVJZGVudGljYWwoc3JjU3RhdCwgZHN0U3RhdCkpCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVsYXRpdmUgPSBzeW1saW5rUGF0aHNTeW5jKHNyY3BhdGgsIGRzdHBhdGgpOwogICAgICAgICAgc3JjcGF0aCA9IHJlbGF0aXZlLnRvRHN0OwogICAgICAgICAgdHlwZSA9IHN5bWxpbmtUeXBlU3luYyhyZWxhdGl2ZS50b0N3ZCwgdHlwZSk7CiAgICAgICAgICBjb25zdCBkaXIgPSBwYXRoMi5kaXJuYW1lKGRzdHBhdGgpOwogICAgICAgICAgY29uc3QgZXhpc3RzID0gZnMyLmV4aXN0c1N5bmMoZGlyKTsKICAgICAgICAgIGlmIChleGlzdHMpCiAgICAgICAgICAgIHJldHVybiBmczIuc3ltbGlua1N5bmMoc3JjcGF0aCwgZHN0cGF0aCwgdHlwZSk7CiAgICAgICAgICBta2RpcnNTeW5jKGRpcik7CiAgICAgICAgICByZXR1cm4gZnMyLnN5bWxpbmtTeW5jKHNyY3BhdGgsIGRzdHBhdGgsIHR5cGUpOwogICAgICAgIH0KICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gewogICAgICAgICAgY3JlYXRlU3ltbGluazogdShjcmVhdGVTeW1saW5rKSwKICAgICAgICAgIGNyZWF0ZVN5bWxpbmtTeW5jCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9lbnN1cmUgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL2Vuc3VyZS9pbmRleC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciB7IGNyZWF0ZUZpbGUsIGNyZWF0ZUZpbGVTeW5jIH0gPSByZXF1aXJlX2ZpbGUoKTsKICAgICAgICB2YXIgeyBjcmVhdGVMaW5rLCBjcmVhdGVMaW5rU3luYyB9ID0gcmVxdWlyZV9saW5rKCk7CiAgICAgICAgdmFyIHsgY3JlYXRlU3ltbGluaywgY3JlYXRlU3ltbGlua1N5bmMgfSA9IHJlcXVpcmVfc3ltbGluaygpOwogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7CiAgICAgICAgICAvLyBmaWxlCiAgICAgICAgICBjcmVhdGVGaWxlLAogICAgICAgICAgY3JlYXRlRmlsZVN5bmMsCiAgICAgICAgICBlbnN1cmVGaWxlOiBjcmVhdGVGaWxlLAogICAgICAgICAgZW5zdXJlRmlsZVN5bmM6IGNyZWF0ZUZpbGVTeW5jLAogICAgICAgICAgLy8gbGluawogICAgICAgICAgY3JlYXRlTGluaywKICAgICAgICAgIGNyZWF0ZUxpbmtTeW5jLAogICAgICAgICAgZW5zdXJlTGluazogY3JlYXRlTGluaywKICAgICAgICAgIGVuc3VyZUxpbmtTeW5jOiBjcmVhdGVMaW5rU3luYywKICAgICAgICAgIC8vIHN5bWxpbmsKICAgICAgICAgIGNyZWF0ZVN5bWxpbmssCiAgICAgICAgICBjcmVhdGVTeW1saW5rU3luYywKICAgICAgICAgIGVuc3VyZVN5bWxpbms6IGNyZWF0ZVN5bWxpbmssCiAgICAgICAgICBlbnN1cmVTeW1saW5rU3luYzogY3JlYXRlU3ltbGlua1N5bmMKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX3V0aWxzMiA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9qc29uZmlsZS91dGlscy5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgZnVuY3Rpb24gc3RyaW5naWZ5KG9iaiwgeyBFT0wgPSAiXG4iLCBmaW5hbEVPTCA9IHRydWUsIHJlcGxhY2VyID0gbnVsbCwgc3BhY2VzIH0gPSB7fSkgewogICAgICAgICAgY29uc3QgRU9GID0gZmluYWxFT0wgPyBFT0wgOiAiIjsKICAgICAgICAgIGNvbnN0IHN0cjMgPSBKU09OLnN0cmluZ2lmeShvYmosIHJlcGxhY2VyLCBzcGFjZXMpOwogICAgICAgICAgcmV0dXJuIHN0cjMucmVwbGFjZSgvXG4vZywgRU9MKSArIEVPRjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RyaXBCb20oY29udGVudCkgewogICAgICAgICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjb250ZW50KSkKICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQudG9TdHJpbmcoInV0ZjgiKTsKICAgICAgICAgIHJldHVybiBjb250ZW50LnJlcGxhY2UoL15cdUZFRkYvLCAiIik7CiAgICAgICAgfQogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7IHN0cmluZ2lmeSwgc3RyaXBCb20gfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9qc29uZmlsZSA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9qc29uZmlsZS9pbmRleC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgdmFyIF9mczsKICAgICAgICB0cnkgewogICAgICAgICAgX2ZzID0gcmVxdWlyZV9ncmFjZWZ1bF9mcygpOwogICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgIF9mcyA9IHJlcXVpcmUoImZzIik7CiAgICAgICAgfQogICAgICAgIHZhciB1bml2ZXJzYWxpZnkgPSByZXF1aXJlX3VuaXZlcnNhbGlmeSgpOwogICAgICAgIHZhciB7IHN0cmluZ2lmeSwgc3RyaXBCb20gfSA9IHJlcXVpcmVfdXRpbHMyKCk7CiAgICAgICAgYXN5bmMgZnVuY3Rpb24gX3JlYWRGaWxlKGZpbGUsIG9wdGlvbnMgPSB7fSkgewogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIikgewogICAgICAgICAgICBvcHRpb25zID0geyBlbmNvZGluZzogb3B0aW9ucyB9OwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZnMyID0gb3B0aW9ucy5mcyB8fCBfZnM7CiAgICAgICAgICBjb25zdCBzaG91bGRUaHJvdyA9ICJ0aHJvd3MiIGluIG9wdGlvbnMgPyBvcHRpb25zLnRocm93cyA6IHRydWU7CiAgICAgICAgICBsZXQgZGF0YSA9IGF3YWl0IHVuaXZlcnNhbGlmeS5mcm9tQ2FsbGJhY2soZnMyLnJlYWRGaWxlKShmaWxlLCBvcHRpb25zKTsKICAgICAgICAgIGRhdGEgPSBzdHJpcEJvbShkYXRhKTsKICAgICAgICAgIGxldCBvYmo7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBvYmogPSBKU09OLnBhcnNlKGRhdGEsIG9wdGlvbnMgPyBvcHRpb25zLnJldml2ZXIgOiBudWxsKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBpZiAoc2hvdWxkVGhyb3cpIHsKICAgICAgICAgICAgICBlcnIubWVzc2FnZSA9IGAke2ZpbGV9OiAke2Vyci5tZXNzYWdlfWA7CiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0KICAgICAgICB2YXIgcmVhZEZpbGUgPSB1bml2ZXJzYWxpZnkuZnJvbVByb21pc2UoX3JlYWRGaWxlKTsKICAgICAgICBmdW5jdGlvbiByZWFkRmlsZVN5bmMoZmlsZSwgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIG9wdGlvbnMgPSB7IGVuY29kaW5nOiBvcHRpb25zIH07CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBmczIgPSBvcHRpb25zLmZzIHx8IF9mczsKICAgICAgICAgIGNvbnN0IHNob3VsZFRocm93ID0gInRocm93cyIgaW4gb3B0aW9ucyA/IG9wdGlvbnMudGhyb3dzIDogdHJ1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxldCBjb250ZW50ID0gZnMyLnJlYWRGaWxlU3luYyhmaWxlLCBvcHRpb25zKTsKICAgICAgICAgICAgY29udGVudCA9IHN0cmlwQm9tKGNvbnRlbnQpOwogICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShjb250ZW50LCBvcHRpb25zLnJldml2ZXIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRUaHJvdykgewogICAgICAgICAgICAgIGVyci5tZXNzYWdlID0gYCR7ZmlsZX06ICR7ZXJyLm1lc3NhZ2V9YDsKICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXN5bmMgZnVuY3Rpb24gX3dyaXRlRmlsZShmaWxlLCBvYmosIG9wdGlvbnMgPSB7fSkgewogICAgICAgICAgY29uc3QgZnMyID0gb3B0aW9ucy5mcyB8fCBfZnM7CiAgICAgICAgICBjb25zdCBzdHIzID0gc3RyaW5naWZ5KG9iaiwgb3B0aW9ucyk7CiAgICAgICAgICBhd2FpdCB1bml2ZXJzYWxpZnkuZnJvbUNhbGxiYWNrKGZzMi53cml0ZUZpbGUpKGZpbGUsIHN0cjMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB2YXIgd3JpdGVGaWxlID0gdW5pdmVyc2FsaWZ5LmZyb21Qcm9taXNlKF93cml0ZUZpbGUpOwogICAgICAgIGZ1bmN0aW9uIHdyaXRlRmlsZVN5bmMoZmlsZSwgb2JqLCBvcHRpb25zID0ge30pIHsKICAgICAgICAgIGNvbnN0IGZzMiA9IG9wdGlvbnMuZnMgfHwgX2ZzOwogICAgICAgICAgY29uc3Qgc3RyMyA9IHN0cmluZ2lmeShvYmosIG9wdGlvbnMpOwogICAgICAgICAgcmV0dXJuIGZzMi53cml0ZUZpbGVTeW5jKGZpbGUsIHN0cjMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB2YXIganNvbmZpbGUgPSB7CiAgICAgICAgICByZWFkRmlsZSwKICAgICAgICAgIHJlYWRGaWxlU3luYywKICAgICAgICAgIHdyaXRlRmlsZSwKICAgICAgICAgIHdyaXRlRmlsZVN5bmMKICAgICAgICB9OwogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSBqc29uZmlsZTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9qc29uZmlsZTIgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL2pzb24vanNvbmZpbGUuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIganNvbkZpbGUgPSByZXF1aXJlX2pzb25maWxlKCk7CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIC8vIGpzb25maWxlIGV4cG9ydHMKICAgICAgICAgIHJlYWRKc29uOiBqc29uRmlsZS5yZWFkRmlsZSwKICAgICAgICAgIHJlYWRKc29uU3luYzoganNvbkZpbGUucmVhZEZpbGVTeW5jLAogICAgICAgICAgd3JpdGVKc29uOiBqc29uRmlsZS53cml0ZUZpbGUsCiAgICAgICAgICB3cml0ZUpzb25TeW5jOiBqc29uRmlsZS53cml0ZUZpbGVTeW5jCiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV9vdXRwdXRfZmlsZSA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvb3V0cHV0LWZpbGUvaW5kZXguanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgdSA9IHJlcXVpcmVfdW5pdmVyc2FsaWZ5KCkuZnJvbUNhbGxiYWNrOwogICAgICAgIHZhciBmczIgPSByZXF1aXJlX2dyYWNlZnVsX2ZzKCk7CiAgICAgICAgdmFyIHBhdGgyID0gcmVxdWlyZSgicGF0aCIpOwogICAgICAgIHZhciBta2RpciA9IHJlcXVpcmVfbWtkaXJzKCk7CiAgICAgICAgdmFyIHBhdGhFeGlzdHMgPSByZXF1aXJlX3BhdGhfZXhpc3RzKCkucGF0aEV4aXN0czsKICAgICAgICBmdW5jdGlvbiBvdXRwdXRGaWxlKGZpbGUsIGRhdGEsIGVuY29kaW5nLCBjYWxsYmFjaykgewogICAgICAgICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBjYWxsYmFjayA9IGVuY29kaW5nOwogICAgICAgICAgICBlbmNvZGluZyA9ICJ1dGY4IjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGRpciA9IHBhdGgyLmRpcm5hbWUoZmlsZSk7CiAgICAgICAgICBwYXRoRXhpc3RzKGRpciwgKGVyciwgaXREb2VzKSA9PiB7CiAgICAgICAgICAgIGlmIChlcnIpCiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIGlmIChpdERvZXMpCiAgICAgICAgICAgICAgcmV0dXJuIGZzMi53cml0ZUZpbGUoZmlsZSwgZGF0YSwgZW5jb2RpbmcsIGNhbGxiYWNrKTsKICAgICAgICAgICAgbWtkaXIubWtkaXJzKGRpciwgKGVycjIpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyMikKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIyKTsKICAgICAgICAgICAgICBmczIud3JpdGVGaWxlKGZpbGUsIGRhdGEsIGVuY29kaW5nLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG91dHB1dEZpbGVTeW5jKGZpbGUsIC4uLmFyZ3MpIHsKICAgICAgICAgIGNvbnN0IGRpciA9IHBhdGgyLmRpcm5hbWUoZmlsZSk7CiAgICAgICAgICBpZiAoZnMyLmV4aXN0c1N5bmMoZGlyKSkgewogICAgICAgICAgICByZXR1cm4gZnMyLndyaXRlRmlsZVN5bmMoZmlsZSwgLi4uYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICBta2Rpci5ta2RpcnNTeW5jKGRpcik7CiAgICAgICAgICBmczIud3JpdGVGaWxlU3luYyhmaWxlLCAuLi5hcmdzKTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IHsKICAgICAgICAgIG91dHB1dEZpbGU6IHUob3V0cHV0RmlsZSksCiAgICAgICAgICBvdXRwdXRGaWxlU3luYwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfb3V0cHV0X2pzb24gPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZnMtZXh0cmEvbGliL2pzb24vb3V0cHV0LWpzb24uanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgeyBzdHJpbmdpZnkgfSA9IHJlcXVpcmVfdXRpbHMyKCk7CiAgICAgICAgdmFyIHsgb3V0cHV0RmlsZSB9ID0gcmVxdWlyZV9vdXRwdXRfZmlsZSgpOwogICAgICAgIGFzeW5jIGZ1bmN0aW9uIG91dHB1dEpzb24oZmlsZSwgZGF0YSwgb3B0aW9ucyA9IHt9KSB7CiAgICAgICAgICBjb25zdCBzdHIzID0gc3RyaW5naWZ5KGRhdGEsIG9wdGlvbnMpOwogICAgICAgICAgYXdhaXQgb3V0cHV0RmlsZShmaWxlLCBzdHIzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IG91dHB1dEpzb247CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfb3V0cHV0X2pzb25fc3luYyA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvanNvbi9vdXRwdXQtanNvbi1zeW5jLmpzIihleHBvcnRzMywgbW9kdWxlMjIpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIHsgc3RyaW5naWZ5IH0gPSByZXF1aXJlX3V0aWxzMigpOwogICAgICAgIHZhciB7IG91dHB1dEZpbGVTeW5jIH0gPSByZXF1aXJlX291dHB1dF9maWxlKCk7CiAgICAgICAgZnVuY3Rpb24gb3V0cHV0SnNvblN5bmMoZmlsZSwgZGF0YSwgb3B0aW9ucykgewogICAgICAgICAgY29uc3Qgc3RyMyA9IHN0cmluZ2lmeShkYXRhLCBvcHRpb25zKTsKICAgICAgICAgIG91dHB1dEZpbGVTeW5jKGZpbGUsIHN0cjMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gb3V0cHV0SnNvblN5bmM7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfanNvbiA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvanNvbi9pbmRleC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciB1ID0gcmVxdWlyZV91bml2ZXJzYWxpZnkoKS5mcm9tUHJvbWlzZTsKICAgICAgICB2YXIganNvbkZpbGUgPSByZXF1aXJlX2pzb25maWxlMigpOwogICAgICAgIGpzb25GaWxlLm91dHB1dEpzb24gPSB1KHJlcXVpcmVfb3V0cHV0X2pzb24oKSk7CiAgICAgICAganNvbkZpbGUub3V0cHV0SnNvblN5bmMgPSByZXF1aXJlX291dHB1dF9qc29uX3N5bmMoKTsKICAgICAgICBqc29uRmlsZS5vdXRwdXRKU09OID0ganNvbkZpbGUub3V0cHV0SnNvbjsKICAgICAgICBqc29uRmlsZS5vdXRwdXRKU09OU3luYyA9IGpzb25GaWxlLm91dHB1dEpzb25TeW5jOwogICAgICAgIGpzb25GaWxlLndyaXRlSlNPTiA9IGpzb25GaWxlLndyaXRlSnNvbjsKICAgICAgICBqc29uRmlsZS53cml0ZUpTT05TeW5jID0ganNvbkZpbGUud3JpdGVKc29uU3luYzsKICAgICAgICBqc29uRmlsZS5yZWFkSlNPTiA9IGpzb25GaWxlLnJlYWRKc29uOwogICAgICAgIGpzb25GaWxlLnJlYWRKU09OU3luYyA9IGpzb25GaWxlLnJlYWRKc29uU3luYzsKICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0ganNvbkZpbGU7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfbW92ZSA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvbW92ZS9tb3ZlLmpzIihleHBvcnRzMywgbW9kdWxlMjIpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIGZzMiA9IHJlcXVpcmVfZ3JhY2VmdWxfZnMoKTsKICAgICAgICB2YXIgcGF0aDIgPSByZXF1aXJlKCJwYXRoIik7CiAgICAgICAgdmFyIGNvcHkgPSByZXF1aXJlX2NvcHkyKCkuY29weTsKICAgICAgICB2YXIgcmVtb3ZlID0gcmVxdWlyZV9yZW1vdmUoKS5yZW1vdmU7CiAgICAgICAgdmFyIG1rZGlycCA9IHJlcXVpcmVfbWtkaXJzKCkubWtkaXJwOwogICAgICAgIHZhciBwYXRoRXhpc3RzID0gcmVxdWlyZV9wYXRoX2V4aXN0cygpLnBhdGhFeGlzdHM7CiAgICAgICAgdmFyIHN0YXQgPSByZXF1aXJlX3N0YXQoKTsKICAgICAgICBmdW5jdGlvbiBtb3ZlKHNyYywgZGVzdCwgb3B0cywgY2IpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBjYiA9IG9wdHM7CiAgICAgICAgICAgIG9wdHMgPSB7fTsKICAgICAgICAgIH0KICAgICAgICAgIG9wdHMgPSBvcHRzIHx8IHt9OwogICAgICAgICAgY29uc3Qgb3ZlcndyaXRlID0gb3B0cy5vdmVyd3JpdGUgfHwgb3B0cy5jbG9iYmVyIHx8IGZhbHNlOwogICAgICAgICAgc3RhdC5jaGVja1BhdGhzKHNyYywgZGVzdCwgIm1vdmUiLCBvcHRzLCAoZXJyLCBzdGF0cykgPT4gewogICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYihlcnIpOwogICAgICAgICAgICBjb25zdCB7IHNyY1N0YXQsIGlzQ2hhbmdpbmdDYXNlID0gZmFsc2UgfSA9IHN0YXRzOwogICAgICAgICAgICBzdGF0LmNoZWNrUGFyZW50UGF0aHMoc3JjLCBzcmNTdGF0LCBkZXN0LCAibW92ZSIsIChlcnIyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGVycjIpCiAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyMik7CiAgICAgICAgICAgICAgaWYgKGlzUGFyZW50Um9vdChkZXN0KSkKICAgICAgICAgICAgICAgIHJldHVybiBkb1JlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSwgaXNDaGFuZ2luZ0Nhc2UsIGNiKTsKICAgICAgICAgICAgICBta2RpcnAocGF0aDIuZGlybmFtZShkZXN0KSwgKGVycjMpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlcnIzKQogICAgICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyMyk7CiAgICAgICAgICAgICAgICByZXR1cm4gZG9SZW5hbWUoc3JjLCBkZXN0LCBvdmVyd3JpdGUsIGlzQ2hhbmdpbmdDYXNlLCBjYik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUGFyZW50Um9vdChkZXN0KSB7CiAgICAgICAgICBjb25zdCBwYXJlbnQgPSBwYXRoMi5kaXJuYW1lKGRlc3QpOwogICAgICAgICAgY29uc3QgcGFyc2VkUGF0aCA9IHBhdGgyLnBhcnNlKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gcGFyc2VkUGF0aC5yb290ID09PSBwYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRvUmVuYW1lKHNyYywgZGVzdCwgb3ZlcndyaXRlLCBpc0NoYW5naW5nQ2FzZSwgY2IpIHsKICAgICAgICAgIGlmIChpc0NoYW5naW5nQ2FzZSkKICAgICAgICAgICAgcmV0dXJuIHJlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSwgY2IpOwogICAgICAgICAgaWYgKG92ZXJ3cml0ZSkgewogICAgICAgICAgICByZXR1cm4gcmVtb3ZlKGRlc3QsIChlcnIpID0+IHsKICAgICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSwgY2IpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHBhdGhFeGlzdHMoZGVzdCwgKGVyciwgZGVzdEV4aXN0cykgPT4gewogICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYihlcnIpOwogICAgICAgICAgICBpZiAoZGVzdEV4aXN0cykKICAgICAgICAgICAgICByZXR1cm4gY2IobmV3IEVycm9yKCJkZXN0IGFscmVhZHkgZXhpc3RzLiIpKTsKICAgICAgICAgICAgcmV0dXJuIHJlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSwgY2IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSwgY2IpIHsKICAgICAgICAgIGZzMi5yZW5hbWUoc3JjLCBkZXN0LCAoZXJyKSA9PiB7CiAgICAgICAgICAgIGlmICghZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYigpOwogICAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICJFWERFViIpCiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7CiAgICAgICAgICAgIHJldHVybiBtb3ZlQWNyb3NzRGV2aWNlKHNyYywgZGVzdCwgb3ZlcndyaXRlLCBjYik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZUFjcm9zc0RldmljZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSwgY2IpIHsKICAgICAgICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgICAgICAgIG92ZXJ3cml0ZSwKICAgICAgICAgICAgZXJyb3JPbkV4aXN0OiB0cnVlLAogICAgICAgICAgICBwcmVzZXJ2ZVRpbWVzdGFtcHM6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICBjb3B5KHNyYywgZGVzdCwgb3B0cywgKGVycikgPT4gewogICAgICAgICAgICBpZiAoZXJyKQogICAgICAgICAgICAgIHJldHVybiBjYihlcnIpOwogICAgICAgICAgICByZXR1cm4gcmVtb3ZlKHNyYywgY2IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSBtb3ZlOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX21vdmVfc3luYyA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9mcy1leHRyYS9saWIvbW92ZS9tb3ZlLXN5bmMuanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgZnMyID0gcmVxdWlyZV9ncmFjZWZ1bF9mcygpOwogICAgICAgIHZhciBwYXRoMiA9IHJlcXVpcmUoInBhdGgiKTsKICAgICAgICB2YXIgY29weVN5bmMgPSByZXF1aXJlX2NvcHkyKCkuY29weVN5bmM7CiAgICAgICAgdmFyIHJlbW92ZVN5bmMgPSByZXF1aXJlX3JlbW92ZSgpLnJlbW92ZVN5bmM7CiAgICAgICAgdmFyIG1rZGlycFN5bmMgPSByZXF1aXJlX21rZGlycygpLm1rZGlycFN5bmM7CiAgICAgICAgdmFyIHN0YXQgPSByZXF1aXJlX3N0YXQoKTsKICAgICAgICBmdW5jdGlvbiBtb3ZlU3luYyhzcmMsIGRlc3QsIG9wdHMpIHsKICAgICAgICAgIG9wdHMgPSBvcHRzIHx8IHt9OwogICAgICAgICAgY29uc3Qgb3ZlcndyaXRlID0gb3B0cy5vdmVyd3JpdGUgfHwgb3B0cy5jbG9iYmVyIHx8IGZhbHNlOwogICAgICAgICAgY29uc3QgeyBzcmNTdGF0LCBpc0NoYW5naW5nQ2FzZSA9IGZhbHNlIH0gPSBzdGF0LmNoZWNrUGF0aHNTeW5jKHNyYywgZGVzdCwgIm1vdmUiLCBvcHRzKTsKICAgICAgICAgIHN0YXQuY2hlY2tQYXJlbnRQYXRoc1N5bmMoc3JjLCBzcmNTdGF0LCBkZXN0LCAibW92ZSIpOwogICAgICAgICAgaWYgKCFpc1BhcmVudFJvb3QoZGVzdCkpCiAgICAgICAgICAgIG1rZGlycFN5bmMocGF0aDIuZGlybmFtZShkZXN0KSk7CiAgICAgICAgICByZXR1cm4gZG9SZW5hbWUoc3JjLCBkZXN0LCBvdmVyd3JpdGUsIGlzQ2hhbmdpbmdDYXNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNQYXJlbnRSb290KGRlc3QpIHsKICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHBhdGgyLmRpcm5hbWUoZGVzdCk7CiAgICAgICAgICBjb25zdCBwYXJzZWRQYXRoID0gcGF0aDIucGFyc2UocGFyZW50KTsKICAgICAgICAgIHJldHVybiBwYXJzZWRQYXRoLnJvb3QgPT09IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZG9SZW5hbWUoc3JjLCBkZXN0LCBvdmVyd3JpdGUsIGlzQ2hhbmdpbmdDYXNlKSB7CiAgICAgICAgICBpZiAoaXNDaGFuZ2luZ0Nhc2UpCiAgICAgICAgICAgIHJldHVybiByZW5hbWUoc3JjLCBkZXN0LCBvdmVyd3JpdGUpOwogICAgICAgICAgaWYgKG92ZXJ3cml0ZSkgewogICAgICAgICAgICByZW1vdmVTeW5jKGRlc3QpOwogICAgICAgICAgICByZXR1cm4gcmVuYW1lKHNyYywgZGVzdCwgb3ZlcndyaXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmczIuZXhpc3RzU3luYyhkZXN0KSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZXN0IGFscmVhZHkgZXhpc3RzLiIpOwogICAgICAgICAgcmV0dXJuIHJlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmFtZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZnMyLnJlbmFtZVN5bmMoc3JjLCBkZXN0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICJFWERFViIpCiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICByZXR1cm4gbW92ZUFjcm9zc0RldmljZShzcmMsIGRlc3QsIG92ZXJ3cml0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdmVBY3Jvc3NEZXZpY2Uoc3JjLCBkZXN0LCBvdmVyd3JpdGUpIHsKICAgICAgICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgICAgICAgIG92ZXJ3cml0ZSwKICAgICAgICAgICAgZXJyb3JPbkV4aXN0OiB0cnVlLAogICAgICAgICAgICBwcmVzZXJ2ZVRpbWVzdGFtcHM6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICBjb3B5U3luYyhzcmMsIGRlc3QsIG9wdHMpOwogICAgICAgICAgcmV0dXJuIHJlbW92ZVN5bmMoc3JjKTsKICAgICAgICB9CiAgICAgICAgbW9kdWxlMjIuZXhwb3J0cyA9IG1vdmVTeW5jOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX21vdmUyID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2ZzLWV4dHJhL2xpYi9tb3ZlL2luZGV4LmpzIihleHBvcnRzMywgbW9kdWxlMjIpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIHUgPSByZXF1aXJlX3VuaXZlcnNhbGlmeSgpLmZyb21DYWxsYmFjazsKICAgICAgICBtb2R1bGUyMi5leHBvcnRzID0gewogICAgICAgICAgbW92ZTogdShyZXF1aXJlX21vdmUoKSksCiAgICAgICAgICBtb3ZlU3luYzogcmVxdWlyZV9tb3ZlX3N5bmMoKQogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfbGliID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2ZzLWV4dHJhL2xpYi9pbmRleC5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIG1vZHVsZTIyLmV4cG9ydHMgPSB7CiAgICAgICAgICAvLyBFeHBvcnQgcHJvbWlzZWlmaWVkIGdyYWNlZnVsLWZzOgogICAgICAgICAgLi4ucmVxdWlyZV9mcygpLAogICAgICAgICAgLy8gRXhwb3J0IGV4dHJhIG1ldGhvZHM6CiAgICAgICAgICAuLi5yZXF1aXJlX2NvcHkyKCksCiAgICAgICAgICAuLi5yZXF1aXJlX2VtcHR5KCksCiAgICAgICAgICAuLi5yZXF1aXJlX2Vuc3VyZSgpLAogICAgICAgICAgLi4ucmVxdWlyZV9qc29uKCksCiAgICAgICAgICAuLi5yZXF1aXJlX21rZGlycygpLAogICAgICAgICAgLi4ucmVxdWlyZV9tb3ZlMigpLAogICAgICAgICAgLi4ucmVxdWlyZV9vdXRwdXRfZmlsZSgpLAogICAgICAgICAgLi4ucmVxdWlyZV9wYXRoX2V4aXN0cygpLAogICAgICAgICAgLi4ucmVxdWlyZV9yZW1vdmUoKQogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcXVpcmVfYXJjc2Vjb25kID0gX19jb21tb25KUzIoewogICAgICAiLi4vLi4vbm9kZV9tb2R1bGVzL2FyY3NlY29uZC9pbmRleC5qcyIoZXhwb3J0czMpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgICAgICAgdmFyIHRleHQ7CiAgICAgICAgaWYgKHR5cGVvZiBUZXh0RW5jb2RlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHRleHQgPSB7IEVuY29kZXI6IFRleHRFbmNvZGVyLCBEZWNvZGVyOiBUZXh0RGVjb2RlciB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCB1dGlsMiA9IHJlcXVpcmUoInV0aWwiKTsKICAgICAgICAgICAgdGV4dCA9IHsgRW5jb2RlcjogdXRpbDIuVGV4dEVuY29kZXIsIERlY29kZXI6IHV0aWwyLlRleHREZWNvZGVyIH07CiAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyY3NlY29uZCByZXF1aXJlcyBUZXh0RW5jb2RlciBhbmQgVGV4dERlY29kZXIgdG8gYmUgcG9seWZpbGxlZC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGVuY29kZXIgPSBuZXcgdGV4dC5FbmNvZGVyKCk7CiAgICAgICAgdmFyIGRlY29kZXIgPSBuZXcgdGV4dC5EZWNvZGVyKCk7CiAgICAgICAgdmFyIGdldFN0cmluZyA9IChpbmRleCwgbGVuZ3RoLCBkYXRhVmlldykgPT4gewogICAgICAgICAgY29uc3QgYnl0ZXMgPSBVaW50OEFycmF5LmZyb20oeyBsZW5ndGggfSwgKF8sIGkpID0+IGRhdGFWaWV3LmdldFVpbnQ4KGluZGV4ICsgaSkpOwogICAgICAgICAgY29uc3QgZGVjb2RlZFN0cmluZyA9IGRlY29kZXIuZGVjb2RlKGJ5dGVzKTsKICAgICAgICAgIHJldHVybiBkZWNvZGVkU3RyaW5nOwogICAgICAgIH07CiAgICAgICAgdmFyIGdldE5leHRDaGFyV2lkdGggPSAoaW5kZXgsIGRhdGFWaWV3KSA9PiB7CiAgICAgICAgICBjb25zdCBieXRlID0gZGF0YVZpZXcuZ2V0VWludDgoaW5kZXgpOwogICAgICAgICAgaWYgKChieXRlICYgMTI4KSA+PiA3ID09PSAwKQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIGVsc2UgaWYgKChieXRlICYgMjI0KSA+PiA1ID09PSA2KQogICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgIGVsc2UgaWYgKChieXRlICYgMjQwKSA+PiA0ID09PSAxNCkKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICBlbHNlIGlmICgoYnl0ZSAmIDI0MCkgPj4gNCA9PT0gMTUpCiAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfTsKICAgICAgICB2YXIgZ2V0VXRmOENoYXIgPSAoaW5kZXgsIGxlbmd0aCwgZGF0YVZpZXcpID0+IHsKICAgICAgICAgIGNvbnN0IGJ5dGVzID0gVWludDhBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIChfLCBpKSA9PiBkYXRhVmlldy5nZXRVaW50OChpbmRleCArIGkpKTsKICAgICAgICAgIHJldHVybiBkZWNvZGVyLmRlY29kZShieXRlcyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZ2V0Q2hhcmFjdGVyTGVuZ3RoID0gKHN0cjQpID0+IHsKICAgICAgICAgIGxldCBjcDsKICAgICAgICAgIGxldCB0b3RhbCA9IDA7CiAgICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgICB3aGlsZSAoaSA8IHN0cjQubGVuZ3RoKSB7CiAgICAgICAgICAgIGNwID0gc3RyNC5jb2RlUG9pbnRBdChpKTsKICAgICAgICAgICAgd2hpbGUgKGNwKSB7CiAgICAgICAgICAgICAgY3AgPSBjcCA+PiA4OwogICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0b3RhbCsrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgICAgIH07CiAgICAgICAgdmFyIGlzVHlwZWRBcnJheSA9ICh4KSA9PiB4IGluc3RhbmNlb2YgVWludDhBcnJheSB8fCB4IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXkgfHwgeCBpbnN0YW5jZW9mIEludDhBcnJheSB8fCB4IGluc3RhbmNlb2YgVWludDE2QXJyYXkgfHwgeCBpbnN0YW5jZW9mIEludDE2QXJyYXkgfHwgeCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5IHx8IHggaW5zdGFuY2VvZiBJbnQzMkFycmF5IHx8IHggaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgfHwgeCBpbnN0YW5jZW9mIEZsb2F0NjRBcnJheTsKICAgICAgICBleHBvcnRzMy5JbnB1dFR5cGVzID0gdm9pZCAwOwogICAgICAgIChmdW5jdGlvbihJbnB1dFR5cGVzKSB7CiAgICAgICAgICBJbnB1dFR5cGVzWyJTVFJJTkciXSA9ICJzdHJpbmciOwogICAgICAgICAgSW5wdXRUeXBlc1siQVJSQVlfQlVGRkVSIl0gPSAiYXJyYXlCdWZmZXIiOwogICAgICAgICAgSW5wdXRUeXBlc1siVFlQRURfQVJSQVkiXSA9ICJ0eXBlZEFycmF5IjsKICAgICAgICAgIElucHV0VHlwZXNbIkRBVEFfVklFVyJdID0gImRhdGFWaWV3IjsKICAgICAgICB9KShleHBvcnRzMy5JbnB1dFR5cGVzIHx8IChleHBvcnRzMy5JbnB1dFR5cGVzID0ge30pKTsKICAgICAgICB2YXIgY3JlYXRlUGFyc2VyU3RhdGUgPSAodGFyZ2V0LCBkYXRhID0gbnVsbCkgPT4gewogICAgICAgICAgbGV0IGRhdGFWaWV3OwogICAgICAgICAgbGV0IGlucHV0VHlwZTsKICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAic3RyaW5nIikgewogICAgICAgICAgICBjb25zdCBieXRlcyA9IGVuY29kZXIuZW5jb2RlKHRhcmdldCk7CiAgICAgICAgICAgIGRhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGJ5dGVzLmJ1ZmZlcik7CiAgICAgICAgICAgIGlucHV0VHlwZSA9IGV4cG9ydHMzLklucHV0VHlwZXMuU1RSSU5HOwogICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgICAgICBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyh0YXJnZXQpOwogICAgICAgICAgICBpbnB1dFR5cGUgPSBleHBvcnRzMy5JbnB1dFR5cGVzLkFSUkFZX0JVRkZFUjsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUeXBlZEFycmF5KHRhcmdldCkpIHsKICAgICAgICAgICAgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGFyZ2V0LmJ1ZmZlcik7CiAgICAgICAgICAgIGlucHV0VHlwZSA9IGV4cG9ydHMzLklucHV0VHlwZXMuVFlQRURfQVJSQVk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldCBpbnN0YW5jZW9mIERhdGFWaWV3KSB7CiAgICAgICAgICAgIGRhdGFWaWV3ID0gdGFyZ2V0OwogICAgICAgICAgICBpbnB1dFR5cGUgPSBleHBvcnRzMy5JbnB1dFR5cGVzLkRBVEFfVklFVzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHByb2Nlc3MgaW5wdXQuIE11c3QgYmUgYSBzdHJpbmcsIEFycmF5QnVmZmVyLCBUeXBlZEFycmF5LCBvciBEYXRhVmlldy4gYnV0IGdvdCAke3R5cGVvZiB0YXJnZXR9YCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkYXRhVmlldywKICAgICAgICAgICAgaW5wdXRUeXBlLAogICAgICAgICAgICBpc0Vycm9yOiBmYWxzZSwKICAgICAgICAgICAgZXJyb3I6IG51bGwsCiAgICAgICAgICAgIHJlc3VsdDogbnVsbCwKICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgaW5kZXg6IDAKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICB2YXIgdXBkYXRlRXJyb3IgPSAoc3RhdGUsIGVycm9yKSA9PiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHN0YXRlKSwgeyBpc0Vycm9yOiB0cnVlLCBlcnJvciB9KTsKICAgICAgICB2YXIgdXBkYXRlUmVzdWx0ID0gKHN0YXRlLCByZXN1bHQpID0+IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUpLCB7IHJlc3VsdCB9KTsKICAgICAgICB2YXIgdXBkYXRlRGF0YSA9IChzdGF0ZSwgZGF0YSkgPT4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBzdGF0ZSksIHsgZGF0YSB9KTsKICAgICAgICB2YXIgdXBkYXRlUGFyc2VyU3RhdGUgPSAoc3RhdGUsIHJlc3VsdCwgaW5kZXgpID0+IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUpLCB7CiAgICAgICAgICByZXN1bHQsCiAgICAgICAgICBpbmRleAogICAgICAgIH0pOwogICAgICAgIHZhciBQYXJzZXIgPSBjbGFzcyB7CiAgICAgICAgICBjb25zdHJ1Y3RvcihwKSB7CiAgICAgICAgICAgIHRoaXMucCA9IHA7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBydW4gOjogUGFyc2VyIGUgYSBzIH4+IHggLT4gRWl0aGVyIGUgYQogICAgICAgICAgcnVuKHRhcmdldCkgewogICAgICAgICAgICBjb25zdCBzdGF0ZSA9IGNyZWF0ZVBhcnNlclN0YXRlKHRhcmdldCk7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdFN0YXRlID0gdGhpcy5wKHN0YXRlKTsKICAgICAgICAgICAgaWYgKHJlc3VsdFN0YXRlLmlzRXJyb3IpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgaXNFcnJvcjogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiByZXN1bHRTdGF0ZS5lcnJvciwKICAgICAgICAgICAgICAgIGluZGV4OiByZXN1bHRTdGF0ZS5pbmRleCwKICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdFN0YXRlLmRhdGEKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgaXNFcnJvcjogZmFsc2UsCiAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHRTdGF0ZS5yZXN1bHQsCiAgICAgICAgICAgICAgaW5kZXg6IHJlc3VsdFN0YXRlLmluZGV4LAogICAgICAgICAgICAgIGRhdGE6IHJlc3VsdFN0YXRlLmRhdGEKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGZvcmsgOjogUGFyc2VyIGUgYSBzIH4+IHggLT4gKGUgLT4gUGFyc2VyU3RhdGUgZSBhIHMgLT4gZikgLT4gKGEgLT4gUGFyc2VyU3RhdGUgZSBhIHMgLT4gYikKICAgICAgICAgIGZvcmsodGFyZ2V0LCBlcnJvckZuLCBzdWNjZXNzRm4pIHsKICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSBjcmVhdGVQYXJzZXJTdGF0ZSh0YXJnZXQpOwogICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHRoaXMucChzdGF0ZSk7CiAgICAgICAgICAgIGlmIChuZXdTdGF0ZS5pc0Vycm9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVycm9yRm4obmV3U3RhdGUuZXJyb3IsIG5ld1N0YXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3VjY2Vzc0ZuKG5ld1N0YXRlLnJlc3VsdCwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgLy8gbWFwIDo6IFBhcnNlciBlIGEgcyB+PiAoYSAtPiBiKSAtPiBQYXJzZXIgZSBiIHMKICAgICAgICAgIG1hcChmbikgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wOwogICAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBQYXJzZXIkbWFwJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgICAgY29uc3QgbmV3U3RhdGUgPSBwKHN0YXRlKTsKICAgICAgICAgICAgICBpZiAobmV3U3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICAgIHJldHVybiBuZXdTdGF0ZTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KG5ld1N0YXRlLCBmbihuZXdTdGF0ZS5yZXN1bHQpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBjaGFpbiA6OiBQYXJzZXIgZSBhIHMgfj4gKGEgLT4gUGFyc2VyIGUgYiBzKSAtPiBQYXJzZXIgZSBiIHMKICAgICAgICAgIGNoYWluKGZuKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnA7CiAgICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIFBhcnNlciRjaGFpbiRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICAgIGNvbnN0IG5ld1N0YXRlID0gcChzdGF0ZSk7CiAgICAgICAgICAgICAgaWYgKG5ld1N0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3U3RhdGU7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKG5ld1N0YXRlLnJlc3VsdCkucChuZXdTdGF0ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgLy8gYXAgOjogUGFyc2VyIGUgYSBzIH4+IFBhcnNlciBlIChhIC0+IGIpIHMgLT4gUGFyc2VyIGUgYiBzCiAgICAgICAgICBhcChwYXJzZXJPZkZ1bmN0aW9uKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnA7CiAgICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIFBhcnNlciRhcCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICAgIGNvbnN0IGFyZ3VtZW50U3RhdGUgPSBwKHN0YXRlKTsKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRTdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50U3RhdGU7CiAgICAgICAgICAgICAgY29uc3QgZm5TdGF0ZSA9IHBhcnNlck9mRnVuY3Rpb24ucChhcmd1bWVudFN0YXRlKTsKICAgICAgICAgICAgICBpZiAoZm5TdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIGZuU3RhdGU7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlc3VsdChmblN0YXRlLCBmblN0YXRlLnJlc3VsdChhcmd1bWVudFN0YXRlLnJlc3VsdCkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGVycm9yTWFwIDo6IFBhcnNlciBlIGEgcyB+PiAoZSAtPiBmKSAtPiBQYXJzZXIgZiBhIHMKICAgICAgICAgIGVycm9yTWFwKGZuKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnA7CiAgICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIFBhcnNlciRlcnJvck1hcCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICAgIGNvbnN0IG5leHRTdGF0ZSA9IHAoc3RhdGUpOwogICAgICAgICAgICAgIGlmICghbmV4dFN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihuZXh0U3RhdGUsIGZuKHsKICAgICAgICAgICAgICAgIGlzRXJyb3I6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogbmV4dFN0YXRlLmVycm9yLAogICAgICAgICAgICAgICAgaW5kZXg6IG5leHRTdGF0ZS5pbmRleCwKICAgICAgICAgICAgICAgIGRhdGE6IG5leHRTdGF0ZS5kYXRhCiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGVycm9yQ2hhaW4gOjogUGFyc2VyIGUgYSBzIH4+ICgoZSwgSW50ZWdlciwgcykgLT4gUGFyc2VyIGYgYSBzKSAtPiBQYXJzZXIgZiBhIHMKICAgICAgICAgIGVycm9yQ2hhaW4oZm4pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucDsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gUGFyc2VyJGVycm9yQ2hhaW4kc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgICBjb25zdCBuZXh0U3RhdGUgPSBwKHN0YXRlKTsKICAgICAgICAgICAgICBpZiAobmV4dFN0YXRlLmlzRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHsgZXJyb3IsIGluZGV4LCBkYXRhIH0gPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgICBjb25zdCBuZXh0UGFyc2VyID0gZm4oeyBpc0Vycm9yOiB0cnVlLCBlcnJvciwgaW5kZXgsIGRhdGEgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFBhcnNlci5wKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgbmV4dFN0YXRlKSwgeyBpc0Vycm9yOiBmYWxzZSB9KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBuZXh0U3RhdGU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgLy8gbWFwRnJvbURhdGEgOjogUGFyc2VyIGUgYSBzIH4+IChTdGF0ZURhdGEgYSBzIC0+IGIpIC0+IFBhcnNlciBlIGIgcwogICAgICAgICAgbWFwRnJvbURhdGEoZm4pIHsKICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMucDsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoKHN0YXRlKSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgbmV3U3RhdGUgPSBwKHN0YXRlKTsKICAgICAgICAgICAgICBpZiAobmV3U3RhdGUuaXNFcnJvciAmJiBuZXdTdGF0ZS5lcnJvcikKICAgICAgICAgICAgICAgIHJldHVybiBuZXdTdGF0ZTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KG5ld1N0YXRlLCBmbih7CiAgICAgICAgICAgICAgICBpc0Vycm9yOiBmYWxzZSwKICAgICAgICAgICAgICAgIHJlc3VsdDogbmV3U3RhdGUucmVzdWx0LAogICAgICAgICAgICAgICAgZGF0YTogbmV3U3RhdGUuZGF0YSwKICAgICAgICAgICAgICAgIGluZGV4OiBuZXdTdGF0ZS5pbmRleAogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBjaGFpbkZyb21EYXRhIDo6IFBhcnNlciBlIGEgcyB+PiAoU3RhdGVEYXRhIGEgcyAtPiBQYXJzZXIgZiBiIHQpIC0+IFBhcnNlciBmIGIgdAogICAgICAgICAgY2hhaW5Gcm9tRGF0YShmbikgewogICAgICAgICAgICBjb25zdCBwID0gdGhpcy5wOwogICAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBQYXJzZXIkY2hhaW5Gcm9tRGF0YSRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICAgIGNvbnN0IG5ld1N0YXRlID0gcChzdGF0ZSk7CiAgICAgICAgICAgICAgaWYgKG5ld1N0YXRlLmlzRXJyb3IgJiYgbmV3U3RhdGUuZXJyb3IpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3U3RhdGU7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKHsgcmVzdWx0OiBuZXdTdGF0ZS5yZXN1bHQsIGRhdGE6IG5ld1N0YXRlLmRhdGEgfSkucChuZXdTdGF0ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgLy8gbWFwRGF0YSA6OiBQYXJzZXIgZSBhIHMgfj4gKHMgLT4gdCkgLT4gUGFyc2VyIGUgYSB0CiAgICAgICAgICBtYXBEYXRhKGZuKSB7CiAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnA7CiAgICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIG1hcERhdGEkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHAoc3RhdGUpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEYXRhKG5ld1N0YXRlLCBmbihuZXdTdGF0ZS5kYXRhKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgLy8gb2YgOjogYSAtPiBQYXJzZXIgZSBhIHMKICAgICAgICAgIHN0YXRpYyBvZih4KSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKChzdGF0ZSkgPT4gdXBkYXRlUmVzdWx0KHN0YXRlLCB4KSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgcmVEaWdpdCA9IC9bMC05XS87CiAgICAgICAgdmFyIHJlRGlnaXRzID0gL15bMC05XSsvOwogICAgICAgIHZhciByZUxldHRlciA9IC9bYS16QS1aXS87CiAgICAgICAgdmFyIHJlTGV0dGVycyA9IC9eW2EtekEtWl0rLzsKICAgICAgICB2YXIgcmVXaGl0ZXNwYWNlcyA9IC9eXHMrLzsKICAgICAgICB2YXIgcmVFcnJvckV4cGVjdGF0aW9uID0gL1BhcnNlRXJyb3IuK0V4cGVjdGluZy87CiAgICAgICAgdmFyIGdldERhdGEgPSBuZXcgUGFyc2VyKGZ1bmN0aW9uIGdldERhdGEkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KHN0YXRlLCBzdGF0ZS5kYXRhKTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBzZXREYXRhKGRhdGEpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIHNldERhdGEkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRGF0YShzdGF0ZSwgZGF0YSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwRGF0YShmbikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gbWFwRGF0YSRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVEYXRhKHN0YXRlLCBmbihzdGF0ZS5kYXRhKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2l0aERhdGEocGFyc2VyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gd2l0aERhdGEkc3RhdGVEYXRhKHN0YXRlRGF0YSkgewogICAgICAgICAgICByZXR1cm4gc2V0RGF0YShzdGF0ZURhdGEpLmNoYWluKCgpID0+IHBhcnNlcik7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaXBlUGFyc2VycyhwYXJzZXJzKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBwaXBlUGFyc2VycyRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBsZXQgbmV4dFN0YXRlID0gc3RhdGU7CiAgICAgICAgICAgIGZvciAoY29uc3QgcGFyc2VyIG9mIHBhcnNlcnMpIHsKICAgICAgICAgICAgICBuZXh0U3RhdGUgPSBwYXJzZXIucChuZXh0U3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXh0U3RhdGU7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcG9zZVBhcnNlcnMocGFyc2VycykgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gY29tcG9zZVBhcnNlcnMkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIHBpcGVQYXJzZXJzKFsuLi5wYXJzZXJzXS5yZXZlcnNlKCkpLnAoc3RhdGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRhcFBhcnNlcihmbikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gdGFwUGFyc2VyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGZuKHN0YXRlKTsKICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBhcnNlKHBhcnNlcikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHBhcnNlJHRhcmdldFN0cmluZyh0YXJnZXQpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlci5ydW4odGFyZ2V0KTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlY2lkZShmbikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gZGVjaWRlJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgcGFyc2VyID0gZm4oc3RhdGUucmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlci5wKHN0YXRlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmYWlsKGVycm9yTWVzc2FnZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gZmFpbCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgZXJyb3JNZXNzYWdlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgc3VjY2VlZFdpdGggPSBQYXJzZXIub2Y7CiAgICAgICAgZnVuY3Rpb24gZWl0aGVyKHBhcnNlcikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gZWl0aGVyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgbmV4dFN0YXRlID0gcGFyc2VyLnAoc3RhdGUpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgbmV4dFN0YXRlKSwgeyBpc0Vycm9yOiBmYWxzZSB9KSwgewogICAgICAgICAgICAgIGlzRXJyb3I6IG5leHRTdGF0ZS5pc0Vycm9yLAogICAgICAgICAgICAgIHZhbHVlOiBuZXh0U3RhdGUuaXNFcnJvciA/IG5leHRTdGF0ZS5lcnJvciA6IG5leHRTdGF0ZS5yZXN1bHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29yb3V0aW5lKHBhcnNlckZuKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBjb3JvdXRpbmUkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgbGV0IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgbGV0IGN1cnJlbnRTdGF0ZSA9IHN0YXRlOwogICAgICAgICAgICBjb25zdCBydW4gPSAocGFyc2VyKSA9PiB7CiAgICAgICAgICAgICAgaWYgKCEocGFyc2VyICYmIHBhcnNlciBpbnN0YW5jZW9mIFBhcnNlcikpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgW2Nvcm91dGluZV0gcGFzc2VkIHZhbHVlcyBtdXN0IGJlIFBhcnNlcnMsIGdvdCAke3BhcnNlcn0uYCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IG5ld1N0YXRlID0gcGFyc2VyLnAoY3VycmVudFN0YXRlKTsKICAgICAgICAgICAgICBpZiAobmV3U3RhdGUuaXNFcnJvcikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3U3RhdGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSBjdXJyZW50U3RhdGUucmVzdWx0OwogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VyRm4ocnVuKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KGN1cnJlbnRTdGF0ZSwgcmVzdWx0KTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4YWN0bHkobikgewogICAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDw9IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgZXhhY3RseSBtdXN0IGJlIGNhbGxlZCB3aXRoIGEgbnVtYmVyID4gMCwgYnV0IGdvdCAke259YCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZXhhY3RseSRmYWN0b3J5KHBhcnNlcikgewogICAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBleGFjdGx5JGZhY3Rvcnkkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgICBjb25zdCByZXN1bHRzID0gW107CiAgICAgICAgICAgICAgbGV0IG5leHRTdGF0ZSA9IHN0YXRlOwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvdXQgPSBwYXJzZXIucChuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKG91dC5pc0Vycm9yKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXh0U3RhdGUgPSBvdXQ7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChuZXh0U3RhdGUucmVzdWx0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlc3VsdChuZXh0U3RhdGUsIHJlc3VsdHMpOwogICAgICAgICAgICB9KS5lcnJvck1hcCgoeyBpbmRleCwgZXJyb3IgfSkgPT4gYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nICR7bn0ke2Vycm9yLnJlcGxhY2UocmVFcnJvckV4cGVjdGF0aW9uLCAiIil9YCk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbWFueTQgPSBmdW5jdGlvbiBtYW55NShwYXJzZXIpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIG1hbnkkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICBjb25zdCByZXN1bHRzID0gW107CiAgICAgICAgICAgIGxldCBuZXh0U3RhdGUgPSBzdGF0ZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBjb25zdCBvdXQgPSBwYXJzZXIucChuZXh0U3RhdGUpOwogICAgICAgICAgICAgIGlmIChvdXQuaXNFcnJvcikgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRTdGF0ZSA9IG91dDsKICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChuZXh0U3RhdGUucmVzdWx0KTsKICAgICAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuaW5kZXggPj0gbmV4dFN0YXRlLmRhdGFWaWV3LmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZXN1bHQobmV4dFN0YXRlLCByZXN1bHRzKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIG1hbnkxID0gZnVuY3Rpb24gbWFueTEyKHBhcnNlcikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gbWFueTEkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICBjb25zdCByZXNTdGF0ZSA9IG1hbnk0KHBhcnNlcikucChzdGF0ZSk7CiAgICAgICAgICAgIGlmIChyZXNTdGF0ZS5yZXN1bHQubGVuZ3RoKQogICAgICAgICAgICAgIHJldHVybiByZXNTdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVycm9yKHN0YXRlLCBgUGFyc2VFcnJvciAnbWFueTEnIChwb3NpdGlvbiAke3N0YXRlLmluZGV4fSk6IEV4cGVjdGluZyB0byBtYXRjaCBhdCBsZWFzdCBvbmUgdmFsdWVgKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbWFwVG8oZm4pIHsKICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIG1hcFRvJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlc3VsdChzdGF0ZSwgZm4oc3RhdGUucmVzdWx0KSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JNYXBUbyhmbikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gZXJyb3JNYXBUbyRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBpZiAoIXN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRXJyb3Ioc3RhdGUsIGZuKHN0YXRlLmVycm9yLCBzdGF0ZS5pbmRleCwgc3RhdGUuZGF0YSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciBjaGFyNCA9IGZ1bmN0aW9uIGNoYXI1KGMpIHsKICAgICAgICAgIGlmICghYyB8fCBnZXRDaGFyYWN0ZXJMZW5ndGgoYykgIT09IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgY2hhciBtdXN0IGJlIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGNoYXJhY3RlciwgYnV0IGdvdCAke2N9YCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBjaGFyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgeyBpbmRleCwgZGF0YVZpZXcgfSA9IHN0YXRlOwogICAgICAgICAgICBpZiAoaW5kZXggPCBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgICAgY29uc3QgY2hhcldpZHRoID0gZ2V0TmV4dENoYXJXaWR0aChpbmRleCwgZGF0YVZpZXcpOwogICAgICAgICAgICAgIGlmIChpbmRleCArIGNoYXJXaWR0aCA8PSBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjaGFyNiA9IGdldFV0ZjhDaGFyKGluZGV4LCBjaGFyV2lkdGgsIGRhdGFWaWV3KTsKICAgICAgICAgICAgICAgIHJldHVybiBjaGFyNiA9PT0gYyA/IHVwZGF0ZVBhcnNlclN0YXRlKHN0YXRlLCBjLCBpbmRleCArIGNoYXJXaWR0aCkgOiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nIGNoYXJhY3RlciAnJHtjfScsIGdvdCAnJHtjaGFyNn0nYCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nIGNoYXJhY3RlciAnJHtjfScsIGJ1dCBnb3QgZW5kIG9mIGlucHV0LmApOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICB2YXIgYW55Q2hhcjIgPSBuZXcgUGFyc2VyKGZ1bmN0aW9uIGFueUNoYXIkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICBjb25zdCB7IGluZGV4LCBkYXRhVmlldyB9ID0gc3RhdGU7CiAgICAgICAgICBpZiAoaW5kZXggPCBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnN0IGNoYXJXaWR0aCA9IGdldE5leHRDaGFyV2lkdGgoaW5kZXgsIGRhdGFWaWV3KTsKICAgICAgICAgICAgaWYgKGluZGV4ICsgY2hhcldpZHRoIDw9IGRhdGFWaWV3LmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgICBjb25zdCBjaGFyNSA9IGdldFV0ZjhDaGFyKGluZGV4LCBjaGFyV2lkdGgsIGRhdGFWaWV3KTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUGFyc2VyU3RhdGUoc3RhdGUsIGNoYXI1LCBpbmRleCArIGNoYXJXaWR0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nIGEgY2hhcmFjdGVyLCBidXQgZ290IGVuZCBvZiBpbnB1dC5gKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgcGVlayA9IG5ldyBQYXJzZXIoZnVuY3Rpb24gcGVlayRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIGNvbnN0IHsgaW5kZXgsIGRhdGFWaWV3IH0gPSBzdGF0ZTsKICAgICAgICAgIGlmIChpbmRleCA8IGRhdGFWaWV3LmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBhcnNlclN0YXRlKHN0YXRlLCBkYXRhVmlldy5nZXRVaW50OChpbmRleCksIGluZGV4KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogVW5leHBlY3RlZCBlbmQgb2YgaW5wdXQuYCk7CiAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gc3RyMyhzKSB7CiAgICAgICAgICBpZiAoIXMgfHwgZ2V0Q2hhcmFjdGVyTGVuZ3RoKHMpIDwgMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBzdHIgbXVzdCBiZSBjYWxsZWQgd2l0aCBhIHN0cmluZyB3aXRoIGxlbmd0aCA+IDEsIGJ1dCBnb3QgJHtzfWApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZW5jb2RlZFN0ciA9IGVuY29kZXIuZW5jb2RlKHMpOwogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gc3RyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGNvbnN0IHsgaW5kZXgsIGRhdGFWaWV3IH0gPSBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgcmVtYWluaW5nQnl0ZXMgPSBkYXRhVmlldy5ieXRlTGVuZ3RoIC0gaW5kZXg7CiAgICAgICAgICAgIGlmIChyZW1haW5pbmdCeXRlcyA8IGVuY29kZWRTdHIuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nIHN0cmluZyAnJHtzfScsIGJ1dCBnb3QgZW5kIG9mIGlucHV0LmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHN0cmluZ0F0SW5kZXggPSBnZXRTdHJpbmcoaW5kZXgsIGVuY29kZWRTdHIuYnl0ZUxlbmd0aCwgZGF0YVZpZXcpOwogICAgICAgICAgICByZXR1cm4gcyA9PT0gc3RyaW5nQXRJbmRleCA/IHVwZGF0ZVBhcnNlclN0YXRlKHN0YXRlLCBzLCBpbmRleCArIGVuY29kZXIuZW5jb2RlKHMpLmJ5dGVMZW5ndGgpIDogdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yIChwb3NpdGlvbiAke2luZGV4fSk6IEV4cGVjdGluZyBzdHJpbmcgJyR7c30nLCBnb3QgJyR7c3RyaW5nQXRJbmRleH0uLi4nYCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnZXgocmUpIHsKICAgICAgICAgIGNvbnN0IHR5cGVvZnJlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHJlKTsKICAgICAgICAgIGlmICh0eXBlb2ZyZSAhPT0gIltvYmplY3QgUmVnRXhwXSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgcmVnZXggbXVzdCBiZSBjYWxsZWQgd2l0aCBhIFJlZ3VsYXIgRXhwcmVzc2lvbiwgYnV0IGdvdCAke3R5cGVvZnJlfWApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlLnRvU3RyaW5nKClbMV0gIT09ICJeIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHJlZ2V4IHBhcnNlcnMgbXVzdCBjb250YWluICdeJyBzdGFydCBhc3NlcnRpb24uYCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiByZWdleCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgIGNvbnN0IHsgZGF0YVZpZXcsIGluZGV4IH0gPSBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgcmVzdCA9IGdldFN0cmluZyhpbmRleCwgZGF0YVZpZXcuYnl0ZUxlbmd0aCAtIGluZGV4LCBkYXRhVmlldyk7CiAgICAgICAgICAgIGlmIChyZXN0Lmxlbmd0aCA+PSAxKSB7CiAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSByZXN0Lm1hdGNoKHJlKTsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2ggPyB1cGRhdGVQYXJzZXJTdGF0ZShzdGF0ZSwgbWF0Y2hbMF0sIGluZGV4ICsgZW5jb2Rlci5lbmNvZGUobWF0Y2hbMF0pLmJ5dGVMZW5ndGgpIDogdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yIChwb3NpdGlvbiAke2luZGV4fSk6IEV4cGVjdGluZyBzdHJpbmcgbWF0Y2hpbmcgJyR7cmV9JywgZ290ICcke3Jlc3Quc2xpY2UoMCwgNSl9Li4uJ2ApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nIHN0cmluZyBtYXRjaGluZyAnJHtyZX0nLCBidXQgZ290IGVuZCBvZiBpbnB1dC5gKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZGlnaXQyID0gbmV3IFBhcnNlcihmdW5jdGlvbiBkaWdpdCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIGNvbnN0IHsgZGF0YVZpZXcsIGluZGV4IH0gPSBzdGF0ZTsKICAgICAgICAgIGlmIChkYXRhVmlldy5ieXRlTGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgY29uc3QgY2hhcldpZHRoID0gZ2V0TmV4dENoYXJXaWR0aChpbmRleCwgZGF0YVZpZXcpOwogICAgICAgICAgICBpZiAoaW5kZXggKyBjaGFyV2lkdGggPD0gZGF0YVZpZXcuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnN0IGNoYXI1ID0gZ2V0VXRmOENoYXIoaW5kZXgsIGNoYXJXaWR0aCwgZGF0YVZpZXcpOwogICAgICAgICAgICAgIHJldHVybiBkYXRhVmlldy5ieXRlTGVuZ3RoICYmIGNoYXI1ICYmIHJlRGlnaXQudGVzdChjaGFyNSkgPyB1cGRhdGVQYXJzZXJTdGF0ZShzdGF0ZSwgY2hhcjUsIGluZGV4ICsgY2hhcldpZHRoKSA6IHVwZGF0ZUVycm9yKHN0YXRlLCBgUGFyc2VFcnJvciAocG9zaXRpb24gJHtpbmRleH0pOiBFeHBlY3RpbmcgZGlnaXQsIGdvdCAnJHtjaGFyNX0nYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgKHBvc2l0aW9uICR7aW5kZXh9KTogRXhwZWN0aW5nIGRpZ2l0LCBidXQgZ290IGVuZCBvZiBpbnB1dC5gKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgZGlnaXRzID0gcmVnZXgocmVEaWdpdHMpLmVycm9yTWFwKCh7IGluZGV4IH0pID0+IGBQYXJzZUVycm9yIChwb3NpdGlvbiAke2luZGV4fSk6IEV4cGVjdGluZyBkaWdpdHNgKTsKICAgICAgICB2YXIgbGV0dGVyMiA9IG5ldyBQYXJzZXIoZnVuY3Rpb24gbGV0dGVyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgY29uc3QgeyBpbmRleCwgZGF0YVZpZXcgfSA9IHN0YXRlOwogICAgICAgICAgaWYgKGRhdGFWaWV3LmJ5dGVMZW5ndGggPiBpbmRleCkgewogICAgICAgICAgICBjb25zdCBjaGFyV2lkdGggPSBnZXROZXh0Q2hhcldpZHRoKGluZGV4LCBkYXRhVmlldyk7CiAgICAgICAgICAgIGlmIChpbmRleCArIGNoYXJXaWR0aCA8PSBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgICAgY29uc3QgY2hhcjUgPSBnZXRVdGY4Q2hhcihpbmRleCwgY2hhcldpZHRoLCBkYXRhVmlldyk7CiAgICAgICAgICAgICAgcmV0dXJuIGRhdGFWaWV3LmJ5dGVMZW5ndGggJiYgY2hhcjUgJiYgcmVMZXR0ZXIudGVzdChjaGFyNSkgPyB1cGRhdGVQYXJzZXJTdGF0ZShzdGF0ZSwgY2hhcjUsIGluZGV4ICsgY2hhcldpZHRoKSA6IHVwZGF0ZUVycm9yKHN0YXRlLCBgUGFyc2VFcnJvciAocG9zaXRpb24gJHtpbmRleH0pOiBFeHBlY3RpbmcgbGV0dGVyLCBnb3QgJyR7Y2hhcjV9J2ApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yIChwb3NpdGlvbiAke2luZGV4fSk6IEV4cGVjdGluZyBsZXR0ZXIsIGJ1dCBnb3QgZW5kIG9mIGlucHV0LmApOwogICAgICAgIH0pOwogICAgICAgIHZhciBsZXR0ZXJzID0gcmVnZXgocmVMZXR0ZXJzKS5lcnJvck1hcCgoeyBpbmRleCB9KSA9PiBgUGFyc2VFcnJvciAocG9zaXRpb24gJHtpbmRleH0pOiBFeHBlY3RpbmcgbGV0dGVyc2ApOwogICAgICAgIGZ1bmN0aW9uIGFueU9mU3RyaW5nKHMpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIGFueU9mU3RyaW5nJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgeyBkYXRhVmlldywgaW5kZXggfSA9IHN0YXRlOwogICAgICAgICAgICBpZiAoZGF0YVZpZXcuYnl0ZUxlbmd0aCA+IGluZGV4KSB7CiAgICAgICAgICAgICAgY29uc3QgY2hhcldpZHRoID0gZ2V0TmV4dENoYXJXaWR0aChpbmRleCwgZGF0YVZpZXcpOwogICAgICAgICAgICAgIGlmIChpbmRleCArIGNoYXJXaWR0aCA8PSBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjaGFyNSA9IGdldFV0ZjhDaGFyKGluZGV4LCBjaGFyV2lkdGgsIGRhdGFWaWV3KTsKICAgICAgICAgICAgICAgIHJldHVybiBzLmluY2x1ZGVzKGNoYXI1KSA/IHVwZGF0ZVBhcnNlclN0YXRlKHN0YXRlLCBjaGFyNSwgaW5kZXggKyBjaGFyV2lkdGgpIDogdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yIChwb3NpdGlvbiAke2luZGV4fSk6IEV4cGVjdGluZyBhbnkgb2YgdGhlIHN0cmluZyAiJHtzfSIsIGdvdCAke2NoYXI1fWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yIChwb3NpdGlvbiAke2luZGV4fSk6IEV4cGVjdGluZyBhbnkgb2YgdGhlIHN0cmluZyAiJHtzfSIsIGJ1dCBnb3QgZW5kIG9mIGlucHV0LmApOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5hbWVkU2VxdWVuY2VPZjIocGFpcmVkUGFyc2VycykgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gbmFtZWRTZXF1ZW5jZU9mJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgcmVzdWx0cyA9IHt9OwogICAgICAgICAgICBsZXQgbmV4dFN0YXRlID0gc3RhdGU7CiAgICAgICAgICAgIGZvciAoY29uc3QgW2tleSwgcGFyc2VyXSBvZiBwYWlyZWRQYXJzZXJzKSB7CiAgICAgICAgICAgICAgY29uc3Qgb3V0ID0gcGFyc2VyLnAobmV4dFN0YXRlKTsKICAgICAgICAgICAgICBpZiAob3V0LmlzRXJyb3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRTdGF0ZSA9IG91dDsKICAgICAgICAgICAgICAgIHJlc3VsdHNba2V5XSA9IG91dC5yZXN1bHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZXN1bHQobmV4dFN0YXRlLCByZXN1bHRzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXF1ZW5jZU9mNChwYXJzZXJzKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBzZXF1ZW5jZU9mJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gcGFyc2Vycy5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgbGV0IG5leHRTdGF0ZSA9IHN0YXRlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3Qgb3V0ID0gcGFyc2Vyc1tpXS5wKG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgaWYgKG91dC5pc0Vycm9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3V0OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0U3RhdGUgPSBvdXQ7CiAgICAgICAgICAgICAgICByZXN1bHRzW2ldID0gb3V0LnJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlc3VsdChuZXh0U3RhdGUsIHJlc3VsdHMpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNlcEJ5KHNlcFBhcnNlcikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHNlcEJ5JHZhbFBhcnNlcih2YWx1ZVBhcnNlcikgewogICAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBzZXBCeSR2YWxQYXJzZXIkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgICBsZXQgbmV4dFN0YXRlID0gc3RhdGU7CiAgICAgICAgICAgICAgbGV0IGVycm9yID0gbnVsbDsKICAgICAgICAgICAgICBjb25zdCByZXN1bHRzID0gW107CiAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbFN0YXRlID0gdmFsdWVQYXJzZXIucChuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgY29uc3Qgc2VwU3RhdGUgPSBzZXBQYXJzZXIucCh2YWxTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAodmFsU3RhdGUuaXNFcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvciA9IHZhbFN0YXRlOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh2YWxTdGF0ZS5yZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlcFN0YXRlLmlzRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgbmV4dFN0YXRlID0gdmFsU3RhdGU7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dFN0YXRlID0gc2VwU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZXN1bHQoc3RhdGUsIHJlc3VsdHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KG5leHRTdGF0ZSwgcmVzdWx0cyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIHNlcEJ5MSA9IGZ1bmN0aW9uIHNlcEJ5MTIoc2VwUGFyc2VyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gc2VwQnkxJHZhbFBhcnNlcih2YWx1ZVBhcnNlcikgewogICAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBzZXBCeTEkdmFsUGFyc2VyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgICAgY29uc3Qgb3V0ID0gc2VwQnkoc2VwUGFyc2VyKSh2YWx1ZVBhcnNlcikucChzdGF0ZSk7CiAgICAgICAgICAgICAgaWYgKG91dC5pc0Vycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICAgICAgICBpZiAob3V0LnJlc3VsdC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgJ3NlcEJ5MScgKHBvc2l0aW9uICR7c3RhdGUuaW5kZXh9KTogRXhwZWN0aW5nIHRvIG1hdGNoIGF0IGxlYXN0IG9uZSBzZXBhcmF0ZWQgdmFsdWVgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hvaWNlMihwYXJzZXJzKSB7CiAgICAgICAgICBpZiAocGFyc2Vycy5sZW5ndGggPT09IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTGlzdCBvZiBwYXJzZXJzIGNhbid0IGJlIGVtcHR5LmApOwogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gY2hvaWNlJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgbGV0IGVycm9yID0gbnVsbDsKICAgICAgICAgICAgZm9yIChjb25zdCBwYXJzZXIgb2YgcGFyc2VycykgewogICAgICAgICAgICAgIGNvbnN0IG91dCA9IHBhcnNlci5wKHN0YXRlKTsKICAgICAgICAgICAgICBpZiAoIW91dC5pc0Vycm9yKQogICAgICAgICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICAgICAgICBpZiAoZXJyb3IgPT09IG51bGwgfHwgZXJyb3IgJiYgb3V0LmluZGV4ID4gZXJyb3IuaW5kZXgpIHsKICAgICAgICAgICAgICAgIGVycm9yID0gb3V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmV0d2VlbihsZWZ0UGFyc2VyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmV0d2VlbiRyaWdodFBhcnNlcihyaWdodFBhcnNlcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmV0d2VlbiRwYXJzZXIocGFyc2VyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNlcXVlbmNlT2Y0KFtsZWZ0UGFyc2VyLCBwYXJzZXIsIHJpZ2h0UGFyc2VyXSkubWFwKChbXywgeF0pID0+IHgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXZlcnl0aGluZ1VudGlsKHBhcnNlcikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoKHN0YXRlKSA9PiB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBsZXQgbmV4dFN0YXRlID0gc3RhdGU7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgY29uc3Qgb3V0ID0gcGFyc2VyLnAobmV4dFN0YXRlKTsKICAgICAgICAgICAgICBpZiAob3V0LmlzRXJyb3IpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHsgaW5kZXgsIGRhdGFWaWV3IH0gPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVZpZXcuYnl0ZUxlbmd0aCA8PSBpbmRleCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRXJyb3IobmV4dFN0YXRlLCBgUGFyc2VFcnJvciAnZXZlcnl0aGluZ1VudGlsJyAocG9zaXRpb24gJHtuZXh0U3RhdGUuaW5kZXh9KTogVW5leHBlY3RlZCBlbmQgb2YgaW5wdXQuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBkYXRhVmlldy5nZXRVaW50OChpbmRleCk7CiAgICAgICAgICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh2YWwpOwogICAgICAgICAgICAgICAgICBuZXh0U3RhdGUgPSB1cGRhdGVQYXJzZXJTdGF0ZShuZXh0U3RhdGUsIHZhbCwgaW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZXN1bHQobmV4dFN0YXRlLCByZXN1bHRzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZXZlcnlDaGFyVW50aWwgPSAocGFyc2VyKSA9PiBldmVyeXRoaW5nVW50aWwocGFyc2VyKS5tYXAoKHJlc3VsdHMpID0+IGRlY29kZXIuZGVjb2RlKFVpbnQ4QXJyYXkuZnJvbShyZXN1bHRzKSkpOwogICAgICAgIHZhciBhbnl0aGluZ0V4Y2VwdCA9IGZ1bmN0aW9uIGFueXRoaW5nRXhjZXB0MihwYXJzZXIpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIGFueXRoaW5nRXhjZXB0JHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgeyBkYXRhVmlldywgaW5kZXggfSA9IHN0YXRlOwogICAgICAgICAgICBjb25zdCBvdXQgPSBwYXJzZXIucChzdGF0ZSk7CiAgICAgICAgICAgIGlmIChvdXQuaXNFcnJvcikgewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQYXJzZXJTdGF0ZShzdGF0ZSwgZGF0YVZpZXcuZ2V0VWludDgoaW5kZXgpLCBpbmRleCArIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgJ2FueXRoaW5nRXhjZXB0JyAocG9zaXRpb24gJHtpbmRleH0pOiBNYXRjaGVkICcke291dC5yZXN1bHR9JyBmcm9tIHRoZSBleGNlcHRpb24gcGFyc2VyYCk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHZhciBhbnlDaGFyRXhjZXB0MyA9IGZ1bmN0aW9uIGFueUNoYXJFeGNlcHQ0KHBhcnNlcikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gYW55Q2hhckV4Y2VwdCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgIGNvbnN0IHsgZGF0YVZpZXcsIGluZGV4IH0gPSBzdGF0ZTsKICAgICAgICAgICAgY29uc3Qgb3V0ID0gcGFyc2VyLnAoc3RhdGUpOwogICAgICAgICAgICBpZiAob3V0LmlzRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoaW5kZXggPCBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjaGFyV2lkdGggPSBnZXROZXh0Q2hhcldpZHRoKGluZGV4LCBkYXRhVmlldyk7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggKyBjaGFyV2lkdGggPD0gZGF0YVZpZXcuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICAgICAgICBjb25zdCBjaGFyNSA9IGdldFV0ZjhDaGFyKGluZGV4LCBjaGFyV2lkdGgsIGRhdGFWaWV3KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBhcnNlclN0YXRlKHN0YXRlLCBjaGFyNSwgaW5kZXggKyBjaGFyV2lkdGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yICdhbnlDaGFyRXhjZXB0JyAocG9zaXRpb24gJHtpbmRleH0pOiBVbmV4cGVjdGVkIGVuZCBvZiBpbnB1dGApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVFcnJvcihzdGF0ZSwgYFBhcnNlRXJyb3IgJ2FueUNoYXJFeGNlcHQnIChwb3NpdGlvbiAke2luZGV4fSk6IE1hdGNoZWQgJyR7b3V0LnJlc3VsdH0nIGZyb20gdGhlIGV4Y2VwdGlvbiBwYXJzZXJgKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbG9va0FoZWFkKHBhcnNlcikgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gbG9va0FoZWFkJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgICAgY29uc3QgbmV4dFN0YXRlID0gcGFyc2VyLnAoc3RhdGUpOwogICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlLmlzRXJyb3IgPyB1cGRhdGVFcnJvcihzdGF0ZSwgbmV4dFN0YXRlLmVycm9yKSA6IHVwZGF0ZVJlc3VsdChzdGF0ZSwgbmV4dFN0YXRlLnJlc3VsdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zc2libHkocGFyc2VyKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBhcnNlcihmdW5jdGlvbiBwb3NzaWJseSRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgICBpZiAoc3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICAgIGNvbnN0IG5leHRTdGF0ZSA9IHBhcnNlci5wKHN0YXRlKTsKICAgICAgICAgICAgcmV0dXJuIG5leHRTdGF0ZS5pc0Vycm9yID8gdXBkYXRlUmVzdWx0KHN0YXRlLCBudWxsKSA6IG5leHRTdGF0ZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBza2lwMihwYXJzZXIpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGFyc2VyKGZ1bmN0aW9uIHNraXAkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICAgICAgICBjb25zdCBuZXh0U3RhdGUgPSBwYXJzZXIucChzdGF0ZSk7CiAgICAgICAgICAgIGlmIChuZXh0U3RhdGUuaXNFcnJvcikKICAgICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0KG5leHRTdGF0ZSwgc3RhdGUucmVzdWx0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgc3RhcnRPZklucHV0ID0gbmV3IFBhcnNlcihmdW5jdGlvbiBzdGFydE9mSW5wdXQkc3RhdGUoc3RhdGUpIHsKICAgICAgICAgIGlmIChzdGF0ZS5pc0Vycm9yKQogICAgICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgICAgICBjb25zdCB7IGluZGV4IH0gPSBzdGF0ZTsKICAgICAgICAgIGlmIChpbmRleCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVycm9yKHN0YXRlLCBgUGFyc2VFcnJvciAnc3RhcnRPZklucHV0JyAocG9zaXRpb24gJHtpbmRleH0pOiBFeHBlY3RlZCBzdGFydCBvZiBpbnB1dCdgKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICB9KTsKICAgICAgICB2YXIgZW5kT2ZJbnB1dCA9IG5ldyBQYXJzZXIoZnVuY3Rpb24gZW5kT2ZJbnB1dCRzdGF0ZShzdGF0ZSkgewogICAgICAgICAgaWYgKHN0YXRlLmlzRXJyb3IpCiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIGNvbnN0IHsgZGF0YVZpZXcsIGluZGV4LCBpbnB1dFR5cGUgfSA9IHN0YXRlOwogICAgICAgICAgaWYgKGluZGV4ICE9PSBkYXRhVmlldy5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnN0IGVycm9yQnl0ZSA9IGlucHV0VHlwZSA9PT0gZXhwb3J0czMuSW5wdXRUeXBlcy5TVFJJTkcgPyBTdHJpbmcuZnJvbUNoYXJDb2RlKGRhdGFWaWV3LmdldFVpbnQ4KGluZGV4KSkgOiBgMHgke2RhdGFWaWV3LmdldFVpbnQ4KGluZGV4KS50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKX1gOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlRXJyb3Ioc3RhdGUsIGBQYXJzZUVycm9yICdlbmRPZklucHV0JyAocG9zaXRpb24gJHtpbmRleH0pOiBFeHBlY3RlZCBlbmQgb2YgaW5wdXQgYnV0IGdvdCAnJHtlcnJvckJ5dGV9J2ApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlc3VsdChzdGF0ZSwgbnVsbCk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHdoaXRlc3BhY2UyID0gcmVnZXgocmVXaGl0ZXNwYWNlcykuZXJyb3JNYXAoKHsgaW5kZXggfSkgPT4gYFBhcnNlRXJyb3IgJ21hbnkxJyAocG9zaXRpb24gJHtpbmRleH0pOiBFeHBlY3RpbmcgdG8gbWF0Y2ggYXQgbGVhc3Qgb25lIHZhbHVlYCk7CiAgICAgICAgdmFyIG9wdGlvbmFsV2hpdGVzcGFjZSA9IHBvc3NpYmx5KHdoaXRlc3BhY2UyKS5tYXAoKHgpID0+IHggfHwgIiIpOwogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZVBhcnNlcihwYXJzZXJUaHVuaykgewogICAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoZnVuY3Rpb24gcmVjdXJzaXZlUGFyc2VyJHN0YXRlKHN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBwYXJzZXJUaHVuaygpLnAoc3RhdGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRha2VSaWdodChsZWZ0UGFyc2VyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdGFrZVJpZ2h0JHJpZ2h0UGFyc2VyKHJpZ2h0UGFyc2VyKSB7CiAgICAgICAgICAgIHJldHVybiBsZWZ0UGFyc2VyLmNoYWluKCgpID0+IHJpZ2h0UGFyc2VyKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB0YWtlTGVmdCA9IGZ1bmN0aW9uIHRha2VMZWZ0MihsZWZ0UGFyc2VyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdGFrZUxlZnQkcmlnaHRQYXJzZXIocmlnaHRQYXJzZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGxlZnRQYXJzZXIuY2hhaW4oKHgpID0+IHJpZ2h0UGFyc2VyLm1hcCgoKSA9PiB4KSk7CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gdG9Qcm9taXNlKHJlc3VsdCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdC5pc0Vycm9yID09PSB0cnVlID8gUHJvbWlzZS5yZWplY3QoewogICAgICAgICAgICBlcnJvcjogcmVzdWx0LmVycm9yLAogICAgICAgICAgICBpbmRleDogcmVzdWx0LmluZGV4LAogICAgICAgICAgICBkYXRhOiByZXN1bHQuZGF0YQogICAgICAgICAgfSkgOiBQcm9taXNlLnJlc29sdmUocmVzdWx0LnJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvVmFsdWUocmVzdWx0KSB7CiAgICAgICAgICBpZiAocmVzdWx0LmlzRXJyb3IgPT09IHRydWUpIHsKICAgICAgICAgICAgY29uc3QgZSA9IG5ldyBFcnJvcihTdHJpbmcocmVzdWx0LmVycm9yKSB8fCAibnVsbCIpOwogICAgICAgICAgICBlLnBhcnNlSW5kZXggPSByZXN1bHQuaW5kZXg7CiAgICAgICAgICAgIGUuZGF0YSA9IHJlc3VsdC5kYXRhOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdC5yZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGV4cG9ydHMzLlBhcnNlciA9IFBhcnNlcjsKICAgICAgICBleHBvcnRzMy5hbnlDaGFyID0gYW55Q2hhcjI7CiAgICAgICAgZXhwb3J0czMuYW55Q2hhckV4Y2VwdCA9IGFueUNoYXJFeGNlcHQzOwogICAgICAgIGV4cG9ydHMzLmFueU9mU3RyaW5nID0gYW55T2ZTdHJpbmc7CiAgICAgICAgZXhwb3J0czMuYW55dGhpbmdFeGNlcHQgPSBhbnl0aGluZ0V4Y2VwdDsKICAgICAgICBleHBvcnRzMy5iZXR3ZWVuID0gYmV0d2VlbjsKICAgICAgICBleHBvcnRzMy5jaGFyID0gY2hhcjQ7CiAgICAgICAgZXhwb3J0czMuY2hvaWNlID0gY2hvaWNlMjsKICAgICAgICBleHBvcnRzMy5jb21wb3NlUGFyc2VycyA9IGNvbXBvc2VQYXJzZXJzOwogICAgICAgIGV4cG9ydHMzLmNvcm91dGluZSA9IGNvcm91dGluZTsKICAgICAgICBleHBvcnRzMy5kZWNpZGUgPSBkZWNpZGU7CiAgICAgICAgZXhwb3J0czMuZGVjb2RlciA9IGRlY29kZXI7CiAgICAgICAgZXhwb3J0czMuZGlnaXQgPSBkaWdpdDI7CiAgICAgICAgZXhwb3J0czMuZGlnaXRzID0gZGlnaXRzOwogICAgICAgIGV4cG9ydHMzLmVpdGhlciA9IGVpdGhlcjsKICAgICAgICBleHBvcnRzMy5lbmNvZGVyID0gZW5jb2RlcjsKICAgICAgICBleHBvcnRzMy5lbmRPZklucHV0ID0gZW5kT2ZJbnB1dDsKICAgICAgICBleHBvcnRzMy5lcnJvck1hcFRvID0gZXJyb3JNYXBUbzsKICAgICAgICBleHBvcnRzMy5ldmVyeUNoYXJVbnRpbCA9IGV2ZXJ5Q2hhclVudGlsOwogICAgICAgIGV4cG9ydHMzLmV2ZXJ5dGhpbmdVbnRpbCA9IGV2ZXJ5dGhpbmdVbnRpbDsKICAgICAgICBleHBvcnRzMy5leGFjdGx5ID0gZXhhY3RseTsKICAgICAgICBleHBvcnRzMy5mYWlsID0gZmFpbDsKICAgICAgICBleHBvcnRzMy5nZXRDaGFyYWN0ZXJMZW5ndGggPSBnZXRDaGFyYWN0ZXJMZW5ndGg7CiAgICAgICAgZXhwb3J0czMuZ2V0RGF0YSA9IGdldERhdGE7CiAgICAgICAgZXhwb3J0czMuZ2V0TmV4dENoYXJXaWR0aCA9IGdldE5leHRDaGFyV2lkdGg7CiAgICAgICAgZXhwb3J0czMuZ2V0U3RyaW5nID0gZ2V0U3RyaW5nOwogICAgICAgIGV4cG9ydHMzLmdldFV0ZjhDaGFyID0gZ2V0VXRmOENoYXI7CiAgICAgICAgZXhwb3J0czMubGV0dGVyID0gbGV0dGVyMjsKICAgICAgICBleHBvcnRzMy5sZXR0ZXJzID0gbGV0dGVyczsKICAgICAgICBleHBvcnRzMy5sb29rQWhlYWQgPSBsb29rQWhlYWQ7CiAgICAgICAgZXhwb3J0czMubWFueSA9IG1hbnk0OwogICAgICAgIGV4cG9ydHMzLm1hbnkxID0gbWFueTE7CiAgICAgICAgZXhwb3J0czMubWFwRGF0YSA9IG1hcERhdGE7CiAgICAgICAgZXhwb3J0czMubWFwVG8gPSBtYXBUbzsKICAgICAgICBleHBvcnRzMy5uYW1lZFNlcXVlbmNlT2YgPSBuYW1lZFNlcXVlbmNlT2YyOwogICAgICAgIGV4cG9ydHMzLm9wdGlvbmFsV2hpdGVzcGFjZSA9IG9wdGlvbmFsV2hpdGVzcGFjZTsKICAgICAgICBleHBvcnRzMy5wYXJzZSA9IHBhcnNlOwogICAgICAgIGV4cG9ydHMzLnBlZWsgPSBwZWVrOwogICAgICAgIGV4cG9ydHMzLnBpcGVQYXJzZXJzID0gcGlwZVBhcnNlcnM7CiAgICAgICAgZXhwb3J0czMucG9zc2libHkgPSBwb3NzaWJseTsKICAgICAgICBleHBvcnRzMy5yZWN1cnNpdmVQYXJzZXIgPSByZWN1cnNpdmVQYXJzZXI7CiAgICAgICAgZXhwb3J0czMucmVnZXggPSByZWdleDsKICAgICAgICBleHBvcnRzMy5zZXBCeSA9IHNlcEJ5OwogICAgICAgIGV4cG9ydHMzLnNlcEJ5MSA9IHNlcEJ5MTsKICAgICAgICBleHBvcnRzMy5zZXF1ZW5jZU9mID0gc2VxdWVuY2VPZjQ7CiAgICAgICAgZXhwb3J0czMuc2V0RGF0YSA9IHNldERhdGE7CiAgICAgICAgZXhwb3J0czMuc2tpcCA9IHNraXAyOwogICAgICAgIGV4cG9ydHMzLnN0YXJ0T2ZJbnB1dCA9IHN0YXJ0T2ZJbnB1dDsKICAgICAgICBleHBvcnRzMy5zdHIgPSBzdHIzOwogICAgICAgIGV4cG9ydHMzLnN1Y2NlZWRXaXRoID0gc3VjY2VlZFdpdGg7CiAgICAgICAgZXhwb3J0czMudGFrZUxlZnQgPSB0YWtlTGVmdDsKICAgICAgICBleHBvcnRzMy50YWtlUmlnaHQgPSB0YWtlUmlnaHQ7CiAgICAgICAgZXhwb3J0czMudGFwUGFyc2VyID0gdGFwUGFyc2VyOwogICAgICAgIGV4cG9ydHMzLnRvUHJvbWlzZSA9IHRvUHJvbWlzZTsKICAgICAgICBleHBvcnRzMy50b1ZhbHVlID0gdG9WYWx1ZTsKICAgICAgICBleHBvcnRzMy51cGRhdGVEYXRhID0gdXBkYXRlRGF0YTsKICAgICAgICBleHBvcnRzMy51cGRhdGVFcnJvciA9IHVwZGF0ZUVycm9yOwogICAgICAgIGV4cG9ydHMzLnVwZGF0ZVBhcnNlclN0YXRlID0gdXBkYXRlUGFyc2VyU3RhdGU7CiAgICAgICAgZXhwb3J0czMudXBkYXRlUmVzdWx0ID0gdXBkYXRlUmVzdWx0OwogICAgICAgIGV4cG9ydHMzLndoaXRlc3BhY2UgPSB3aGl0ZXNwYWNlMjsKICAgICAgICBleHBvcnRzMy53aXRoRGF0YSA9IHdpdGhEYXRhOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXF1aXJlX2RheWpzX21pbiA9IF9fY29tbW9uSlMyKHsKICAgICAgIi4uLy4uL25vZGVfbW9kdWxlcy9kYXlqcy9kYXlqcy5taW4uanMiKGV4cG9ydHMzLCBtb2R1bGUyMikgewogICAgICAgICFmdW5jdGlvbih0LCBlKSB7CiAgICAgICAgICAib2JqZWN0IiA9PSB0eXBlb2YgZXhwb3J0czMgJiYgInVuZGVmaW5lZCIgIT0gdHlwZW9mIG1vZHVsZTIyID8gbW9kdWxlMjIuZXhwb3J0cyA9IGUoKSA6ICJmdW5jdGlvbiIgPT0gdHlwZW9mIGRlZmluZSAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGUpIDogKHQgPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgZ2xvYmFsVGhpcyA/IGdsb2JhbFRoaXMgOiB0IHx8IHNlbGYpLmRheWpzID0gZSgpOwogICAgICAgIH0oZXhwb3J0czMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgICAgdmFyIHQgPSAxZTMsIGUgPSA2ZTQsIG4gPSAzNmU1LCByID0gIm1pbGxpc2Vjb25kIiwgaSA9ICJzZWNvbmQiLCBzID0gIm1pbnV0ZSIsIHUgPSAiaG91ciIsIGEgPSAiZGF5IiwgbyA9ICJ3ZWVrIiwgZiA9ICJtb250aCIsIGggPSAicXVhcnRlciIsIGMgPSAieWVhciIsIGQgPSAiZGF0ZSIsIGwgPSAiSW52YWxpZCBEYXRlIiwgJCA9IC9eKFxkezR9KVstL10/KFxkezEsMn0pP1stL10/KFxkezAsMn0pW1R0XHNdKihcZHsxLDJ9KT86PyhcZHsxLDJ9KT86PyhcZHsxLDJ9KT9bLjpdPyhcZCspPyQvLCB5ID0gL1xbKFteXF1dKyldfFl7MSw0fXxNezEsNH18RHsxLDJ9fGR7MSw0fXxIezEsMn18aHsxLDJ9fGF8QXxtezEsMn18c3sxLDJ9fFp7MSwyfXxTU1MvZywgTSA9IHsgbmFtZTogImVuIiwgd2Vla2RheXM6ICJTdW5kYXlfTW9uZGF5X1R1ZXNkYXlfV2VkbmVzZGF5X1RodXJzZGF5X0ZyaWRheV9TYXR1cmRheSIuc3BsaXQoIl8iKSwgbW9udGhzOiAiSmFudWFyeV9GZWJydWFyeV9NYXJjaF9BcHJpbF9NYXlfSnVuZV9KdWx5X0F1Z3VzdF9TZXB0ZW1iZXJfT2N0b2Jlcl9Ob3ZlbWJlcl9EZWNlbWJlciIuc3BsaXQoIl8iKSwgb3JkaW5hbDogZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgdmFyIGUyID0gWyJ0aCIsICJzdCIsICJuZCIsICJyZCJdLCBuMiA9IHQyICUgMTAwOwogICAgICAgICAgICByZXR1cm4gIlsiICsgdDIgKyAoZTJbKG4yIC0gMjApICUgMTBdIHx8IGUyW24yXSB8fCBlMlswXSkgKyAiXSI7CiAgICAgICAgICB9IH0sIG0gPSBmdW5jdGlvbih0MiwgZTIsIG4yKSB7CiAgICAgICAgICAgIHZhciByMiA9IFN0cmluZyh0Mik7CiAgICAgICAgICAgIHJldHVybiAhcjIgfHwgcjIubGVuZ3RoID49IGUyID8gdDIgOiAiIiArIEFycmF5KGUyICsgMSAtIHIyLmxlbmd0aCkuam9pbihuMikgKyB0MjsKICAgICAgICAgIH0sIHYgPSB7IHM6IG0sIHo6IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgIHZhciBlMiA9IC10Mi51dGNPZmZzZXQoKSwgbjIgPSBNYXRoLmFicyhlMiksIHIyID0gTWF0aC5mbG9vcihuMiAvIDYwKSwgaTIgPSBuMiAlIDYwOwogICAgICAgICAgICByZXR1cm4gKGUyIDw9IDAgPyAiKyIgOiAiLSIpICsgbShyMiwgMiwgIjAiKSArICI6IiArIG0oaTIsIDIsICIwIik7CiAgICAgICAgICB9LCBtOiBmdW5jdGlvbiB0MihlMiwgbjIpIHsKICAgICAgICAgICAgaWYgKGUyLmRhdGUoKSA8IG4yLmRhdGUoKSkKICAgICAgICAgICAgICByZXR1cm4gLXQyKG4yLCBlMik7CiAgICAgICAgICAgIHZhciByMiA9IDEyICogKG4yLnllYXIoKSAtIGUyLnllYXIoKSkgKyAobjIubW9udGgoKSAtIGUyLm1vbnRoKCkpLCBpMiA9IGUyLmNsb25lKCkuYWRkKHIyLCBmKSwgczIgPSBuMiAtIGkyIDwgMCwgdTIgPSBlMi5jbG9uZSgpLmFkZChyMiArIChzMiA/IC0xIDogMSksIGYpOwogICAgICAgICAgICByZXR1cm4gKygtKHIyICsgKG4yIC0gaTIpIC8gKHMyID8gaTIgLSB1MiA6IHUyIC0gaTIpKSB8fCAwKTsKICAgICAgICAgIH0sIGE6IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgIHJldHVybiB0MiA8IDAgPyBNYXRoLmNlaWwodDIpIHx8IDAgOiBNYXRoLmZsb29yKHQyKTsKICAgICAgICAgIH0sIHA6IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgIHJldHVybiB7IE06IGYsIHk6IGMsIHc6IG8sIGQ6IGEsIEQ6IGQsIGg6IHUsIG06IHMsIHM6IGksIG1zOiByLCBROiBoIH1bdDJdIHx8IFN0cmluZyh0MiB8fCAiIikudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9zJC8sICIiKTsKICAgICAgICAgIH0sIHU6IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDAgPT09IHQyOwogICAgICAgICAgfSB9LCBnID0gImVuIiwgRCA9IHt9OwogICAgICAgICAgRFtnXSA9IE07CiAgICAgICAgICB2YXIgcCA9IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgIHJldHVybiB0MiBpbnN0YW5jZW9mIF87CiAgICAgICAgICB9LCBTID0gZnVuY3Rpb24gdDIoZTIsIG4yLCByMikgewogICAgICAgICAgICB2YXIgaTI7CiAgICAgICAgICAgIGlmICghZTIpCiAgICAgICAgICAgICAgcmV0dXJuIGc7CiAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgZTIpIHsKICAgICAgICAgICAgICB2YXIgczIgPSBlMi50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIERbczJdICYmIChpMiA9IHMyKSwgbjIgJiYgKERbczJdID0gbjIsIGkyID0gczIpOwogICAgICAgICAgICAgIHZhciB1MiA9IGUyLnNwbGl0KCItIik7CiAgICAgICAgICAgICAgaWYgKCFpMiAmJiB1Mi5sZW5ndGggPiAxKQogICAgICAgICAgICAgICAgcmV0dXJuIHQyKHUyWzBdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgYTIgPSBlMi5uYW1lOwogICAgICAgICAgICAgIERbYTJdID0gZTIsIGkyID0gYTI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICFyMiAmJiBpMiAmJiAoZyA9IGkyKSwgaTIgfHwgIXIyICYmIGc7CiAgICAgICAgICB9LCB3ID0gZnVuY3Rpb24odDIsIGUyKSB7CiAgICAgICAgICAgIGlmIChwKHQyKSkKICAgICAgICAgICAgICByZXR1cm4gdDIuY2xvbmUoKTsKICAgICAgICAgICAgdmFyIG4yID0gIm9iamVjdCIgPT0gdHlwZW9mIGUyID8gZTIgOiB7fTsKICAgICAgICAgICAgcmV0dXJuIG4yLmRhdGUgPSB0MiwgbjIuYXJncyA9IGFyZ3VtZW50cywgbmV3IF8objIpOwogICAgICAgICAgfSwgTyA9IHY7CiAgICAgICAgICBPLmwgPSBTLCBPLmkgPSBwLCBPLncgPSBmdW5jdGlvbih0MiwgZTIpIHsKICAgICAgICAgICAgcmV0dXJuIHcodDIsIHsgbG9jYWxlOiBlMi4kTCwgdXRjOiBlMi4kdSwgeDogZTIuJHgsICRvZmZzZXQ6IGUyLiRvZmZzZXQgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIF8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gTTIodDIpIHsKICAgICAgICAgICAgICB0aGlzLiRMID0gUyh0Mi5sb2NhbGUsIG51bGwsIHRydWUpLCB0aGlzLnBhcnNlKHQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbTIgPSBNMi5wcm90b3R5cGU7CiAgICAgICAgICAgIHJldHVybiBtMi5wYXJzZSA9IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgICAgdGhpcy4kZCA9IGZ1bmN0aW9uKHQzKSB7CiAgICAgICAgICAgICAgICB2YXIgZTIgPSB0My5kYXRlLCBuMiA9IHQzLnV0YzsKICAgICAgICAgICAgICAgIGlmIChudWxsID09PSBlMikKICAgICAgICAgICAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZShOYU4pOwogICAgICAgICAgICAgICAgaWYgKE8udShlMikpCiAgICAgICAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICAgICAgICAgICAgICAgIGlmIChlMiBpbnN0YW5jZW9mIERhdGUpCiAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShlMik7CiAgICAgICAgICAgICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUyICYmICEvWiQvaS50ZXN0KGUyKSkgewogICAgICAgICAgICAgICAgICB2YXIgcjIgPSBlMi5tYXRjaCgkKTsKICAgICAgICAgICAgICAgICAgaWYgKHIyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGkyID0gcjJbMl0gLSAxIHx8IDAsIHMyID0gKHIyWzddIHx8ICIwIikuc3Vic3RyaW5nKDAsIDMpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuMiA/IG5ldyBEYXRlKERhdGUuVVRDKHIyWzFdLCBpMiwgcjJbM10gfHwgMSwgcjJbNF0gfHwgMCwgcjJbNV0gfHwgMCwgcjJbNl0gfHwgMCwgczIpKSA6IG5ldyBEYXRlKHIyWzFdLCBpMiwgcjJbM10gfHwgMSwgcjJbNF0gfHwgMCwgcjJbNV0gfHwgMCwgcjJbNl0gfHwgMCwgczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZTIpOwogICAgICAgICAgICAgIH0odDIpLCB0aGlzLiR4ID0gdDIueCB8fCB7fSwgdGhpcy5pbml0KCk7CiAgICAgICAgICAgIH0sIG0yLmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgdDIgPSB0aGlzLiRkOwogICAgICAgICAgICAgIHRoaXMuJHkgPSB0Mi5nZXRGdWxsWWVhcigpLCB0aGlzLiRNID0gdDIuZ2V0TW9udGgoKSwgdGhpcy4kRCA9IHQyLmdldERhdGUoKSwgdGhpcy4kVyA9IHQyLmdldERheSgpLCB0aGlzLiRIID0gdDIuZ2V0SG91cnMoKSwgdGhpcy4kbSA9IHQyLmdldE1pbnV0ZXMoKSwgdGhpcy4kcyA9IHQyLmdldFNlY29uZHMoKSwgdGhpcy4kbXMgPSB0Mi5nZXRNaWxsaXNlY29uZHMoKTsKICAgICAgICAgICAgfSwgbTIuJHV0aWxzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE87CiAgICAgICAgICAgIH0sIG0yLmlzVmFsaWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gISh0aGlzLiRkLnRvU3RyaW5nKCkgPT09IGwpOwogICAgICAgICAgICB9LCBtMi5pc1NhbWUgPSBmdW5jdGlvbih0MiwgZTIpIHsKICAgICAgICAgICAgICB2YXIgbjIgPSB3KHQyKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydE9mKGUyKSA8PSBuMiAmJiBuMiA8PSB0aGlzLmVuZE9mKGUyKTsKICAgICAgICAgICAgfSwgbTIuaXNBZnRlciA9IGZ1bmN0aW9uKHQyLCBlMikgewogICAgICAgICAgICAgIHJldHVybiB3KHQyKSA8IHRoaXMuc3RhcnRPZihlMik7CiAgICAgICAgICAgIH0sIG0yLmlzQmVmb3JlID0gZnVuY3Rpb24odDIsIGUyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5kT2YoZTIpIDwgdyh0Mik7CiAgICAgICAgICAgIH0sIG0yLiRnID0gZnVuY3Rpb24odDIsIGUyLCBuMikgewogICAgICAgICAgICAgIHJldHVybiBPLnUodDIpID8gdGhpc1tlMl0gOiB0aGlzLnNldChuMiwgdDIpOwogICAgICAgICAgICB9LCBtMi51bml4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy52YWx1ZU9mKCkgLyAxZTMpOwogICAgICAgICAgICB9LCBtMi52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGQuZ2V0VGltZSgpOwogICAgICAgICAgICB9LCBtMi5zdGFydE9mID0gZnVuY3Rpb24odDIsIGUyKSB7CiAgICAgICAgICAgICAgdmFyIG4yID0gdGhpcywgcjIgPSAhIU8udShlMikgfHwgZTIsIGgyID0gTy5wKHQyKSwgbDIgPSBmdW5jdGlvbih0MywgZTMpIHsKICAgICAgICAgICAgICAgIHZhciBpMiA9IE8udyhuMi4kdSA/IERhdGUuVVRDKG4yLiR5LCBlMywgdDMpIDogbmV3IERhdGUobjIuJHksIGUzLCB0MyksIG4yKTsKICAgICAgICAgICAgICAgIHJldHVybiByMiA/IGkyIDogaTIuZW5kT2YoYSk7CiAgICAgICAgICAgICAgfSwgJDIgPSBmdW5jdGlvbih0MywgZTMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBPLncobjIudG9EYXRlKClbdDNdLmFwcGx5KG4yLnRvRGF0ZSgicyIpLCAocjIgPyBbMCwgMCwgMCwgMF0gOiBbMjMsIDU5LCA1OSwgOTk5XSkuc2xpY2UoZTMpKSwgbjIpOwogICAgICAgICAgICAgIH0sIHkyID0gdGhpcy4kVywgTTMgPSB0aGlzLiRNLCBtMyA9IHRoaXMuJEQsIHYyID0gInNldCIgKyAodGhpcy4kdSA/ICJVVEMiIDogIiIpOwogICAgICAgICAgICAgIHN3aXRjaCAoaDIpIHsKICAgICAgICAgICAgICAgIGNhc2UgYzoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHIyID8gbDIoMSwgMCkgOiBsMigzMSwgMTEpOwogICAgICAgICAgICAgICAgY2FzZSBmOgogICAgICAgICAgICAgICAgICByZXR1cm4gcjIgPyBsMigxLCBNMykgOiBsMigwLCBNMyArIDEpOwogICAgICAgICAgICAgICAgY2FzZSBvOgogICAgICAgICAgICAgICAgICB2YXIgZzIgPSB0aGlzLiRsb2NhbGUoKS53ZWVrU3RhcnQgfHwgMCwgRDIgPSAoeTIgPCBnMiA/IHkyICsgNyA6IHkyKSAtIGcyOwogICAgICAgICAgICAgICAgICByZXR1cm4gbDIocjIgPyBtMyAtIEQyIDogbTMgKyAoNiAtIEQyKSwgTTMpOwogICAgICAgICAgICAgICAgY2FzZSBhOgogICAgICAgICAgICAgICAgY2FzZSBkOgogICAgICAgICAgICAgICAgICByZXR1cm4gJDIodjIgKyAiSG91cnMiLCAwKTsKICAgICAgICAgICAgICAgIGNhc2UgdToKICAgICAgICAgICAgICAgICAgcmV0dXJuICQyKHYyICsgIk1pbnV0ZXMiLCAxKTsKICAgICAgICAgICAgICAgIGNhc2UgczoKICAgICAgICAgICAgICAgICAgcmV0dXJuICQyKHYyICsgIlNlY29uZHMiLCAyKTsKICAgICAgICAgICAgICAgIGNhc2UgaToKICAgICAgICAgICAgICAgICAgcmV0dXJuICQyKHYyICsgIk1pbGxpc2Vjb25kcyIsIDMpOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvbmUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIG0yLmVuZE9mID0gZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydE9mKHQyLCBmYWxzZSk7CiAgICAgICAgICAgIH0sIG0yLiRzZXQgPSBmdW5jdGlvbih0MiwgZTIpIHsKICAgICAgICAgICAgICB2YXIgbjIsIG8yID0gTy5wKHQyKSwgaDIgPSAic2V0IiArICh0aGlzLiR1ID8gIlVUQyIgOiAiIiksIGwyID0gKG4yID0ge30sIG4yW2FdID0gaDIgKyAiRGF0ZSIsIG4yW2RdID0gaDIgKyAiRGF0ZSIsIG4yW2ZdID0gaDIgKyAiTW9udGgiLCBuMltjXSA9IGgyICsgIkZ1bGxZZWFyIiwgbjJbdV0gPSBoMiArICJIb3VycyIsIG4yW3NdID0gaDIgKyAiTWludXRlcyIsIG4yW2ldID0gaDIgKyAiU2Vjb25kcyIsIG4yW3JdID0gaDIgKyAiTWlsbGlzZWNvbmRzIiwgbjIpW28yXSwgJDIgPSBvMiA9PT0gYSA/IHRoaXMuJEQgKyAoZTIgLSB0aGlzLiRXKSA6IGUyOwogICAgICAgICAgICAgIGlmIChvMiA9PT0gZiB8fCBvMiA9PT0gYykgewogICAgICAgICAgICAgICAgdmFyIHkyID0gdGhpcy5jbG9uZSgpLnNldChkLCAxKTsKICAgICAgICAgICAgICAgIHkyLiRkW2wyXSgkMiksIHkyLmluaXQoKSwgdGhpcy4kZCA9IHkyLnNldChkLCBNYXRoLm1pbih0aGlzLiRELCB5Mi5kYXlzSW5Nb250aCgpKSkuJGQ7CiAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICBsMiAmJiB0aGlzLiRkW2wyXSgkMik7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdCgpLCB0aGlzOwogICAgICAgICAgICB9LCBtMi5zZXQgPSBmdW5jdGlvbih0MiwgZTIpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jbG9uZSgpLiRzZXQodDIsIGUyKTsKICAgICAgICAgICAgfSwgbTIuZ2V0ID0gZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpc1tPLnAodDIpXSgpOwogICAgICAgICAgICB9LCBtMi5hZGQgPSBmdW5jdGlvbihyMiwgaDIpIHsKICAgICAgICAgICAgICB2YXIgZDIsIGwyID0gdGhpczsKICAgICAgICAgICAgICByMiA9IE51bWJlcihyMik7CiAgICAgICAgICAgICAgdmFyICQyID0gTy5wKGgyKSwgeTIgPSBmdW5jdGlvbih0MikgewogICAgICAgICAgICAgICAgdmFyIGUyID0gdyhsMik7CiAgICAgICAgICAgICAgICByZXR1cm4gTy53KGUyLmRhdGUoZTIuZGF0ZSgpICsgTWF0aC5yb3VuZCh0MiAqIHIyKSksIGwyKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmICgkMiA9PT0gZikKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChmLCB0aGlzLiRNICsgcjIpOwogICAgICAgICAgICAgIGlmICgkMiA9PT0gYykKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldChjLCB0aGlzLiR5ICsgcjIpOwogICAgICAgICAgICAgIGlmICgkMiA9PT0gYSkKICAgICAgICAgICAgICAgIHJldHVybiB5MigxKTsKICAgICAgICAgICAgICBpZiAoJDIgPT09IG8pCiAgICAgICAgICAgICAgICByZXR1cm4geTIoNyk7CiAgICAgICAgICAgICAgdmFyIE0zID0gKGQyID0ge30sIGQyW3NdID0gZSwgZDJbdV0gPSBuLCBkMltpXSA9IHQsIGQyKVskMl0gfHwgMSwgbTMgPSB0aGlzLiRkLmdldFRpbWUoKSArIHIyICogTTM7CiAgICAgICAgICAgICAgcmV0dXJuIE8udyhtMywgdGhpcyk7CiAgICAgICAgICAgIH0sIG0yLnN1YnRyYWN0ID0gZnVuY3Rpb24odDIsIGUyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkKC0xICogdDIsIGUyKTsKICAgICAgICAgICAgfSwgbTIuZm9ybWF0ID0gZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgICB2YXIgZTIgPSB0aGlzLCBuMiA9IHRoaXMuJGxvY2FsZSgpOwogICAgICAgICAgICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpCiAgICAgICAgICAgICAgICByZXR1cm4gbjIuaW52YWxpZERhdGUgfHwgbDsKICAgICAgICAgICAgICB2YXIgcjIgPSB0MiB8fCAiWVlZWS1NTS1ERFRISDptbTpzc1oiLCBpMiA9IE8ueih0aGlzKSwgczIgPSB0aGlzLiRILCB1MiA9IHRoaXMuJG0sIGEyID0gdGhpcy4kTSwgbzIgPSBuMi53ZWVrZGF5cywgZjIgPSBuMi5tb250aHMsIGgyID0gZnVuY3Rpb24odDMsIG4zLCBpMywgczMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0MyAmJiAodDNbbjNdIHx8IHQzKGUyLCByMikpIHx8IGkzW24zXS5zbGljZSgwLCBzMyk7CiAgICAgICAgICAgICAgfSwgYzIgPSBmdW5jdGlvbih0MykgewogICAgICAgICAgICAgICAgcmV0dXJuIE8ucyhzMiAlIDEyIHx8IDEyLCB0MywgIjAiKTsKICAgICAgICAgICAgICB9LCBkMiA9IG4yLm1lcmlkaWVtIHx8IGZ1bmN0aW9uKHQzLCBlMywgbjMpIHsKICAgICAgICAgICAgICAgIHZhciByMyA9IHQzIDwgMTIgPyAiQU0iIDogIlBNIjsKICAgICAgICAgICAgICAgIHJldHVybiBuMyA/IHIzLnRvTG93ZXJDYXNlKCkgOiByMzsKICAgICAgICAgICAgICB9LCAkMiA9IHsgWVk6IFN0cmluZyh0aGlzLiR5KS5zbGljZSgtMiksIFlZWVk6IHRoaXMuJHksIE06IGEyICsgMSwgTU06IE8ucyhhMiArIDEsIDIsICIwIiksIE1NTTogaDIobjIubW9udGhzU2hvcnQsIGEyLCBmMiwgMyksIE1NTU06IGgyKGYyLCBhMiksIEQ6IHRoaXMuJEQsIEREOiBPLnModGhpcy4kRCwgMiwgIjAiKSwgZDogU3RyaW5nKHRoaXMuJFcpLCBkZDogaDIobjIud2Vla2RheXNNaW4sIHRoaXMuJFcsIG8yLCAyKSwgZGRkOiBoMihuMi53ZWVrZGF5c1Nob3J0LCB0aGlzLiRXLCBvMiwgMyksIGRkZGQ6IG8yW3RoaXMuJFddLCBIOiBTdHJpbmcoczIpLCBISDogTy5zKHMyLCAyLCAiMCIpLCBoOiBjMigxKSwgaGg6IGMyKDIpLCBhOiBkMihzMiwgdTIsIHRydWUpLCBBOiBkMihzMiwgdTIsIGZhbHNlKSwgbTogU3RyaW5nKHUyKSwgbW06IE8ucyh1MiwgMiwgIjAiKSwgczogU3RyaW5nKHRoaXMuJHMpLCBzczogTy5zKHRoaXMuJHMsIDIsICIwIiksIFNTUzogTy5zKHRoaXMuJG1zLCAzLCAiMCIpLCBaOiBpMiB9OwogICAgICAgICAgICAgIHJldHVybiByMi5yZXBsYWNlKHksIGZ1bmN0aW9uKHQzLCBlMykgewogICAgICAgICAgICAgICAgcmV0dXJuIGUzIHx8ICQyW3QzXSB8fCBpMi5yZXBsYWNlKCI6IiwgIiIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCBtMi51dGNPZmZzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gMTUgKiAtTWF0aC5yb3VuZCh0aGlzLiRkLmdldFRpbWV6b25lT2Zmc2V0KCkgLyAxNSk7CiAgICAgICAgICAgIH0sIG0yLmRpZmYgPSBmdW5jdGlvbihyMiwgZDIsIGwyKSB7CiAgICAgICAgICAgICAgdmFyICQyLCB5MiA9IE8ucChkMiksIE0zID0gdyhyMiksIG0zID0gKE0zLnV0Y09mZnNldCgpIC0gdGhpcy51dGNPZmZzZXQoKSkgKiBlLCB2MiA9IHRoaXMgLSBNMywgZzIgPSBPLm0odGhpcywgTTMpOwogICAgICAgICAgICAgIHJldHVybiBnMiA9ICgkMiA9IHt9LCAkMltjXSA9IGcyIC8gMTIsICQyW2ZdID0gZzIsICQyW2hdID0gZzIgLyAzLCAkMltvXSA9ICh2MiAtIG0zKSAvIDYwNDhlNSwgJDJbYV0gPSAodjIgLSBtMykgLyA4NjRlNSwgJDJbdV0gPSB2MiAvIG4sICQyW3NdID0gdjIgLyBlLCAkMltpXSA9IHYyIC8gdCwgJDIpW3kyXSB8fCB2MiwgbDIgPyBnMiA6IE8uYShnMik7CiAgICAgICAgICAgIH0sIG0yLmRheXNJbk1vbnRoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5kT2YoZikuJEQ7CiAgICAgICAgICAgIH0sIG0yLiRsb2NhbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gRFt0aGlzLiRMXTsKICAgICAgICAgICAgfSwgbTIubG9jYWxlID0gZnVuY3Rpb24odDIsIGUyKSB7CiAgICAgICAgICAgICAgaWYgKCF0MikKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRMOwogICAgICAgICAgICAgIHZhciBuMiA9IHRoaXMuY2xvbmUoKSwgcjIgPSBTKHQyLCBlMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHIyICYmIChuMi4kTCA9IHIyKSwgbjI7CiAgICAgICAgICAgIH0sIG0yLmNsb25lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE8udyh0aGlzLiRkLCB0aGlzKTsKICAgICAgICAgICAgfSwgbTIudG9EYXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMudmFsdWVPZigpKTsKICAgICAgICAgICAgfSwgbTIudG9KU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gdGhpcy50b0lTT1N0cmluZygpIDogbnVsbDsKICAgICAgICAgICAgfSwgbTIudG9JU09TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZC50b0lTT1N0cmluZygpOwogICAgICAgICAgICB9LCBtMi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLiRkLnRvVVRDU3RyaW5nKCk7CiAgICAgICAgICAgIH0sIE0yOwogICAgICAgICAgfSgpLCBUID0gXy5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gdy5wcm90b3R5cGUgPSBULCBbWyIkbXMiLCByXSwgWyIkcyIsIGldLCBbIiRtIiwgc10sIFsiJEgiLCB1XSwgWyIkVyIsIGFdLCBbIiRNIiwgZl0sIFsiJHkiLCBjXSwgWyIkRCIsIGRdXS5mb3JFYWNoKGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgIFRbdDJbMV1dID0gZnVuY3Rpb24oZTIpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZyhlMiwgdDJbMF0sIHQyWzFdKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0pLCB3LmV4dGVuZCA9IGZ1bmN0aW9uKHQyLCBlMikgewogICAgICAgICAgICByZXR1cm4gdDIuJGkgfHwgKHQyKGUyLCBfLCB3KSwgdDIuJGkgPSB0cnVlKSwgdzsKICAgICAgICAgIH0sIHcubG9jYWxlID0gUywgdy5pc0RheWpzID0gcCwgdy51bml4ID0gZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgcmV0dXJuIHcoMWUzICogdDIpOwogICAgICAgICAgfSwgdy5lbiA9IERbZ10sIHcuTHMgPSBELCB3LnAgPSB7fSwgdzsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVxdWlyZV91dGMgPSBfX2NvbW1vbkpTMih7CiAgICAgICIuLi8uLi9ub2RlX21vZHVsZXMvZGF5anMvcGx1Z2luL3V0Yy5qcyIoZXhwb3J0czMsIG1vZHVsZTIyKSB7CiAgICAgICAgIWZ1bmN0aW9uKHQsIGkpIHsKICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBleHBvcnRzMyAmJiAidW5kZWZpbmVkIiAhPSB0eXBlb2YgbW9kdWxlMjIgPyBtb2R1bGUyMi5leHBvcnRzID0gaSgpIDogImZ1bmN0aW9uIiA9PSB0eXBlb2YgZGVmaW5lICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoaSkgOiAodCA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBnbG9iYWxUaGlzID8gZ2xvYmFsVGhpcyA6IHQgfHwgc2VsZikuZGF5anNfcGx1Z2luX3V0YyA9IGkoKTsKICAgICAgICB9KGV4cG9ydHMzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICAgIHZhciB0ID0gIm1pbnV0ZSIsIGkgPSAvWystXVxkXGQoPzo6P1xkXGQpPy9nLCBlID0gLyhbKy1dfFxkXGQpL2c7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocywgZiwgbikgewogICAgICAgICAgICB2YXIgdSA9IGYucHJvdG90eXBlOwogICAgICAgICAgICBuLnV0YyA9IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgICAgdmFyIGkyID0geyBkYXRlOiB0MiwgdXRjOiB0cnVlLCBhcmdzOiBhcmd1bWVudHMgfTsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGYoaTIpOwogICAgICAgICAgICB9LCB1LnV0YyA9IGZ1bmN0aW9uKGkyKSB7CiAgICAgICAgICAgICAgdmFyIGUyID0gbih0aGlzLnRvRGF0ZSgpLCB7IGxvY2FsZTogdGhpcy4kTCwgdXRjOiB0cnVlIH0pOwogICAgICAgICAgICAgIHJldHVybiBpMiA/IGUyLmFkZCh0aGlzLnV0Y09mZnNldCgpLCB0KSA6IGUyOwogICAgICAgICAgICB9LCB1LmxvY2FsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG4odGhpcy50b0RhdGUoKSwgeyBsb2NhbGU6IHRoaXMuJEwsIHV0YzogZmFsc2UgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBvID0gdS5wYXJzZTsKICAgICAgICAgICAgdS5wYXJzZSA9IGZ1bmN0aW9uKHQyKSB7CiAgICAgICAgICAgICAgdDIudXRjICYmICh0aGlzLiR1ID0gdHJ1ZSksIHRoaXMuJHV0aWxzKCkudSh0Mi4kb2Zmc2V0KSB8fCAodGhpcy4kb2Zmc2V0ID0gdDIuJG9mZnNldCksIG8uY2FsbCh0aGlzLCB0Mik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciByID0gdS5pbml0OwogICAgICAgICAgICB1LmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAodGhpcy4kdSkgewogICAgICAgICAgICAgICAgdmFyIHQyID0gdGhpcy4kZDsKICAgICAgICAgICAgICAgIHRoaXMuJHkgPSB0Mi5nZXRVVENGdWxsWWVhcigpLCB0aGlzLiRNID0gdDIuZ2V0VVRDTW9udGgoKSwgdGhpcy4kRCA9IHQyLmdldFVUQ0RhdGUoKSwgdGhpcy4kVyA9IHQyLmdldFVUQ0RheSgpLCB0aGlzLiRIID0gdDIuZ2V0VVRDSG91cnMoKSwgdGhpcy4kbSA9IHQyLmdldFVUQ01pbnV0ZXMoKSwgdGhpcy4kcyA9IHQyLmdldFVUQ1NlY29uZHMoKSwgdGhpcy4kbXMgPSB0Mi5nZXRVVENNaWxsaXNlY29uZHMoKTsKICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIHIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGEgPSB1LnV0Y09mZnNldDsKICAgICAgICAgICAgdS51dGNPZmZzZXQgPSBmdW5jdGlvbihzMiwgZjIpIHsKICAgICAgICAgICAgICB2YXIgbjIgPSB0aGlzLiR1dGlscygpLnU7CiAgICAgICAgICAgICAgaWYgKG4yKHMyKSkKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiR1ID8gMCA6IG4yKHRoaXMuJG9mZnNldCkgPyBhLmNhbGwodGhpcykgOiB0aGlzLiRvZmZzZXQ7CiAgICAgICAgICAgICAgaWYgKCJzdHJpbmciID09IHR5cGVvZiBzMiAmJiAoczIgPSBmdW5jdGlvbih0MikgewogICAgICAgICAgICAgICAgdm9pZCAwID09PSB0MiAmJiAodDIgPSAiIik7CiAgICAgICAgICAgICAgICB2YXIgczMgPSB0Mi5tYXRjaChpKTsKICAgICAgICAgICAgICAgIGlmICghczMpCiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgdmFyIGYzID0gKCIiICsgczNbMF0pLm1hdGNoKGUpIHx8IFsiLSIsIDAsIDBdLCBuMyA9IGYzWzBdLCB1MyA9IDYwICogK2YzWzFdICsgK2YzWzJdOwogICAgICAgICAgICAgICAgcmV0dXJuIDAgPT09IHUzID8gMCA6ICIrIiA9PT0gbjMgPyB1MyA6IC11MzsKICAgICAgICAgICAgICB9KHMyKSwgbnVsbCA9PT0gczIpKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgICAgdmFyIHUyID0gTWF0aC5hYnMoczIpIDw9IDE2ID8gNjAgKiBzMiA6IHMyLCBvMiA9IHRoaXM7CiAgICAgICAgICAgICAgaWYgKGYyKQogICAgICAgICAgICAgICAgcmV0dXJuIG8yLiRvZmZzZXQgPSB1MiwgbzIuJHUgPSAwID09PSBzMiwgbzI7CiAgICAgICAgICAgICAgaWYgKDAgIT09IHMyKSB7CiAgICAgICAgICAgICAgICB2YXIgcjIgPSB0aGlzLiR1ID8gdGhpcy50b0RhdGUoKS5nZXRUaW1lem9uZU9mZnNldCgpIDogLTEgKiB0aGlzLnV0Y09mZnNldCgpOwogICAgICAgICAgICAgICAgKG8yID0gdGhpcy5sb2NhbCgpLmFkZCh1MiArIHIyLCB0KSkuJG9mZnNldCA9IHUyLCBvMi4keC4kbG9jYWxPZmZzZXQgPSByMjsKICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG8yID0gdGhpcy51dGMoKTsKICAgICAgICAgICAgICByZXR1cm4gbzI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBoID0gdS5mb3JtYXQ7CiAgICAgICAgICAgIHUuZm9ybWF0ID0gZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgICB2YXIgaTIgPSB0MiB8fCAodGhpcy4kdSA/ICJZWVlZLU1NLUREVEhIOm1tOnNzW1pdIiA6ICIiKTsKICAgICAgICAgICAgICByZXR1cm4gaC5jYWxsKHRoaXMsIGkyKTsKICAgICAgICAgICAgfSwgdS52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIHQyID0gdGhpcy4kdXRpbHMoKS51KHRoaXMuJG9mZnNldCkgPyAwIDogdGhpcy4kb2Zmc2V0ICsgKHRoaXMuJHguJGxvY2FsT2Zmc2V0IHx8IHRoaXMuJGQuZ2V0VGltZXpvbmVPZmZzZXQoKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGQudmFsdWVPZigpIC0gNmU0ICogdDI7CiAgICAgICAgICAgIH0sIHUuaXNVVEMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gISF0aGlzLiR1OwogICAgICAgICAgICB9LCB1LnRvSVNPU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9EYXRlKCkudG9JU09TdHJpbmcoKTsKICAgICAgICAgICAgfSwgdS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnRvRGF0ZSgpLnRvVVRDU3RyaW5nKCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBsID0gdS50b0RhdGU7CiAgICAgICAgICAgIHUudG9EYXRlID0gZnVuY3Rpb24odDIpIHsKICAgICAgICAgICAgICByZXR1cm4gInMiID09PSB0MiAmJiB0aGlzLiRvZmZzZXQgPyBuKHRoaXMuZm9ybWF0KCJZWVlZLU1NLUREIEhIOm1tOnNzOlNTUyIpKS50b0RhdGUoKSA6IGwuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGMgPSB1LmRpZmY7CiAgICAgICAgICAgIHUuZGlmZiA9IGZ1bmN0aW9uKHQyLCBpMiwgZTIpIHsKICAgICAgICAgICAgICBpZiAodDIgJiYgdGhpcy4kdSA9PT0gdDIuJHUpCiAgICAgICAgICAgICAgICByZXR1cm4gYy5jYWxsKHRoaXMsIHQyLCBpMiwgZTIpOwogICAgICAgICAgICAgIHZhciBzMiA9IHRoaXMubG9jYWwoKSwgZjIgPSBuKHQyKS5sb2NhbCgpOwogICAgICAgICAgICAgIHJldHVybiBjLmNhbGwoczIsIGYyLCBpMiwgZTIpOwogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgdHNjX2J1aWxkX2V4cG9ydHMgPSB7fTsKICAgIF9fZXhwb3J0KHRzY19idWlsZF9leHBvcnRzLCB7CiAgICAgIGRlZmF1bHQ6ICgpID0+IHRzY19idWlsZF9kZWZhdWx0CiAgICB9KTsKICAgIG1vZHVsZTIuZXhwb3J0cyA9IF9fdG9Db21tb25KUyh0c2NfYnVpbGRfZXhwb3J0cyk7CiAgICB2YXIgaW1wb3J0X2ZzX2V4dHJhID0gX190b0VTTShyZXF1aXJlX2xpYigpLCAxKTsKICAgIHZhciBpbXBvcnRfcGF0aCA9IF9fdG9FU00ocmVxdWlyZSgicGF0aCIpLCAxKTsKICAgIGZ1bmN0aW9uIGlucHV0KGZpbGVOYW1lKSB7CiAgICAgIGxldCBmcCA9IGltcG9ydF9wYXRoLmRlZmF1bHQuam9pbihwcm9jZXNzLmN3ZCgpLCBmaWxlTmFtZSk7CiAgICAgIGlmIChpbXBvcnRfcGF0aC5kZWZhdWx0LmlzQWJzb2x1dGUoZmlsZU5hbWUpKQogICAgICAgIGZwID0gZmlsZU5hbWU7CiAgICAgIGlmICghaW1wb3J0X2ZzX2V4dHJhLmRlZmF1bHQuZXhpc3RzU3luYyhmcCkpIHsKICAgICAgICBjb25zb2xlLmxvZyhgRklMRSBOT1QgRk9VTkQ6ICR7ZnB9YCk7CiAgICAgICAgcHJvY2Vzcy5leGl0KDEpOwogICAgICB9CiAgICAgIGNvbnN0IGZpbGUgPSBpbXBvcnRfZnNfZXh0cmEuZGVmYXVsdC5yZWFkRmlsZVN5bmMoZnApOwogICAgICByZXR1cm4gZmlsZS50b1N0cmluZygpOwogICAgfQogICAgdmFyIGltcG9ydF9hcmNzZWNvbmQgPSBfX3RvRVNNKHJlcXVpcmVfYXJjc2Vjb25kKCksIDEpOwogICAgdmFyIGltcG9ydF9kYXlqcyA9IF9fdG9FU00ocmVxdWlyZV9kYXlqc19taW4oKSwgMSk7CiAgICB2YXIgaW1wb3J0X3V0YyA9IF9fdG9FU00ocmVxdWlyZV91dGMoKSwgMSk7CiAgICBpbXBvcnRfZGF5anMuZGVmYXVsdC5leHRlbmQoaW1wb3J0X3V0Yy5kZWZhdWx0KTsKICAgIGZ1bmN0aW9uIG1ldGFkYXRhUmVtb3Zlcl9kZWZhdWx0KGZpbGUsIGZpbGVuYW1lKSB7CiAgICAgIGNvbnN0IGxpbmVzID0gZmlsZS5zcGxpdCgiXG4iKTsKICAgICAgbGV0IHJlYWRpbmdNZXRhZGF0YSA9IGZhbHNlOwogICAgICBjb25zdCBtZXRhRGF0YVNlY3Rpb24gPSBbXTsKICAgICAgY29uc3Qgbm9ybWFsU2VjdGlvbiA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbGluZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBjb25zdCB0aGlzTGluZSA9IGxpbmVzW2ldOwogICAgICAgIGlmIChpID09PSAwICYmIHRoaXNMaW5lID09PSAiLS0tIikgewogICAgICAgICAgcmVhZGluZ01ldGFkYXRhID0gdHJ1ZTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAocmVhZGluZ01ldGFkYXRhKSB7CiAgICAgICAgICBpZiAodGhpc0xpbmUgIT0gIi0tLSIpIHsKICAgICAgICAgICAgbWV0YURhdGFTZWN0aW9uLnB1c2godGhpc0xpbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVhZGluZ01ldGFkYXRhID0gZmFsc2U7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBub3JtYWxTZWN0aW9uLnB1c2godGhpc0xpbmUpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBtZXRhZGF0YVBhcnNlciA9ICgwLCBpbXBvcnRfYXJjc2Vjb25kLnNlcXVlbmNlT2YpKFsKICAgICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZC5tYW55KSgoMCwgaW1wb3J0X2FyY3NlY29uZC5hbnlDaGFyRXhjZXB0KSgoMCwgaW1wb3J0X2FyY3NlY29uZC5jaGFyKSgiOiIpKSksCiAgICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQuY2hhcikoIjoiKSwKICAgICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZC5tYW55KShpbXBvcnRfYXJjc2Vjb25kLmFueUNoYXIpCiAgICAgIF0pOwogICAgICBjb25zdCBtZXRhZGF0YSA9IHsKICAgICAgICB0aXRsZTogIiIsCiAgICAgICAgaW1hZ2U6ICIiLAogICAgICAgIGRlc2NyaXB0aW9uOiAiIiwKICAgICAgICBkYXRlOiBudWxsLAogICAgICAgIG90aGVyTWV0YWRhdGE6IHt9CiAgICAgIH07CiAgICAgIG1ldGFEYXRhU2VjdGlvbi5mb3JFYWNoKChsaW5lKSA9PiB7CiAgICAgICAgY29uc3QgbWV0YVBhcnNlID0gbWV0YWRhdGFQYXJzZXIucnVuKGxpbmUpOwogICAgICAgIGlmICghbWV0YVBhcnNlLmlzRXJyb3IpIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG1ldGFQYXJzZS5yZXN1bHQ7CiAgICAgICAgICBjb25zdCBrZXkgPSByZXN1bHRbMF0uam9pbigiIikudHJpbSgpOwogICAgICAgICAgY29uc3QgdmFsID0gcmVzdWx0WzJdLmpvaW4oIiIpLnRyaW0oKTsKICAgICAgICAgIGlmIChrZXkgaW4gbWV0YWRhdGEgJiYga2V5ICE9ICJvdGhlck1ldGFkYXRhIikgewogICAgICAgICAgICBpZiAoa2V5ICE9ICJkYXRlIikgewogICAgICAgICAgICAgIG1ldGFkYXRhW2tleV0gPSB2YWw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbWV0YWRhdGEuZGF0ZSA9IGltcG9ydF9kYXlqcy5kZWZhdWx0LnV0Yyh2YWwpOwogICAgICAgICAgICAgIGlmICghbWV0YWRhdGEuZGF0ZS5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJJTlZBTElEIERBVEU6IiwgdmFsKTsKICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1ldGFkYXRhLm90aGVyTWV0YWRhdGFba2V5XSA9IHZhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBpZiAobWV0YWRhdGEudGl0bGUgPT0gIiIgfHwgbWV0YWRhdGEuZGVzY3JpcHRpb24gPT0gIiIgfHwgbWV0YWRhdGEuZGF0ZSA9PSBudWxsKSB7CiAgICAgICAgY29uc29sZS5sb2coYGVycm9yIHBhcnNpbmcgJHtmaWxlbmFtZX0uIE1pc3NpbmcgcmVxdWlyZWQgZmllbGRzYCwgbWV0YWRhdGEpOwogICAgICAgIHByb2Nlc3MuZXhpdCgxKTsKICAgICAgfQogICAgICByZXR1cm4gW25vcm1hbFNlY3Rpb24uam9pbigiXG4iKSwgbWV0YWRhdGFdOwogICAgfQogICAgdmFyIGltcG9ydF9hcmNzZWNvbmQyID0gX190b0VTTShyZXF1aXJlX2FyY3NlY29uZCgpLCAxKTsKICAgIHZhciBpbXBvcnRfdXRpbCA9IF9fdG9FU00ocmVxdWlyZSgidXRpbCIpLCAxKTsKICAgIHZhciBwdW5jdHVhdGlvbiA9IFsKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCIuIiksCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiLCIpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIj8iKSwKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCI6IiksCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiOyIpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIiEiKSwKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCIvIiksCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiJyIpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoYCJgKQogICAgXTsKICAgIHZhciBiYXNlQ2hhcmFjdGVycyA9IFtpbXBvcnRfYXJjc2Vjb25kMi5sZXR0ZXIsIGltcG9ydF9hcmNzZWNvbmQyLmRpZ2l0LCBpbXBvcnRfYXJjc2Vjb25kMi53aGl0ZXNwYWNlXTsKICAgIHZhciBzeW1ib2xzID0gWwogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIiMiKSwKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCIrIiksCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiPSIpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIi0iKSwKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCIlIiksCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiYCIpCiAgICBdOwogICAgdmFyIGJpID0gWygwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiKiIpLCAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIl8iKV07CiAgICB2YXIgc3BlY2lhbFB1bmN0dWF0aW9uID0gWygwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiKCIpLCAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIikiKV07CiAgICB2YXIgc3RyaW5nQ2hhcnMgPSAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hvaWNlKShbCiAgICAgIC4uLnB1bmN0dWF0aW9uLAogICAgICAuLi5iYXNlQ2hhcmFjdGVycywKICAgICAgLi4uc3ltYm9scywKICAgICAgLi4uYmksCiAgICAgIC4uLnNwZWNpYWxQdW5jdHVhdGlvbgogICAgXSk7CiAgICB2YXIgbGlua1N0cmluZ0NoYXJzID0gKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNob2ljZSkoWy4uLnB1bmN0dWF0aW9uLCAuLi5iYXNlQ2hhcmFjdGVycywgLi4uc3ltYm9sc10pOwogICAgdmFyIHN0cmluZyA9ICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5tYW55KShzdHJpbmdDaGFycyk7CiAgICB2YXIgbGlua1N0cmluZyA9ICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5tYW55KShsaW5rU3RyaW5nQ2hhcnMpOwogICAgdmFyIGhlYWRpbmdQYXJzZXIgPSAoMCwgaW1wb3J0X2FyY3NlY29uZDIuc2VxdWVuY2VPZikoWygwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiIyIpLCAoMCwgaW1wb3J0X2FyY3NlY29uZDIubWFueSkoKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCIjIikpLCAoMCwgaW1wb3J0X2FyY3NlY29uZDIuc2tpcCkoc3RyaW5nKV0pOwogICAgdmFyIGRpdmlkZXJQYXJzZXIgPSAoMCwgaW1wb3J0X2FyY3NlY29uZDIuc3RyKSgiLS0tIik7CiAgICB2YXIgb2xQYXJzZXIgPSAoMCwgaW1wb3J0X2FyY3NlY29uZDIuc2VxdWVuY2VPZikoWygwLCBpbXBvcnRfYXJjc2Vjb25kMi5tYW55KShpbXBvcnRfYXJjc2Vjb25kMi5kaWdpdCksICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiLiIpLCBpbXBvcnRfYXJjc2Vjb25kMi53aGl0ZXNwYWNlLCAoMCwgaW1wb3J0X2FyY3NlY29uZDIuc2tpcCkoc3RyaW5nKV0pOwogICAgdmFyIHVsUGFyc2VyID0gKDAsIGltcG9ydF9hcmNzZWNvbmQyLnNlcXVlbmNlT2YpKFsKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLm1hbnkpKGltcG9ydF9hcmNzZWNvbmQyLndoaXRlc3BhY2UpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIi0iKSwKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLm1hbnkpKGltcG9ydF9hcmNzZWNvbmQyLndoaXRlc3BhY2UpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuc2tpcCkoc3RyaW5nKQogICAgXSk7CiAgICB2YXIgbGlua1BhcnNlciA9ICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5zZXF1ZW5jZU9mKShbCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiWyIpLAogICAgICBsaW5rU3RyaW5nLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIuY2hhcikoIl0iKSwKICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQyLmNoYXIpKCIoIiksCiAgICAgIGxpbmtTdHJpbmcsCiAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5jaGFyKSgiKSIpLAogICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDIubWFueSkoaW1wb3J0X2FyY3NlY29uZDIud2hpdGVzcGFjZSkKICAgIF0pOwogICAgZnVuY3Rpb24gd3JhcFdpdGhSZXN0cmljdGVkU3RyaW5nKHApIHsKICAgICAgcmV0dXJuICgwLCBpbXBvcnRfYXJjc2Vjb25kMi5uYW1lZFNlcXVlbmNlT2YpKFsKICAgICAgICBbInByZSIsIHN0cmluZ10sCiAgICAgICAgWyJjb250ZW50IiwgcF0sCiAgICAgICAgWyJwb3N0Iiwgc3RyaW5nXQogICAgICBdKTsKICAgIH0KICAgIGZ1bmN0aW9uIGxhc3RFbChhcnIpIHsKICAgICAgaWYgKGFyci5sZW5ndGggPiAwKSB7CiAgICAgICAgcmV0dXJuIGFyclthcnIubGVuZ3RoIC0gMV07CiAgICAgIH0gZWxzZQogICAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gZmlsZXBhcnNlcl9kZWZhdWx0KGZpbGVDb250ZW50cykgewogICAgICBjb25zdCBsaW5lcyA9IGZpbGVDb250ZW50cy5zcGxpdCgiXG4iKTsKICAgICAgY29uc3QgdHJlZSA9IFtdOwogICAgICBjb25zdCBsaXN0SXRlbXMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGxpbmVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgY29uc3QgdGhpc0xpbmUgPSBsaW5lc1tpXTsKICAgICAgICBjb25zdCB0cmltbWVkID0gdGhpc0xpbmUudHJpbSgpOwogICAgICAgIGlmICh0cmltbWVkID09ICIiKQogICAgICAgICAgY29udGludWU7CiAgICAgICAgY29uc3QgdG9rZW4gPSBwYXJzZUxpbmUodHJpbW1lZCk7CiAgICAgICAgaWYgKGxhc3RFbChsaXN0SXRlbXMpICYmICFsYXN0RWwobGlzdEl0ZW1zKS5jbG9zZWQpIHsKICAgICAgICAgIGNvbnN0IGxhdGVzdEl0ZW0gPSBsYXN0RWwobGlzdEl0ZW1zKTsKICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IGxhdGVzdEl0ZW0ubGlzdEl0ZW1zWzBdLnR5cGUgJiYgKHRva2VuLnR5cGUgPT0gIk9MIiB8fCB0b2tlbi50eXBlID09ICJVTCIpKSB7CiAgICAgICAgICAgIGxhdGVzdEl0ZW0ubGlzdEl0ZW1zLnB1c2godG9rZW4pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGF0ZXN0SXRlbS5jbG9zZWQgPSB0cnVlOwogICAgICAgICAgICB0cmVlLnB1c2gobGF0ZXN0SXRlbSk7CiAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09ICJPTCIgfHwgdG9rZW4udHlwZSA9PSAiVUwiKSB7CiAgICAgICAgICAgICAgbGlzdEl0ZW1zLnB1c2goewogICAgICAgICAgICAgICAgY2xvc2VkOiBmYWxzZSwKICAgICAgICAgICAgICAgIGxpc3RJdGVtczogW3Rva2VuXSwKICAgICAgICAgICAgICAgIHR5cGU6ICJMSVNUSVRFTSIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cmVlLnB1c2godG9rZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh0b2tlbi50eXBlID09ICJPTCIgfHwgdG9rZW4udHlwZSA9PSAiVUwiKSB7CiAgICAgICAgICBsaXN0SXRlbXMucHVzaCh7CiAgICAgICAgICAgIGNsb3NlZDogZmFsc2UsCiAgICAgICAgICAgIGxpc3RJdGVtczogW3Rva2VuXSwKICAgICAgICAgICAgdHlwZTogIkxJU1RJVEVNIgogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlCiAgICAgICAgICB0cmVlLnB1c2godG9rZW4pOwogICAgICB9CiAgICAgIGlmIChsYXN0RWwobGlzdEl0ZW1zKSAmJiAhbGFzdEVsKGxpc3RJdGVtcykuY2xvc2VkKSB7CiAgICAgICAgbGFzdEVsKGxpc3RJdGVtcykuY2xvc2VkID0gdHJ1ZTsKICAgICAgICB0cmVlLnB1c2gobGFzdEVsKGxpc3RJdGVtcykpOwogICAgICB9CiAgICAgIGNvbnN0IGRlYnVnVHJlZSA9IGltcG9ydF91dGlsLmRlZmF1bHQuaW5zcGVjdCh0cmVlLCBmYWxzZSwgbnVsbCwgdHJ1ZSk7CiAgICAgIHJldHVybiB0cmVlOwogICAgfQogICAgZnVuY3Rpb24gcGFyc2VMaW5lKGxpbmUpIHsKICAgICAgaWYgKGxpbmUuZW5kc1dpdGgoIlxyIikpIHsKICAgICAgICBsaW5lLnNsaWNlKDAsIC0yKTsKICAgICAgfQogICAgICBjb25zdCBociA9IGhlYWRpbmdQYXJzZXIucnVuKGxpbmUpOwogICAgICBjb25zdCBvbCA9IG9sUGFyc2VyLnJ1bihsaW5lKTsKICAgICAgY29uc3QgdWwgPSB1bFBhcnNlci5ydW4obGluZSk7CiAgICAgIGNvbnN0IGRwID0gZGl2aWRlclBhcnNlci5ydW4obGluZSk7CiAgICAgIGlmICghaHIuaXNFcnJvcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGhyLnJlc3VsdDsKICAgICAgICBjb25zdCBuZXdMaW5lID0gbGluZS5zbGljZShyZXN1bHRbMV0ubGVuZ3RoICsgMSk7CiAgICAgICAgY29uc3Qgc3ViVG9rZW4gPSBwYXJhbWV0ZXJpc2VkUGFyc2luZyhuZXdMaW5lKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHlwZTogIkhFQURJTkciLAogICAgICAgICAgc3ViVG9rZW4sCiAgICAgICAgICBsZXZlbDogcmVzdWx0WzFdLmxlbmd0aCArIDEKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKCFkcC5pc0Vycm9yKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICJESVZJREVSIgogICAgICAgIH07CiAgICAgIH0gZWxzZSBpZiAoIW9sLmlzRXJyb3IpIHsKICAgICAgICBjb25zdCBuZXdMaW5lID0gbGluZS5zbGljZShvbC5yZXN1bHRbMF0ubGVuZ3RoICsgMik7CiAgICAgICAgY29uc3Qgc3ViVG9rZW4gPSBwYXJhbWV0ZXJpc2VkUGFyc2luZyhuZXdMaW5lKTsKICAgICAgICByZXR1cm4geyB0eXBlOiAiT0wiLCBzdWJUb2tlbiB9OwogICAgICB9IGVsc2UgaWYgKCF1bC5pc0Vycm9yKSB7CiAgICAgICAgY29uc3QgbmV3TGluZSA9IGxpbmUuc2xpY2UoCiAgICAgICAgICAvL0B0cy1leHBlY3QtZXJyb3IKICAgICAgICAgIHVsLnJlc3VsdFswXS5sZW5ndGggKyAxICsgdWwucmVzdWx0WzJdLmxlbmd0aAogICAgICAgICk7CiAgICAgICAgY29uc3Qgc3ViVG9rZW4gPSBwYXJhbWV0ZXJpc2VkUGFyc2luZyhuZXdMaW5lKTsKICAgICAgICByZXR1cm4geyB0eXBlOiAiVUwiLCBzdWJUb2tlbiB9OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHN1YlRva2VuID0gcGFyYW1ldGVyaXNlZFBhcnNpbmcobGluZSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICJQQVJBR1JBUEgiLAogICAgICAgICAgc3ViVG9rZW4KICAgICAgICB9OwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBwYXJhbWV0ZXJpc2VkUGFyc2luZyhzdHIzKSB7CiAgICAgIHJldHVybiBpblN0cmluZ1BhcnNpbmcoc3RyMyk7CiAgICB9CiAgICBmdW5jdGlvbiBmb3JtU3RyaW5nRnJvbUFsbFJlc3VsdHMocmVzdWx0KSB7CiAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gcmVzdWx0Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRbaV0pKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHRbaV0uam9pbigiIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQuam9pbigiIik7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGluU3RyaW5nUGFyc2luZyhzdHIzKSB7CiAgICAgIGlmIChzdHIzID09ICIiKQogICAgICAgIHJldHVybiBudWxsOwogICAgICBjb25zdCBsaW5rSW5TdHJpbmcgPSB3cmFwV2l0aFJlc3RyaWN0ZWRTdHJpbmcobGlua1BhcnNlcik7CiAgICAgIGNvbnN0IGxwID0gbGlua0luU3RyaW5nLnJ1bihzdHIzKTsKICAgICAgY29uc3QgbHByID0gaW5saW5lUGFyc2luZyhscCwgIkxJTksiKTsKICAgICAgaWYgKGxwcikgewogICAgICAgIHJldHVybiBscHI7CiAgICAgIH0gZWxzZQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAiTElURVJBTCIsCiAgICAgICAgICB0ZXh0OiBzdHIzCiAgICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGlubGluZVBhcnNpbmcocCwgdHlwZSkgewogICAgICBpZiAoIXAuaXNFcnJvcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IHAucmVzdWx0OwogICAgICAgIGNvbnN0IHByZVN0ciA9IGZvcm1TdHJpbmdGcm9tQWxsUmVzdWx0cyhyZXN1bHQucHJlKTsKICAgICAgICBjb25zdCBwb3N0U3RyID0gZm9ybVN0cmluZ0Zyb21BbGxSZXN1bHRzKHJlc3VsdC5wb3N0KTsKICAgICAgICBjb25zdCBwcmVUb2tlbiA9IGluU3RyaW5nUGFyc2luZyhwcmVTdHIpOwogICAgICAgIGNvbnN0IHBvc3RUb2tlbiA9IGluU3RyaW5nUGFyc2luZyhwb3N0U3RyKTsKICAgICAgICBjb25zdCBzdWJUb2tlbnMgPSBbXTsKICAgICAgICBpZiAocHJlVG9rZW4pIHsKICAgICAgICAgIGlmIChwcmVUb2tlbi50eXBlID09ICJJTkxJTkUiKSB7CiAgICAgICAgICAgIHN1YlRva2Vucy5wdXNoKC4uLnByZVRva2VuLnN1YlRva2Vucyk7CiAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgc3ViVG9rZW5zLnB1c2gocHJlVG9rZW4pOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb250ZW50ID0gcmVzdWx0LmNvbnRlbnQ7CiAgICAgICAgY29uc3Qgc3ViVG9rZW4gPSBpblN0cmluZ1BhcnNpbmcoZm9ybVN0cmluZ0Zyb21BbGxSZXN1bHRzKGNvbnRlbnRbMV0pKTsKICAgICAgICBjb25zdCB1cmwgPSBmb3JtU3RyaW5nRnJvbUFsbFJlc3VsdHMoY29udGVudFs0XSk7CiAgICAgICAgc3ViVG9rZW5zLnB1c2goewogICAgICAgICAgdHlwZTogIkxJTksiLAogICAgICAgICAgc3ViVG9rZW4sCiAgICAgICAgICB1cmwKICAgICAgICB9KTsKICAgICAgICBpZiAocG9zdFRva2VuKSB7CiAgICAgICAgICBpZiAocG9zdFRva2VuLnR5cGUgPT0gIklOTElORSIpIHsKICAgICAgICAgICAgc3ViVG9rZW5zLnB1c2goLi4ucG9zdFRva2VuLnN1YlRva2Vucyk7CiAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgc3ViVG9rZW5zLnB1c2gocG9zdFRva2VuKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICJJTkxJTkUiLAogICAgICAgICAgc3ViVG9rZW5zCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfQogICAgdmFyIGltcG9ydF9hcmNzZWNvbmQzID0gX190b0VTTShyZXF1aXJlX2FyY3NlY29uZCgpLCAxKTsKICAgIGZ1bmN0aW9uIGdlbmVyYXRvcl9kZWZhdWx0KGFzdCkgewogICAgICByZXR1cm4gZG9MaXN0KGFzdCk7CiAgICB9CiAgICBmdW5jdGlvbiBkb0xpc3QodG9rZW5MaXN0KSB7CiAgICAgIGNvbnN0IGh0bWxTdGF0ZW1lbnRzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0b2tlbkxpc3QubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBjb25zdCB0b2tlbiA9IHRva2VuTGlzdFtpXTsKICAgICAgICB0cnkgewogICAgICAgICAgaHRtbFN0YXRlbWVudHMucHVzaCh0b2tlblRyZWUodG9rZW4pKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiRVJST1IgR0VORVJBVElORyBUT0tFTiBGT1IgIiwgdG9rZW4pOwogICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBodG1sU3RhdGVtZW50cy5qb2luKCJcbiIpOwogICAgfQogICAgZnVuY3Rpb24gdG9rZW5UcmVlKHRva2VuKSB7CiAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgIGNhc2UgIkhFQURJTkciOgogICAgICAgICAgcmV0dXJuIGRvSGVhZGluZyh0b2tlbik7CiAgICAgICAgY2FzZSAiQk9MRCI6CiAgICAgICAgICByZXR1cm4gZG9Cb2xkKHRva2VuKTsKICAgICAgICBjYXNlICJESVZJREVSIjoKICAgICAgICAgIHJldHVybiBkb0RpdmlkZXIoKTsKICAgICAgICBjYXNlICJJTkxJTkUiOgogICAgICAgICAgcmV0dXJuIGRvSW5saW5lKHRva2VuKTsKICAgICAgICBjYXNlICJJVEFMSUMiOgogICAgICAgICAgcmV0dXJuIGRvSXRhbGljKHRva2VuKTsKICAgICAgICBjYXNlICJMSVNUSVRFTSI6CiAgICAgICAgICByZXR1cm4gZG9MaXN0SXRlbSh0b2tlbik7CiAgICAgICAgY2FzZSAiTElURVJBTCI6CiAgICAgICAgICByZXR1cm4gaW5zZXJ0Qm9sZEl0YWxpYyh0b2tlbi50ZXh0KTsKICAgICAgICBjYXNlICJPTCI6CiAgICAgICAgY2FzZSAiVUwiOgogICAgICAgICAgcmV0dXJuIGRvTGlzdEVsZW1lbnQodG9rZW4pOwogICAgICAgIGNhc2UgIlBBUkFHUkFQSCI6CiAgICAgICAgICByZXR1cm4gZG9QYXJhZ3JhcGgodG9rZW4pOwogICAgICAgIGNhc2UgIkxJTksiOgogICAgICAgICAgcmV0dXJuIGRvTGluayh0b2tlbik7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRvSGVhZGluZyh0b2tlbikgewogICAgICBjb25zdCBjb250ZW50ID0gdG9rZW5UcmVlKHRva2VuLnN1YlRva2VuKTsKICAgICAgcmV0dXJuIGA8aCR7dG9rZW4ubGV2ZWx9PiR7Y29udGVudH08L2gke3Rva2VuLmxldmVsfT5gOwogICAgfQogICAgZnVuY3Rpb24gZG9Cb2xkKHRva2VuKSB7CiAgICAgIGNvbnN0IGNvbnRlbnQgPSB0b2tlblRyZWUodG9rZW4uc3ViVG9rZW4pOwogICAgICByZXR1cm4gYDxiPiR7Y29udGVudH08L2I+YDsKICAgIH0KICAgIGZ1bmN0aW9uIGRvRGl2aWRlcigpIHsKICAgICAgcmV0dXJuIGA8ZGl2IGNsYXNzPSJkaXZpZGVyIiAvPmA7CiAgICB9CiAgICBmdW5jdGlvbiBkb0lubGluZSh0b2tlbikgewogICAgICByZXR1cm4gZG9MaXN0KHRva2VuLnN1YlRva2Vucyk7CiAgICB9CiAgICBmdW5jdGlvbiBkb0l0YWxpYyh0b2tlbikgewogICAgICBjb25zdCBjb250ZW50ID0gdG9rZW5UcmVlKHRva2VuLnN1YlRva2VuKTsKICAgICAgcmV0dXJuIGA8aT4ke2NvbnRlbnR9PC9pPmA7CiAgICB9CiAgICBmdW5jdGlvbiBkb0xpc3RJdGVtKHRva2VuKSB7CiAgICAgIGNvbnN0IHN1Ykxpc3QgPSBkb0xpc3QodG9rZW4ubGlzdEl0ZW1zKTsKICAgICAgY29uc3QgdHlwZSA9IHRva2VuLmxpc3RJdGVtc1swXS50eXBlID09ICJPTCIgPyAib2wiIDogInVsIjsKICAgICAgcmV0dXJuIGA8JHt0eXBlfT4ke3N1Ykxpc3R9PC8ke3R5cGV9PmA7CiAgICB9CiAgICBmdW5jdGlvbiBkb1BhcmFncmFwaCh0b2tlbikgewogICAgICBjb25zdCBjb250ZW50ID0gdG9rZW5UcmVlKHRva2VuLnN1YlRva2VuKTsKICAgICAgcmV0dXJuIGA8cD4ke2NvbnRlbnR9PC9wPmA7CiAgICB9CiAgICBmdW5jdGlvbiBkb0xpc3RFbGVtZW50KHRva2VuKSB7CiAgICAgIGNvbnN0IGNvbnRlbnQgPSB0b2tlblRyZWUodG9rZW4uc3ViVG9rZW4pOwogICAgICByZXR1cm4gYDxsaT4ke2NvbnRlbnR9PC9saT5gOwogICAgfQogICAgZnVuY3Rpb24gZG9MaW5rKHRva2VuKSB7CiAgICAgIGNvbnN0IGNvbnRlbnQgPSB0b2tlblRyZWUodG9rZW4uc3ViVG9rZW4pOwogICAgICByZXR1cm4gYDxhIGhyZWY9IiR7dG9rZW4udXJsfSI+JHtjb250ZW50fTwvYT5gOwogICAgfQogICAgZnVuY3Rpb24gaW5zZXJ0Qm9sZEl0YWxpYyh0ZXh0KSB7CiAgICAgIGNvbnN0IGJvbGRQYXJzZXIgPSAoMCwgaW1wb3J0X2FyY3NlY29uZDMuc2VxdWVuY2VPZikoWwogICAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMy5tYW55KSgoMCwgaW1wb3J0X2FyY3NlY29uZDMuYW55Q2hhckV4Y2VwdCkoKDAsIGltcG9ydF9hcmNzZWNvbmQzLmNoYXIpKCIqIikpKSwKICAgICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDMuc3RyKSgiKioiKSwKICAgICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDMubWFueSkoKDAsIGltcG9ydF9hcmNzZWNvbmQzLmFueUNoYXJFeGNlcHQpKCgwLCBpbXBvcnRfYXJjc2Vjb25kMy5jaGFyKSgiKiIpKSksCiAgICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQzLnN0cikoIioqIiksCiAgICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQzLm1hbnkpKCgwLCBpbXBvcnRfYXJjc2Vjb25kMy5hbnlDaGFyRXhjZXB0KSgoMCwgaW1wb3J0X2FyY3NlY29uZDMuY2hhcikoIioiKSkpCiAgICAgIF0pOwogICAgICBjb25zdCBpdGFsaWNQYXJzZXIgPSAoMCwgaW1wb3J0X2FyY3NlY29uZDMuc2VxdWVuY2VPZikoWwogICAgICAgICgwLCBpbXBvcnRfYXJjc2Vjb25kMy5tYW55KSgoMCwgaW1wb3J0X2FyY3NlY29uZDMuYW55Q2hhckV4Y2VwdCkoKDAsIGltcG9ydF9hcmNzZWNvbmQzLmNoYXIpKCJfIikpKSwKICAgICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDMuY2hhcikoIl8iKSwKICAgICAgICAoMCwgaW1wb3J0X2FyY3NlY29uZDMubWFueSkoKDAsIGltcG9ydF9hcmNzZWNvbmQzLmFueUNoYXJFeGNlcHQpKCgwLCBpbXBvcnRfYXJjc2Vjb25kMy5jaGFyKSgiXyIpKSksCiAgICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQzLmNoYXIpKCJfIiksCiAgICAgICAgKDAsIGltcG9ydF9hcmNzZWNvbmQzLm1hbnkpKCgwLCBpbXBvcnRfYXJjc2Vjb25kMy5hbnlDaGFyRXhjZXB0KSgoMCwgaW1wb3J0X2FyY3NlY29uZDMuY2hhcikoIl8iKSkpCiAgICAgIF0pOwogICAgICBjb25zdCBicCA9IGJvbGRQYXJzZXIucnVuKHRleHQpOwogICAgICBjb25zdCBpcCA9IGl0YWxpY1BhcnNlci5ydW4odGV4dCk7CiAgICAgIGlmICghaXAuaXNFcnJvcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGlwLnJlc3VsdDsKICAgICAgICBjb25zdCBpbnNpZGUgPSBpbnNlcnRCb2xkSXRhbGljKHJlc3VsdFsyXS5qb2luKCIiKSk7CiAgICAgICAgY29uc3Qgc3RhdGVtZW50ID0gYCR7cmVzdWx0WzBdLmpvaW4oIiIpfTxpPiR7aW5zaWRlfTwvaT4ke3Jlc3VsdFs0XS5qb2luKCIiKX1gOwogICAgICAgIHJldHVybiBzdGF0ZW1lbnQ7CiAgICAgIH0gZWxzZSBpZiAoIWJwLmlzRXJyb3IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBicC5yZXN1bHQ7CiAgICAgICAgY29uc3QgaW5zaWRlID0gaW5zZXJ0Qm9sZEl0YWxpYyhyZXN1bHRbMl0uam9pbigiIikpOwogICAgICAgIGNvbnN0IHN0YXRlbWVudCA9IGAke3Jlc3VsdFswXS5qb2luKCIiKX08Yj4ke2luc2lkZX08L2I+JHtyZXN1bHRbNF0uam9pbigiIil9YDsKICAgICAgICByZXR1cm4gc3RhdGVtZW50OwogICAgICB9IGVsc2UKICAgICAgICByZXR1cm4gdGV4dDsKICAgIH0KICAgIGZ1bmN0aW9uIHJ1bk11bHRpRmlsZShwYXRoMiwgbmFtZSkgewogICAgICBjb25zdCBiYXNlID0gaW5wdXQocGF0aDIpOwogICAgICBjb25zdCBiYXNlTmFtZSA9IG5hbWUuc2xpY2UoMCwgLTMpOwogICAgICBjb25zdCBbZmlsZSwgbWV0YWRhdGFdID0gcHJvY2Vzc0ZpbGUoYmFzZSwgYmFzZU5hbWUpOwogICAgICByZXR1cm4gWwogICAgICAgIGZpbGUsCiAgICAgICAgewogICAgICAgICAgdGl0bGU6IG1ldGFkYXRhLnRpdGxlLAogICAgICAgICAgZGVzY3JpcHRpb246IG1ldGFkYXRhLmRlc2NyaXB0aW9uLAogICAgICAgICAgdW5peHQ6IG1ldGFkYXRhLmRhdGUudW5peCgpLAogICAgICAgICAgaW1hZ2U6IG1ldGFkYXRhLmltYWdlLAogICAgICAgICAgdXJsOiBgYmxvZy8ke2Jhc2VOYW1lfWAKICAgICAgICB9LAogICAgICAgIG1ldGFkYXRhCiAgICAgIF07CiAgICB9CiAgICBmdW5jdGlvbiBwcm9jZXNzRmlsZShmaWxlLCBiYXNlTmFtZSkgewogICAgICBjb25zdCBbY2xlYW5lZEZpbGUsIG1ldGFkYXRhXSA9IG1ldGFkYXRhUmVtb3Zlcl9kZWZhdWx0KGZpbGUsIGJhc2VOYW1lKTsKICAgICAgY29uc3QgYXN0ID0gZmlsZXBhcnNlcl9kZWZhdWx0KGNsZWFuZWRGaWxlKTsKICAgICAgY29uc3QgcmF3SHRtbCA9IGdlbmVyYXRvcl9kZWZhdWx0KGFzdCk7CiAgICAgIHJldHVybiBbcmF3SHRtbCwgbWV0YWRhdGFdOwogICAgfQogICAgZnVuY3Rpb24gdHNjX2J1aWxkX2RlZmF1bHQoKSB7CiAgICAgIGNvbnN0IHBhdGgyID0gcHJvY2Vzcy5hcmd2WzJdOwogICAgICBjb25zdCBuYW1lID0gcHJvY2Vzcy5hcmd2WzNdOwogICAgICBjb25zdCByID0gcnVuTXVsdGlGaWxlKHBhdGgyLCBuYW1lKTsKICAgICAgcHJvY2Vzcy5zZW5kKHIpOwogICAgfQogIH0KfSk7CgovLyB2ZXJhY2UuanNvbgp2YXIgcmVxdWlyZV92ZXJhY2UgPSBfX2NvbW1vbkpTKHsKICAidmVyYWNlLmpzb24iKGV4cG9ydHMyLCBtb2R1bGUyKSB7CiAgICBtb2R1bGUyLmV4cG9ydHMgPSB7CiAgICAgIGxhbmc6ICJ0cyIsCiAgICAgIG5hbWU6ICJibG9nLWJ1aWxkLXdvcmtlciIsCiAgICAgIHZlcnNpb246ICIwLjAuMiIsCiAgICAgIHRhcmdldHM6IFsKICAgICAgICAid2luNjQiLAogICAgICAgICJsaW51eDY0IgogICAgICBdLAogICAgICBkYXRhOiB7CiAgICAgICAgZm9vOiAiYmFyIgogICAgICB9LAogICAgICBvdXREaXI6ICJiaW4iLAogICAgICBlbnRyeXBvaW50OiAiIiwKICAgICAgdHM6IHsKICAgICAgICBidWlsZERpcjogInRzYy1idWlsZCIsCiAgICAgICAgY2xlYW5BZnRlckJ1aWxkOiB0cnVlLAogICAgICAgIHByb2R1Y2VUeXBlczogZmFsc2UsCiAgICAgICAgc2tpcFBrZzogdHJ1ZSwKICAgICAgICB0ZXN0OiAiIiwKICAgICAgICBhc3NldHM6ICJhc3NldHMiCiAgICAgIH0sCiAgICAgIGdvOiB7CiAgICAgICAgZ29tb2Q6ICIiCiAgICAgIH0KICAgIH07CiAgfQp9KTsKCi8vIGJ1aWxkL2luZGV4LmNqcwp2YXIgZXhlYyA9IHJlcXVpcmVfdmVyYWNlVGVtcCgpOwp2YXIgY29uZmlnID0gcmVxdWlyZV92ZXJhY2UoKTsKZXhlYy5kZWZhdWx0KGNvbmZpZyk7Cg==`